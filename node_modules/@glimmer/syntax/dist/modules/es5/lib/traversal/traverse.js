import visitorKeys from '../types/visitor-keys';
import { cannotRemoveNode, cannotReplaceNode, cannotReplaceOrRemoveInKeyHandlerYet } from './errors';
function visitNode(visitor, node) {
    var handler = visitor[node.type] || visitor.All || null;
    var result = void 0;
    if (handler && handler['enter']) {
        result = handler['enter'].call(null, node);
    }
    if (result !== undefined && result !== null) {
        if (JSON.stringify(node) === JSON.stringify(result)) {
            result = undefined;
        } else if (Array.isArray(result)) {
            return visitArray(visitor, result) || result;
        } else {
            return visitNode(visitor, result) || result;
        }
    }
    if (result === undefined) {
        var keys = visitorKeys[node.type];
        for (var i = 0; i < keys.length; i++) {
            visitKey(visitor, handler, node, keys[i]);
        }
        if (handler && handler['exit']) {
            result = handler['exit'].call(null, node);
        }
    }
    return result;
}
function visitKey(visitor, handler, node, key) {
    var value = node[key];
    if (!value) {
        return;
    }
    var keyHandler = handler && (handler.keys[key] || handler.keys.All);
    var result = void 0;
    if (keyHandler && keyHandler.enter) {
        result = keyHandler.enter.call(null, node, key);
        if (result !== undefined) {
            throw cannotReplaceOrRemoveInKeyHandlerYet(node, key);
        }
    }
    if (Array.isArray(value)) {
        visitArray(visitor, value);
    } else {
        var _result = visitNode(visitor, value);
        if (_result !== undefined) {
            assignKey(node, key, _result);
        }
    }
    if (keyHandler && keyHandler.exit) {
        result = keyHandler.exit.call(null, node, key);
        if (result !== undefined) {
            throw cannotReplaceOrRemoveInKeyHandlerYet(node, key);
        }
    }
}
function visitArray(visitor, array) {
    for (var i = 0; i < array.length; i++) {
        var result = visitNode(visitor, array[i]);
        if (result !== undefined) {
            i += spliceArray(array, i, result) - 1;
        }
    }
}
function assignKey(node, key, result) {
    if (result === null) {
        throw cannotRemoveNode(node[key], node, key);
    } else if (Array.isArray(result)) {
        if (result.length === 1) {
            node[key] = result[0];
        } else {
            if (result.length === 0) {
                throw cannotRemoveNode(node[key], node, key);
            } else {
                throw cannotReplaceNode(node[key], node, key);
            }
        }
    } else {
        node[key] = result;
    }
}
function spliceArray(array, index, result) {
    if (result === null) {
        array.splice(index, 1);
        return 0;
    } else if (Array.isArray(result)) {
        array.splice.apply(array, [index, 1].concat(result));
        return result.length;
    } else {
        array.splice(index, 1, result);
        return 1;
    }
}
export default function traverse(node, visitor) {
    visitNode(normalizeVisitor(visitor), node);
}
export function normalizeVisitor(visitor) {
    var normalizedVisitor = {};
    for (var type in visitor) {
        var handler = visitor[type] || visitor.All;
        var normalizedKeys = {};
        if (typeof handler === 'object') {
            var keys = handler.keys;
            if (keys) {
                for (var key in keys) {
                    var keyHandler = keys[key];
                    if (typeof keyHandler === 'object') {
                        normalizedKeys[key] = {
                            enter: typeof keyHandler.enter === 'function' ? keyHandler.enter : null,
                            exit: typeof keyHandler.exit === 'function' ? keyHandler.exit : null
                        };
                    } else if (typeof keyHandler === 'function') {
                        normalizedKeys[key] = {
                            enter: keyHandler,
                            exit: null
                        };
                    }
                }
            }
            normalizedVisitor[type] = {
                enter: typeof handler.enter === 'function' ? handler.enter : null,
                exit: typeof handler.exit === 'function' ? handler.exit : null,
                keys: normalizedKeys
            };
        } else if (typeof handler === 'function') {
            normalizedVisitor[type] = {
                enter: handler,
                exit: null,
                keys: normalizedKeys
            };
        }
    }
    return normalizedVisitor;
}
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoidHJhdmVyc2UuanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyIuLi8uLi8uLi8uLi8uLi9wYWNrYWdlcy9AZ2xpbW1lci9zeW50YXgvbGliL3RyYXZlcnNhbC90cmF2ZXJzZS50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiQUFBQSxPQUFPLEFBQVcsaUJBQU0sQUFBdUIsQUFBQztBQUNoRCxBQUFPLFNBQ0wsQUFBZ0Isa0JBQ2hCLEFBQWlCLG1CQUNqQixBQUFvQyxBQUNyQyw0Q0FBTSxBQUFVLEFBQUM7QUF3QmxCLG1CQUFtQixBQUFvQixTQUFFLEFBQWdCLE1BQ3ZEO1FBQUksQUFBTyxVQUFvQyxBQUFPLFFBQUMsQUFBSSxLQUFDLEFBQUksQUFBQyxTQUFJLEFBQU8sUUFBQyxBQUFHLE9BQUksQUFBSSxBQUFDLEFBQ3pGO1FBQUksQUFBTSxBQUFDLEFBRVgsQUFBRSxBQUFDO1FBQUMsQUFBTyxXQUFJLEFBQU8sUUFBQyxBQUFPLEFBQUMsQUFBQyxVQUFDLEFBQUMsQUFDaEMsQUFBTTtpQkFBRyxBQUFPLFFBQUMsQUFBTyxBQUFDLFNBQUMsQUFBSSxLQUFDLEFBQUksTUFBRSxBQUFJLEFBQUMsQUFBQyxBQUM3QyxBQUFDO0FBRUQsQUFBRSxBQUFDO1FBQUMsQUFBTSxXQUFLLEFBQVMsYUFBSSxBQUFNLFdBQUssQUFBSSxBQUFDLE1BQUMsQUFBQyxBQUM1QyxBQUFFLEFBQUM7WUFBQyxBQUFJLEtBQUMsQUFBUyxVQUFDLEFBQUksQUFBQyxVQUFLLEFBQUksS0FBQyxBQUFTLFVBQUMsQUFBTSxBQUFDLEFBQUMsU0FBQyxBQUFDLEFBQ3BELEFBQU07cUJBQUcsQUFBUyxBQUFDLEFBQ3JCLEFBQUMsQUFBQyxBQUFJO21CQUFLLEFBQUssTUFBQyxBQUFPLFFBQUMsQUFBTSxBQUFDLEFBQUMsU0FBQyxBQUFDLEFBQ2pDLEFBQU07bUJBQUMsQUFBVSxXQUFDLEFBQU8sU0FBRSxBQUFNLEFBQUMsV0FBSSxBQUFNLEFBQUMsQUFDL0MsQUFBQyxBQUFDLEFBQUk7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QU8sQUFBTyxRQUFDLEFBQUksU0FBcEIsQUFBeUIsQUFBVSxBQUFDLGFBQUcsQUFBTyxRQUFDLEFBQUksT0FBRyxBQUFJLEFBQ2hFLEFBQUk7c0JBSG9CLEFBR2xCLEFBQWMsQUFDckIsQUFBQyxBQUNKLEFBQUMsQUFBQyxBQUFJO0FBSkYsQUFBSztlQUlGLEFBQUUsQUFBQyxJQUFDLE9BQU8sQUFBTyxZQUFLLEFBQVUsQUFBQyxZQUFDLEFBQUMsQUFDekMsQUFBaUI7OEJBQUMsQUFBSSxBQUFDO3VCQUNkLEFBQU8sQUFDZCxBQUFJO3NCQUFFLEFBQUksQUFDVixBQUFJO3NCQUhvQixBQUdsQixBQUFjLEFBQ3JCLEFBQUMsQUFDSixBQUFDLEFBQ0g7QUFMTSxBQUFLO0FBS1Y7QUFFRCxBQUFNO1dBQUMsQUFBaUIsQUFBQyxBQUMzQixBQUFDIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHZpc2l0b3JLZXlzIGZyb20gJy4uL3R5cGVzL3Zpc2l0b3Ita2V5cyc7XG5pbXBvcnQge1xuICBjYW5ub3RSZW1vdmVOb2RlLFxuICBjYW5ub3RSZXBsYWNlTm9kZSxcbiAgY2Fubm90UmVwbGFjZU9yUmVtb3ZlSW5LZXlIYW5kbGVyWWV0XG59IGZyb20gJy4vZXJyb3JzJztcbmltcG9ydCAqIGFzIG5vZGVzIGZyb20gJy4uL3R5cGVzL25vZGVzJztcbmltcG9ydCB7IE9wdGlvbiB9IGZyb20gXCJAZ2xpbW1lci9pbnRlcmZhY2VzXCI7XG5cbmV4cG9ydCB0eXBlIE5vZGVIYW5kbGVyPFQgZXh0ZW5kcyBub2Rlcy5Ob2RlPiA9IE5vZGVIYW5kbGVyRnVuY3Rpb248VD4gfCBFbnRlckV4aXROb2RlSGFuZGxlcjxUPjtcblxuZXhwb3J0IHR5cGUgU3BlY2lmaWNOb2RlVmlzaXRvciA9IHtcbiAgW1AgaW4ga2V5b2Ygbm9kZXMuTm9kZXNdPzogTm9kZUhhbmRsZXI8bm9kZXMuTm9kZXNbUF0+O1xufTtcblxuZXhwb3J0IGludGVyZmFjZSBOb2RlVmlzaXRvciBleHRlbmRzIFNwZWNpZmljTm9kZVZpc2l0b3Ige1xuICBBbGw/OiBOb2RlSGFuZGxlcjxub2Rlcy5Ob2RlPjtcbn1cblxuZXhwb3J0IGludGVyZmFjZSBOb2RlSGFuZGxlckZ1bmN0aW9uPFQgZXh0ZW5kcyBub2Rlcy5Ob2RlPiB7XG4gICh0aGlzOiBudWxsLCBub2RlOiBUKTogYW55IHwgbnVsbCB8IHVuZGVmaW5lZDtcbn1cblxuZXhwb3J0IGludGVyZmFjZSBFbnRlckV4aXROb2RlSGFuZGxlcjxUIGV4dGVuZHMgbm9kZXMuTm9kZT4ge1xuICBlbnRlcj86IE5vZGVIYW5kbGVyRnVuY3Rpb248VD47XG4gIGV4aXQ/OiBOb2RlSGFuZGxlckZ1bmN0aW9uPFQ+O1xuICBrZXlzPzogYW55O1xufVxuXG5mdW5jdGlvbiB2aXNpdE5vZGUodmlzaXRvcjogTm9kZVZpc2l0b3IsIG5vZGU6IG5vZGVzLk5vZGUpOiBhbnkge1xuICBsZXQgaGFuZGxlcjogT3B0aW9uPE5vZGVIYW5kbGVyPG5vZGVzLk5vZGU+PiA9IHZpc2l0b3Jbbm9kZS50eXBlXSB8fCB2aXNpdG9yLkFsbCB8fCBudWxsO1xuICBsZXQgcmVzdWx0O1xuXG4gIGlmIChoYW5kbGVyICYmIGhhbmRsZXJbJ2VudGVyJ10pIHtcbiAgICByZXN1bHQgPSBoYW5kbGVyWydlbnRlciddLmNhbGwobnVsbCwgbm9kZSk7XG4gIH1cblxuICBpZiAocmVzdWx0ICE9PSB1bmRlZmluZWQgJiYgcmVzdWx0ICE9PSBudWxsKSB7XG4gICAgaWYgKEpTT04uc3RyaW5naWZ5KG5vZGUpID09PSBKU09OLnN0cmluZ2lmeShyZXN1bHQpKSB7XG4gICAgICByZXN1bHQgPSB1bmRlZmluZWQ7XG4gICAgfSBlbHNlIGlmIChBcnJheS5pc0FycmF5KHJlc3VsdCkpIHtcbiAgICAgIHJldHVybiB2aXNpdEFycmF5KHZpc2l0b3IsIHJlc3VsdCkgfHwgcmVzdWx0O1xuICAgIH0gZWxzZSB7XG4gICAgICByZXR1cm4gdmlzaXROb2RlKHZpc2l0b3IsIHJlc3VsdCkgfHwgcmVzdWx0O1xuICAgIH1cbiAgfVxuXG4gIGlmIChyZXN1bHQgPT09IHVuZGVmaW5lZCkge1xuICAgIGxldCBrZXlzID0gdmlzaXRvcktleXNbbm9kZS50eXBlXTtcblxuICAgIGZvciAobGV0IGkgPSAwOyBpIDwga2V5cy5sZW5ndGg7IGkrKykge1xuICAgICAgdmlzaXRLZXkodmlzaXRvciwgaGFuZGxlciBhcyBhbnksIG5vZGUgYXMgYW55LCBrZXlzW2ldKTtcbiAgICB9XG5cbiAgICBpZiAoaGFuZGxlciAmJiBoYW5kbGVyWydleGl0J10pIHtcbiAgICAgIHJlc3VsdCA9IGhhbmRsZXJbJ2V4aXQnXS5jYWxsKG51bGwsIG5vZGUpO1xuICAgIH1cbiAgfVxuXG4gIHJldHVybiByZXN1bHQ7XG59XG5cbmZ1bmN0aW9uIHZpc2l0S2V5KHZpc2l0b3I6IE5vZGVWaXNpdG9yLCBoYW5kbGVyOiBFbnRlckV4aXROb2RlSGFuZGxlcjxub2Rlcy5Ob2RlPiwgbm9kZTogbm9kZXMuTm9kZSAmIFRyYXZlcnNlZE5vZGUsIGtleTogc3RyaW5nKSB7XG4gIGxldCB2YWx1ZSA9IG5vZGVba2V5XTtcbiAgaWYgKCF2YWx1ZSkgeyByZXR1cm47IH1cblxuICBsZXQga2V5SGFuZGxlciA9IGhhbmRsZXIgJiYgKGhhbmRsZXIua2V5c1trZXldIHx8IGhhbmRsZXIua2V5cy5BbGwpO1xuICBsZXQgcmVzdWx0O1xuXG4gIGlmIChrZXlIYW5kbGVyICYmIGtleUhhbmRsZXIuZW50ZXIpIHtcbiAgICByZXN1bHQgPSBrZXlIYW5kbGVyLmVudGVyLmNhbGwobnVsbCwgbm9kZSwga2V5KTtcbiAgICBpZiAocmVzdWx0ICE9PSB1bmRlZmluZWQpIHtcbiAgICAgIHRocm93IGNhbm5vdFJlcGxhY2VPclJlbW92ZUluS2V5SGFuZGxlcllldChub2RlLCBrZXkpO1xuICAgIH1cbiAgfVxuXG4gIGlmIChBcnJheS5pc0FycmF5KHZhbHVlKSkge1xuICAgIHZpc2l0QXJyYXkodmlzaXRvciwgdmFsdWUpO1xuICB9IGVsc2Uge1xuICAgIGxldCByZXN1bHQgPSB2aXNpdE5vZGUodmlzaXRvciwgdmFsdWUpO1xuICAgIGlmIChyZXN1bHQgIT09IHVuZGVmaW5lZCkge1xuICAgICAgYXNzaWduS2V5KG5vZGUsIGtleSwgcmVzdWx0KTtcbiAgICB9XG4gIH1cblxuICBpZiAoa2V5SGFuZGxlciAmJiBrZXlIYW5kbGVyLmV4aXQpIHtcbiAgICByZXN1bHQgPSBrZXlIYW5kbGVyLmV4aXQuY2FsbChudWxsLCBub2RlLCBrZXkpO1xuICAgIGlmIChyZXN1bHQgIT09IHVuZGVmaW5lZCkge1xuICAgICAgdGhyb3cgY2Fubm90UmVwbGFjZU9yUmVtb3ZlSW5LZXlIYW5kbGVyWWV0KG5vZGUsIGtleSk7XG4gICAgfVxuICB9XG59XG5cbmZ1bmN0aW9uIHZpc2l0QXJyYXkodmlzaXRvcjogTm9kZVZpc2l0b3IsIGFycmF5OiBub2Rlcy5Ob2RlW10pIHtcbiAgZm9yIChsZXQgaSA9IDA7IGkgPCBhcnJheS5sZW5ndGg7IGkrKykge1xuICAgIGxldCByZXN1bHQgPSB2aXNpdE5vZGUodmlzaXRvciwgYXJyYXlbaV0pO1xuICAgIGlmIChyZXN1bHQgIT09IHVuZGVmaW5lZCkge1xuICAgICAgaSArPSBzcGxpY2VBcnJheShhcnJheSwgaSwgcmVzdWx0KSAtIDE7XG4gICAgfVxuICB9XG59XG5cbmV4cG9ydCBpbnRlcmZhY2UgVHJhdmVyc2VkTm9kZSB7XG4gIFtrZXk6IHN0cmluZ106IG5vZGVzLk5vZGU7XG59XG5cbmZ1bmN0aW9uIGFzc2lnbktleShub2RlOiBUcmF2ZXJzZWROb2RlICYgbm9kZXMuTm9kZSwga2V5OiBzdHJpbmcsIHJlc3VsdDogbm9kZXMuTm9kZSkge1xuICBpZiAocmVzdWx0ID09PSBudWxsKSB7XG4gICAgdGhyb3cgY2Fubm90UmVtb3ZlTm9kZShub2RlW2tleV0sIG5vZGUsIGtleSk7XG4gIH0gZWxzZSBpZiAoQXJyYXkuaXNBcnJheShyZXN1bHQpKSB7XG4gICAgaWYgKHJlc3VsdC5sZW5ndGggPT09IDEpIHtcbiAgICAgIG5vZGVba2V5XSA9IHJlc3VsdFswXTtcbiAgICB9IGVsc2Uge1xuICAgICAgaWYgKHJlc3VsdC5sZW5ndGggPT09IDApIHtcbiAgICAgICAgdGhyb3cgY2Fubm90UmVtb3ZlTm9kZShub2RlW2tleV0sIG5vZGUsIGtleSk7XG4gICAgICB9IGVsc2Uge1xuICAgICAgICB0aHJvdyBjYW5ub3RSZXBsYWNlTm9kZShub2RlW2tleV0sIG5vZGUsIGtleSk7XG4gICAgICB9XG4gICAgfVxuICB9IGVsc2Uge1xuICAgIG5vZGVba2V5XSA9IHJlc3VsdDtcbiAgfVxufVxuXG5mdW5jdGlvbiBzcGxpY2VBcnJheTxUPihhcnJheTogVFtdLCBpbmRleDogbnVtYmVyLCByZXN1bHQ6IFRbXSkge1xuICBpZiAocmVzdWx0ID09PSBudWxsKSB7XG4gICAgYXJyYXkuc3BsaWNlKGluZGV4LCAxKTtcbiAgICByZXR1cm4gMDtcbiAgfSBlbHNlIGlmIChBcnJheS5pc0FycmF5KHJlc3VsdCkpIHtcbiAgICBhcnJheS5zcGxpY2UoaW5kZXgsIDEsIC4uLnJlc3VsdCk7XG4gICAgcmV0dXJuIHJlc3VsdC5sZW5ndGg7XG4gIH0gZWxzZSB7XG4gICAgYXJyYXkuc3BsaWNlKGluZGV4LCAxLCByZXN1bHQpO1xuICAgIHJldHVybiAxO1xuICB9XG59XG5cbmV4cG9ydCBkZWZhdWx0IGZ1bmN0aW9uIHRyYXZlcnNlKG5vZGU6IG5vZGVzLk5vZGUsIHZpc2l0b3I6IE5vZGVWaXNpdG9yKSB7XG4gIHZpc2l0Tm9kZShub3JtYWxpemVWaXNpdG9yKHZpc2l0b3IpLCBub2RlKTtcbn1cblxuZXhwb3J0IGZ1bmN0aW9uIG5vcm1hbGl6ZVZpc2l0b3IodmlzaXRvcjogTm9kZVZpc2l0b3IpIHtcbiAgbGV0IG5vcm1hbGl6ZWRWaXNpdG9yID0ge307XG5cbiAgZm9yIChsZXQgdHlwZSBpbiB2aXNpdG9yKSB7XG4gICAgbGV0IGhhbmRsZXIgPSB2aXNpdG9yW3R5cGVdIHx8IHZpc2l0b3IuQWxsO1xuICAgIGxldCBub3JtYWxpemVkS2V5cyA9IHt9O1xuXG4gICAgaWYgKHR5cGVvZiBoYW5kbGVyID09PSAnb2JqZWN0Jykge1xuICAgICAgbGV0IGtleXMgPSBoYW5kbGVyLmtleXM7XG4gICAgICBpZiAoa2V5cykge1xuICAgICAgICBmb3IgKGxldCBrZXkgaW4ga2V5cykge1xuICAgICAgICAgIGxldCBrZXlIYW5kbGVyID0ga2V5c1trZXldO1xuICAgICAgICAgIGlmICh0eXBlb2Yga2V5SGFuZGxlciA9PT0gJ29iamVjdCcpIHtcbiAgICAgICAgICAgIG5vcm1hbGl6ZWRLZXlzW2tleV0gPSB7XG4gICAgICAgICAgICAgIGVudGVyOiAodHlwZW9mIGtleUhhbmRsZXIuZW50ZXIgPT09ICdmdW5jdGlvbicpID8ga2V5SGFuZGxlci5lbnRlciA6IG51bGwsXG4gICAgICAgICAgICAgIGV4aXQ6ICh0eXBlb2Yga2V5SGFuZGxlci5leGl0ID09PSAnZnVuY3Rpb24nKSA/IGtleUhhbmRsZXIuZXhpdCA6IG51bGxcbiAgICAgICAgICAgIH07XG4gICAgICAgICAgfSBlbHNlIGlmICh0eXBlb2Yga2V5SGFuZGxlciA9PT0gJ2Z1bmN0aW9uJykge1xuICAgICAgICAgICAgbm9ybWFsaXplZEtleXNba2V5XSA9IHtcbiAgICAgICAgICAgICAgZW50ZXI6IGtleUhhbmRsZXIsXG4gICAgICAgICAgICAgIGV4aXQ6IG51bGxcbiAgICAgICAgICAgIH07XG4gICAgICAgICAgfVxuICAgICAgICB9XG4gICAgICB9XG5cbiAgICAgIG5vcm1hbGl6ZWRWaXNpdG9yW3R5cGVdID0ge1xuICAgICAgICBlbnRlcjogKHR5cGVvZiBoYW5kbGVyLmVudGVyID09PSAnZnVuY3Rpb24nKSA/IGhhbmRsZXIuZW50ZXIgOiBudWxsLFxuICAgICAgICBleGl0OiAodHlwZW9mIGhhbmRsZXIuZXhpdCA9PT0gJ2Z1bmN0aW9uJykgPyBoYW5kbGVyLmV4aXQgOiBudWxsLFxuICAgICAgICBrZXlzOiBub3JtYWxpemVkS2V5c1xuICAgICAgfTtcbiAgICB9IGVsc2UgaWYgKHR5cGVvZiBoYW5kbGVyID09PSAnZnVuY3Rpb24nKSB7XG4gICAgICBub3JtYWxpemVkVmlzaXRvclt0eXBlXSA9IHtcbiAgICAgICAgZW50ZXI6IGhhbmRsZXIsXG4gICAgICAgIGV4aXQ6IG51bGwsXG4gICAgICAgIGtleXM6IG5vcm1hbGl6ZWRLZXlzXG4gICAgICB9O1xuICAgIH1cbiAgfVxuXG4gIHJldHVybiBub3JtYWxpemVkVmlzaXRvcjtcbn1cbiJdfQ==