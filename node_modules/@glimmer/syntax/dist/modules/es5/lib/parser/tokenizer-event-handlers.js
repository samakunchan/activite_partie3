function _defaults(obj, defaults) { var keys = Object.getOwnPropertyNames(defaults); for (var i = 0; i < keys.length; i++) { var key = keys[i]; var value = Object.getOwnPropertyDescriptor(defaults, key); if (value && value.configurable && obj[key] === undefined) { Object.defineProperty(obj, key, value); } } return obj; }

function _classCallCheck(instance, Constructor) { if (!(instance instanceof Constructor)) { throw new TypeError("Cannot call a class as a function"); } }

function _possibleConstructorReturn(self, call) { if (!self) { throw new ReferenceError("this hasn't been initialised - super() hasn't been called"); } return call && (typeof call === "object" || typeof call === "function") ? call : self; }

function _inherits(subClass, superClass) { if (typeof superClass !== "function" && superClass !== null) { throw new TypeError("Super expression must either be null or a function, not " + typeof superClass); } subClass.prototype = Object.create(superClass && superClass.prototype, { constructor: { value: subClass, enumerable: false, writable: true, configurable: true } }); if (superClass) Object.setPrototypeOf ? Object.setPrototypeOf(subClass, superClass) : _defaults(subClass, superClass); }

import b, { SYNTHETIC } from "../builders";
import { appendChild, parseElementBlockParams } from "../utils";
import { HandlebarsNodeVisitors } from './handlebars-node-visitors';
import SyntaxError from '../errors/syntax-error';
import builders from "../builders";
import traverse from "../traversal/traverse";
import print from "../generation/print";
import Walker from "../traversal/walker";
import * as handlebars from "handlebars";
import { assign } from '@glimmer/util';
var voidMap = Object.create(null);
var voidTagNames = "area base br col command embed hr img input keygen link meta param source track wbr";
voidTagNames.split(" ").forEach(function (tagName) {
    voidMap[tagName] = true;
});
export var TokenizerEventHandlers = function (_HandlebarsNodeVisito) {
    _inherits(TokenizerEventHandlers, _HandlebarsNodeVisito);

    function TokenizerEventHandlers() {
        _classCallCheck(this, TokenizerEventHandlers);

        var _this = _possibleConstructorReturn(this, _HandlebarsNodeVisito.apply(this, arguments));

        _this.tagOpenLine = 0;
        _this.tagOpenColumn = 0;
        return _this;
    }

    TokenizerEventHandlers.prototype.reset = function reset() {
        this.currentNode = null;
    };
    // Comment


    TokenizerEventHandlers.prototype.beginComment = function beginComment() {
        this.currentNode = b.comment("");
        this.currentNode.loc = {
            source: null,
            start: b.pos(this.tagOpenLine, this.tagOpenColumn),
            end: null
        };
    };

    TokenizerEventHandlers.prototype.appendToCommentData = function appendToCommentData(char) {
        this.currentComment.value += char;
    };

    TokenizerEventHandlers.prototype.finishComment = function finishComment() {
        this.currentComment.loc.end = b.pos(this.tokenizer.line, this.tokenizer.column);
        appendChild(this.currentElement(), this.currentComment);
    };
    // Data


    TokenizerEventHandlers.prototype.beginData = function beginData() {
        this.currentNode = b.text();
        this.currentNode.loc = {
            source: null,
            start: b.pos(this.tokenizer.line, this.tokenizer.column),
            end: null
        };
    };

    TokenizerEventHandlers.prototype.appendToData = function appendToData(char) {
        this.currentData.chars += char;
    };

    TokenizerEventHandlers.prototype.finishData = function finishData() {
        this.currentData.loc.end = b.pos(this.tokenizer.line, this.tokenizer.column);
        appendChild(this.currentElement(), this.currentData);
    };
    // Tags - basic


    TokenizerEventHandlers.prototype.tagOpen = function tagOpen() {
        this.tagOpenLine = this.tokenizer.line;
        this.tagOpenColumn = this.tokenizer.column;
    };

    TokenizerEventHandlers.prototype.beginStartTag = function beginStartTag() {
        this.currentNode = {
            type: 'StartTag',
            name: "",
            attributes: [],
            modifiers: [],
            comments: [],
            selfClosing: false,
            loc: SYNTHETIC
        };
    };

    TokenizerEventHandlers.prototype.beginEndTag = function beginEndTag() {
        this.currentNode = {
            type: 'EndTag',
            name: "",
            attributes: [],
            modifiers: [],
            comments: [],
            selfClosing: false,
            loc: SYNTHETIC
        };
    };

    TokenizerEventHandlers.prototype.finishTag = function finishTag() {
        var _tokenizer = this.tokenizer,
            line = _tokenizer.line,
            column = _tokenizer.column;

        var tag = this.currentTag;
        tag.loc = b.loc(this.tagOpenLine, this.tagOpenColumn, line, column);
        if (tag.type === 'StartTag') {
            this.finishStartTag();
            if (voidMap[tag.name] || tag.selfClosing) {
                this.finishEndTag(true);
            }
        } else if (tag.type === 'EndTag') {
            this.finishEndTag(false);
        }
    };

    TokenizerEventHandlers.prototype.finishStartTag = function finishStartTag() {
        var _currentStartTag = this.currentStartTag,
            name = _currentStartTag.name,
            attributes = _currentStartTag.attributes,
            modifiers = _currentStartTag.modifiers,
            comments = _currentStartTag.comments;

        var loc = b.loc(this.tagOpenLine, this.tagOpenColumn);
        var element = b.element(name, attributes, modifiers, [], comments, loc);
        this.elementStack.push(element);
    };

    TokenizerEventHandlers.prototype.finishEndTag = function finishEndTag(isVoid) {
        var tag = this.currentTag;
        var element = this.elementStack.pop();
        var parent = this.currentElement();
        validateEndTag(tag, element, isVoid);
        element.loc.end.line = this.tokenizer.line;
        element.loc.end.column = this.tokenizer.column;
        parseElementBlockParams(element);
        appendChild(parent, element);
    };

    TokenizerEventHandlers.prototype.markTagAsSelfClosing = function markTagAsSelfClosing() {
        this.currentTag.selfClosing = true;
    };
    // Tags - name


    TokenizerEventHandlers.prototype.appendToTagName = function appendToTagName(char) {
        this.currentTag.name += char;
    };
    // Tags - attributes


    TokenizerEventHandlers.prototype.beginAttribute = function beginAttribute() {
        var tag = this.currentTag;
        if (tag.type === 'EndTag') {
            throw new SyntaxError("Invalid end tag: closing tag must not have attributes, " + ("in `" + tag.name + "` (on line " + this.tokenizer.line + ")."), tag.loc);
        }
        this.currentAttribute = {
            name: "",
            parts: [],
            isQuoted: false,
            isDynamic: false,
            start: b.pos(this.tokenizer.line, this.tokenizer.column),
            valueStartLine: 0,
            valueStartColumn: 0
        };
    };

    TokenizerEventHandlers.prototype.appendToAttributeName = function appendToAttributeName(char) {
        this.currentAttr.name += char;
    };

    TokenizerEventHandlers.prototype.beginAttributeValue = function beginAttributeValue(isQuoted) {
        this.currentAttr.isQuoted = isQuoted;
        this.currentAttr.valueStartLine = this.tokenizer.line;
        this.currentAttr.valueStartColumn = this.tokenizer.column;
    };

    TokenizerEventHandlers.prototype.appendToAttributeValue = function appendToAttributeValue(char) {
        var parts = this.currentAttr.parts;
        var lastPart = parts[parts.length - 1];
        if (lastPart && lastPart.type === 'TextNode') {
            lastPart.chars += char;
            // update end location for each added char
            lastPart.loc.end.line = this.tokenizer.line;
            lastPart.loc.end.column = this.tokenizer.column;
        } else {
            // initially assume the text node is a single char
            var loc = b.loc(this.tokenizer.line, this.tokenizer.column, this.tokenizer.line, this.tokenizer.column);
            // correct for `\n` as first char
            if (char === '\n') {
                loc.start.line -= 1;
                loc.start.column = lastPart ? lastPart.loc.end.column : this.currentAttr.valueStartColumn;
            }
            var text = b.text(char, loc);
            parts.push(text);
        }
    };

    TokenizerEventHandlers.prototype.finishAttributeValue = function finishAttributeValue() {
        var _currentAttr = this.currentAttr,
            name = _currentAttr.name,
            parts = _currentAttr.parts,
            isQuoted = _currentAttr.isQuoted,
            isDynamic = _currentAttr.isDynamic,
            valueStartLine = _currentAttr.valueStartLine,
            valueStartColumn = _currentAttr.valueStartColumn;

        var value = assembleAttributeValue(parts, isQuoted, isDynamic, this.tokenizer.line);
        value.loc = b.loc(valueStartLine, valueStartColumn, this.tokenizer.line, this.tokenizer.column);
        var loc = b.loc(this.currentAttr.start.line, this.currentAttr.start.column, this.tokenizer.line, this.tokenizer.column);
        var attribute = b.attr(name, value, loc);
        this.currentStartTag.attributes.push(attribute);
    };

    TokenizerEventHandlers.prototype.reportSyntaxError = function reportSyntaxError(message) {
        throw new SyntaxError("Syntax error at line " + this.tokenizer.line + " col " + this.tokenizer.column + ": " + message, b.loc(this.tokenizer.line, this.tokenizer.column));
    };

    return TokenizerEventHandlers;
}(HandlebarsNodeVisitors);
;
function assembleAttributeValue(parts, isQuoted, isDynamic, line) {
    if (isDynamic) {
        if (isQuoted) {
            return assembleConcatenatedValue(parts);
        } else {
            if (parts.length === 1 || parts.length === 2 && parts[1].type === 'TextNode' && parts[1].chars === '/') {
                return parts[0];
            } else {
                throw new SyntaxError("An unquoted attribute value must be a string or a mustache, " + "preceeded by whitespace or a '=' character, and " + ("followed by whitespace, a '>' character, or '/>' (on line " + line + ")"), b.loc(line, 0));
            }
        }
    } else {
        return parts.length > 0 ? parts[0] : b.text("");
    }
}
function assembleConcatenatedValue(parts) {
    for (var i = 0; i < parts.length; i++) {
        var part = parts[i];
        if (part.type !== 'MustacheStatement' && part.type !== 'TextNode') {
            throw new SyntaxError("Unsupported node in quoted attribute value: " + part['type'], part.loc);
        }
    }
    return b.concat(parts);
}
function validateEndTag(tag, element, selfClosing) {
    var error = void 0;
    if (voidMap[tag.name] && !selfClosing) {
        // EngTag is also called by StartTag for void and self-closing tags (i.e.
        // <input> or <br />, so we need to check for that here. Otherwise, we would
        // throw an error for those cases.
        error = "Invalid end tag " + formatEndTagInfo(tag) + " (void elements cannot have end tags).";
    } else if (element.tag === undefined) {
        error = "Closing tag " + formatEndTagInfo(tag) + " without an open tag.";
    } else if (element.tag !== tag.name) {
        error = "Closing tag " + formatEndTagInfo(tag) + " did not match last open tag `" + element.tag + "` (on line " + element.loc.start.line + ").";
    }
    if (error) {
        throw new SyntaxError(error, element.loc);
    }
}
function formatEndTagInfo(tag) {
    return "`" + tag.name + "` (on line " + tag.loc.end.line + ")";
}
var syntax = {
    parse: preprocess,
    builders: builders,
    print: print,
    traverse: traverse,
    Walker: Walker
};
export function preprocess(html, options) {
    var ast = typeof html === 'object' ? html : handlebars.parse(html);
    var program = new TokenizerEventHandlers(html, options).acceptNode(ast);
    if (options && options.plugins && options.plugins.ast) {
        for (var i = 0, l = options.plugins.ast.length; i < l; i++) {
            var transform = options.plugins.ast[i];
            var env = assign({}, options, { syntax: syntax }, { plugins: undefined });
            var pluginResult = transform(env);
            traverse(program, pluginResult.visitor);
        }
    }
    return program;
}
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoidG9rZW5pemVyLWV2ZW50LWhhbmRsZXJzLmpzIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsiLi4vLi4vLi4vLi4vLi4vcGFja2FnZXMvQGdsaW1tZXIvc3ludGF4L2xpYi9wYXJzZXIvdG9rZW5pemVyLWV2ZW50LWhhbmRsZXJzLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7Ozs7Ozs7O0FBQUEsT0FBTyxBQUFDLEFBQUUsS0FBRSxBQUFTLEFBQUUsaUJBQU0sQUFBYSxBQUFDO0FBQzNDLEFBQU8sU0FBRSxBQUFXLGFBQUUsQUFBdUIsQUFBRSwrQkFBTSxBQUFVLEFBQUM7QUFDaEUsQUFBTyxTQUFFLEFBQXNCLEFBQUUsOEJBQU0sQUFBNEIsQUFBQztBQUVwRSxPQUFPLEFBQVcsaUJBQU0sQUFBd0IsQUFBQztBQUVqRCxPQUFPLEFBQVEsY0FBTSxBQUFhLEFBQUM7QUFDbkMsT0FBTyxBQUF5QixjQUFNLEFBQXVCLEFBQUM7QUFDOUQsT0FBTyxBQUFLLFdBQU0sQUFBcUIsQUFBQztBQUN4QyxPQUFPLEFBQU0sWUFBTSxBQUFxQixBQUFDO0FBQ3pDLE9BQU8sS0FBSyxBQUFVLGdCQUFNLEFBQVksQUFBQztBQUN6QyxBQUFPLFNBQUUsQUFBTSxBQUFFLGNBQU0sQUFBZSxBQUFDO0FBR3ZDLElBQU0sQUFBTyxVQUVULEFBQU0sT0FBQyxBQUFNLE9BQUMsQUFBSSxBQUFDLEFBQUM7QUFFeEIsSUFBSSxBQUFZLGVBQUcsQUFBcUYsQUFBQztBQUN6RyxBQUFZLGFBQUMsQUFBSyxNQUFDLEFBQUcsQUFBQyxLQUFDLEFBQU8sUUFBQyxBQUFPLG1CQUNyQyxBQUFPO1lBQUMsQUFBTyxBQUFDLFdBQUcsQUFBSSxBQUFDLEFBQzFCLEFBQUMsQUFBQyxBQUFDOztBQUVILEFBQU0sV0FBOEI7Ozs7Ozt1RkFDMUI7O2NBQVcsY0FBRyxBQUFDLEFBQUMsQUFDaEI7Y0FBYSxnQkFBRyxBQUFDLEFBQUMsQUFtTjVCLEFBQUM7O0FBak5DLEFBQUs7OzhEQUNILEFBQUk7YUFB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QUFDMUMsQUFBQyxBQUNIO0FBQUM7QUFFRCxBQUFNO1dBQUMsQUFBTyxBQUFDLEFBQ2pCLEFBQUMiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgYiwgeyBTWU5USEVUSUMgfSBmcm9tIFwiLi4vYnVpbGRlcnNcIjtcbmltcG9ydCB7IGFwcGVuZENoaWxkLCBwYXJzZUVsZW1lbnRCbG9ja1BhcmFtcyB9IGZyb20gXCIuLi91dGlsc1wiO1xuaW1wb3J0IHsgSGFuZGxlYmFyc05vZGVWaXNpdG9ycyB9IGZyb20gJy4vaGFuZGxlYmFycy1ub2RlLXZpc2l0b3JzJztcbmltcG9ydCAqIGFzIEFTVCBmcm9tIFwiLi4vdHlwZXMvbm9kZXNcIjtcbmltcG9ydCBTeW50YXhFcnJvciBmcm9tICcuLi9lcnJvcnMvc3ludGF4LWVycm9yJztcbmltcG9ydCB7IFRhZyB9IGZyb20gXCIuLi9wYXJzZXJcIjtcbmltcG9ydCBidWlsZGVycyBmcm9tIFwiLi4vYnVpbGRlcnNcIjtcbmltcG9ydCB0cmF2ZXJzZSwgeyBOb2RlVmlzaXRvciB9IGZyb20gXCIuLi90cmF2ZXJzYWwvdHJhdmVyc2VcIjtcbmltcG9ydCBwcmludCBmcm9tIFwiLi4vZ2VuZXJhdGlvbi9wcmludFwiO1xuaW1wb3J0IFdhbGtlciBmcm9tIFwiLi4vdHJhdmVyc2FsL3dhbGtlclwiO1xuaW1wb3J0ICogYXMgaGFuZGxlYmFycyBmcm9tIFwiaGFuZGxlYmFyc1wiO1xuaW1wb3J0IHsgYXNzaWduIH0gZnJvbSAnQGdsaW1tZXIvdXRpbCc7XG5pbXBvcnQgeyBSZWNhc3QgfSBmcm9tIFwiQGdsaW1tZXIvaW50ZXJmYWNlc1wiO1xuXG5jb25zdCB2b2lkTWFwOiB7XG4gIFt0YWdOYW1lOiBzdHJpbmddOiBib29sZWFuXG59ID0gT2JqZWN0LmNyZWF0ZShudWxsKTtcblxubGV0IHZvaWRUYWdOYW1lcyA9IFwiYXJlYSBiYXNlIGJyIGNvbCBjb21tYW5kIGVtYmVkIGhyIGltZyBpbnB1dCBrZXlnZW4gbGluayBtZXRhIHBhcmFtIHNvdXJjZSB0cmFjayB3YnJcIjtcbnZvaWRUYWdOYW1lcy5zcGxpdChcIiBcIikuZm9yRWFjaCh0YWdOYW1lID0+IHtcbiAgdm9pZE1hcFt0YWdOYW1lXSA9IHRydWU7XG59KTtcblxuZXhwb3J0IGNsYXNzIFRva2VuaXplckV2ZW50SGFuZGxlcnMgZXh0ZW5kcyBIYW5kbGViYXJzTm9kZVZpc2l0b3JzIHtcbiAgcHJpdmF0ZSB0YWdPcGVuTGluZSA9IDA7XG4gIHByaXZhdGUgdGFnT3BlbkNvbHVtbiA9IDA7XG5cbiAgcmVzZXQoKSB7XG4gICAgdGhpcy5jdXJyZW50Tm9kZSA9IG51bGw7XG4gIH1cblxuICAvLyBDb21tZW50XG5cbiAgYmVnaW5Db21tZW50KCkge1xuICAgIHRoaXMuY3VycmVudE5vZGUgPSBiLmNvbW1lbnQoXCJcIik7XG4gICAgdGhpcy5jdXJyZW50Tm9kZS5sb2MgPSB7XG4gICAgICBzb3VyY2U6IG51bGwsXG4gICAgICBzdGFydDogYi5wb3ModGhpcy50YWdPcGVuTGluZSwgdGhpcy50YWdPcGVuQ29sdW1uKSxcbiAgICAgIGVuZDogbnVsbCBhcyBSZWNhc3Q8bnVsbCwgQVNULlBvc2l0aW9uPlxuICAgIH07XG4gIH1cblxuICBhcHBlbmRUb0NvbW1lbnREYXRhKGNoYXI6IHN0cmluZykge1xuICAgIHRoaXMuY3VycmVudENvbW1lbnQudmFsdWUgKz0gY2hhcjtcbiAgfVxuXG4gIGZpbmlzaENvbW1lbnQoKSB7XG4gICAgdGhpcy5jdXJyZW50Q29tbWVudC5sb2MuZW5kID0gYi5wb3ModGhpcy50b2tlbml6ZXIubGluZSwgdGhpcy50b2tlbml6ZXIuY29sdW1uKTtcblxuICAgIGFwcGVuZENoaWxkKHRoaXMuY3VycmVudEVsZW1lbnQoKSwgdGhpcy5jdXJyZW50Q29tbWVudCk7XG4gIH1cblxuICAvLyBEYXRhXG5cbiAgYmVnaW5EYXRhKCkge1xuICAgIHRoaXMuY3VycmVudE5vZGUgPSBiLnRleHQoKTtcbiAgICB0aGlzLmN1cnJlbnROb2RlLmxvYyA9IHtcbiAgICAgIHNvdXJjZTogbnVsbCxcbiAgICAgIHN0YXJ0OiBiLnBvcyh0aGlzLnRva2VuaXplci5saW5lLCB0aGlzLnRva2VuaXplci5jb2x1bW4pLFxuICAgICAgZW5kOiBudWxsIGFzIFJlY2FzdDxudWxsLCBBU1QuUG9zaXRpb24+XG4gICAgfTtcbiAgfVxuXG4gIGFwcGVuZFRvRGF0YShjaGFyOiBzdHJpbmcpIHtcbiAgICB0aGlzLmN1cnJlbnREYXRhLmNoYXJzICs9IGNoYXI7XG4gIH1cblxuICBmaW5pc2hEYXRhKCkge1xuICAgIHRoaXMuY3VycmVudERhdGEubG9jLmVuZCA9IGIucG9zKHRoaXMudG9rZW5pemVyLmxpbmUsIHRoaXMudG9rZW5pemVyLmNvbHVtbik7XG5cbiAgICBhcHBlbmRDaGlsZCh0aGlzLmN1cnJlbnRFbGVtZW50KCksIHRoaXMuY3VycmVudERhdGEpO1xuICB9XG5cbiAgLy8gVGFncyAtIGJhc2ljXG5cbiAgdGFnT3BlbigpIHtcbiAgICB0aGlzLnRhZ09wZW5MaW5lID0gdGhpcy50b2tlbml6ZXIubGluZTtcbiAgICB0aGlzLnRhZ09wZW5Db2x1bW4gPSB0aGlzLnRva2VuaXplci5jb2x1bW47XG4gIH1cblxuICBiZWdpblN0YXJ0VGFnKCkge1xuICAgIHRoaXMuY3VycmVudE5vZGUgPSB7XG4gICAgICB0eXBlOiAnU3RhcnRUYWcnLFxuICAgICAgbmFtZTogXCJcIixcbiAgICAgIGF0dHJpYnV0ZXM6IFtdLFxuICAgICAgbW9kaWZpZXJzOiBbXSxcbiAgICAgIGNvbW1lbnRzOiBbXSxcbiAgICAgIHNlbGZDbG9zaW5nOiBmYWxzZSxcbiAgICAgIGxvYzogU1lOVEhFVElDXG4gICAgfTtcbiAgfVxuXG4gIGJlZ2luRW5kVGFnKCkge1xuICAgIHRoaXMuY3VycmVudE5vZGUgPSB7XG4gICAgICB0eXBlOiAnRW5kVGFnJyxcbiAgICAgIG5hbWU6IFwiXCIsXG4gICAgICBhdHRyaWJ1dGVzOiBbXSxcbiAgICAgIG1vZGlmaWVyczogW10sXG4gICAgICBjb21tZW50czogW10sXG4gICAgICBzZWxmQ2xvc2luZzogZmFsc2UsXG4gICAgICBsb2M6IFNZTlRIRVRJQ1xuICAgIH07XG4gIH1cblxuICBmaW5pc2hUYWcoKSB7XG4gICAgbGV0IHsgbGluZSwgY29sdW1uIH0gPSB0aGlzLnRva2VuaXplcjtcblxuICAgIGxldCB0YWcgPSB0aGlzLmN1cnJlbnRUYWc7XG4gICAgdGFnLmxvYyA9IGIubG9jKHRoaXMudGFnT3BlbkxpbmUsIHRoaXMudGFnT3BlbkNvbHVtbiwgbGluZSwgY29sdW1uKTtcblxuICAgIGlmICh0YWcudHlwZSA9PT0gJ1N0YXJ0VGFnJykge1xuICAgICAgdGhpcy5maW5pc2hTdGFydFRhZygpO1xuXG4gICAgICBpZiAodm9pZE1hcFt0YWcubmFtZV0gfHwgdGFnLnNlbGZDbG9zaW5nKSB7XG4gICAgICAgIHRoaXMuZmluaXNoRW5kVGFnKHRydWUpO1xuICAgICAgfVxuICAgIH0gZWxzZSBpZiAodGFnLnR5cGUgPT09ICdFbmRUYWcnKSB7XG4gICAgICB0aGlzLmZpbmlzaEVuZFRhZyhmYWxzZSk7XG4gICAgfVxuICB9XG5cbiAgZmluaXNoU3RhcnRUYWcoKSB7XG4gICAgbGV0IHsgbmFtZSwgYXR0cmlidXRlcywgbW9kaWZpZXJzLCBjb21tZW50cyB9ID0gdGhpcy5jdXJyZW50U3RhcnRUYWc7XG5cbiAgICBsZXQgbG9jID0gYi5sb2ModGhpcy50YWdPcGVuTGluZSwgdGhpcy50YWdPcGVuQ29sdW1uKTtcbiAgICBsZXQgZWxlbWVudCA9IGIuZWxlbWVudChuYW1lLCBhdHRyaWJ1dGVzLCBtb2RpZmllcnMsIFtdLCBjb21tZW50cywgbG9jKTtcbiAgICB0aGlzLmVsZW1lbnRTdGFjay5wdXNoKGVsZW1lbnQpO1xuICB9XG5cbiAgZmluaXNoRW5kVGFnKGlzVm9pZDogYm9vbGVhbikge1xuICAgIGxldCB0YWcgPSB0aGlzLmN1cnJlbnRUYWc7XG5cbiAgICBsZXQgZWxlbWVudCA9IHRoaXMuZWxlbWVudFN0YWNrLnBvcCgpIGFzIEFTVC5FbGVtZW50Tm9kZTtcbiAgICBsZXQgcGFyZW50ID0gdGhpcy5jdXJyZW50RWxlbWVudCgpO1xuXG4gICAgdmFsaWRhdGVFbmRUYWcodGFnLCBlbGVtZW50LCBpc1ZvaWQpO1xuXG4gICAgZWxlbWVudC5sb2MuZW5kLmxpbmUgPSB0aGlzLnRva2VuaXplci5saW5lO1xuICAgIGVsZW1lbnQubG9jLmVuZC5jb2x1bW4gPSB0aGlzLnRva2VuaXplci5jb2x1bW47XG5cbiAgICBwYXJzZUVsZW1lbnRCbG9ja1BhcmFtcyhlbGVtZW50KTtcbiAgICBhcHBlbmRDaGlsZChwYXJlbnQsIGVsZW1lbnQpO1xuICB9XG5cbiAgbWFya1RhZ0FzU2VsZkNsb3NpbmcoKSB7XG4gICAgdGhpcy5jdXJyZW50VGFnLnNlbGZDbG9zaW5nID0gdHJ1ZTtcbiAgfVxuXG4gIC8vIFRhZ3MgLSBuYW1lXG5cbiAgYXBwZW5kVG9UYWdOYW1lKGNoYXI6IHN0cmluZykge1xuICAgIHRoaXMuY3VycmVudFRhZy5uYW1lICs9IGNoYXI7XG4gIH1cblxuICAvLyBUYWdzIC0gYXR0cmlidXRlc1xuXG4gIGJlZ2luQXR0cmlidXRlKCkge1xuICAgIGxldCB0YWcgPSB0aGlzLmN1cnJlbnRUYWc7XG4gICAgaWYgKHRhZy50eXBlID09PSAnRW5kVGFnJykge1xuICAgICAgIHRocm93IG5ldyBTeW50YXhFcnJvcihcbiAgICAgICAgYEludmFsaWQgZW5kIHRhZzogY2xvc2luZyB0YWcgbXVzdCBub3QgaGF2ZSBhdHRyaWJ1dGVzLCBgICtcbiAgICAgICAgYGluIFxcYCR7dGFnLm5hbWV9XFxgIChvbiBsaW5lICR7dGhpcy50b2tlbml6ZXIubGluZX0pLmAsXG4gICAgICAgIHRhZy5sb2NcbiAgICAgICk7XG4gICAgfVxuXG4gICAgdGhpcy5jdXJyZW50QXR0cmlidXRlID0ge1xuICAgICAgbmFtZTogXCJcIixcbiAgICAgIHBhcnRzOiBbXSxcbiAgICAgIGlzUXVvdGVkOiBmYWxzZSxcbiAgICAgIGlzRHluYW1pYzogZmFsc2UsXG4gICAgICBzdGFydDogYi5wb3ModGhpcy50b2tlbml6ZXIubGluZSwgdGhpcy50b2tlbml6ZXIuY29sdW1uKSxcbiAgICAgIHZhbHVlU3RhcnRMaW5lOiAwLFxuICAgICAgdmFsdWVTdGFydENvbHVtbjogMFxuICAgIH07XG4gIH1cblxuICBhcHBlbmRUb0F0dHJpYnV0ZU5hbWUoY2hhcjogc3RyaW5nKSB7XG4gICAgdGhpcy5jdXJyZW50QXR0ci5uYW1lICs9IGNoYXI7XG4gIH1cblxuICBiZWdpbkF0dHJpYnV0ZVZhbHVlKGlzUXVvdGVkOiBib29sZWFuKSB7XG4gICAgdGhpcy5jdXJyZW50QXR0ci5pc1F1b3RlZCA9IGlzUXVvdGVkO1xuICAgIHRoaXMuY3VycmVudEF0dHIudmFsdWVTdGFydExpbmUgPSB0aGlzLnRva2VuaXplci5saW5lO1xuICAgIHRoaXMuY3VycmVudEF0dHIudmFsdWVTdGFydENvbHVtbiA9IHRoaXMudG9rZW5pemVyLmNvbHVtbjtcbiAgfVxuXG4gIGFwcGVuZFRvQXR0cmlidXRlVmFsdWUoY2hhcjogc3RyaW5nKSB7XG4gICAgbGV0IHBhcnRzID0gdGhpcy5jdXJyZW50QXR0ci5wYXJ0cztcbiAgICBsZXQgbGFzdFBhcnQgPSBwYXJ0c1twYXJ0cy5sZW5ndGggLSAxXTtcblxuICAgIGlmIChsYXN0UGFydCAmJiBsYXN0UGFydC50eXBlID09PSAnVGV4dE5vZGUnKSB7XG4gICAgICBsYXN0UGFydC5jaGFycyArPSBjaGFyO1xuXG4gICAgICAvLyB1cGRhdGUgZW5kIGxvY2F0aW9uIGZvciBlYWNoIGFkZGVkIGNoYXJcbiAgICAgIGxhc3RQYXJ0LmxvYy5lbmQubGluZSA9IHRoaXMudG9rZW5pemVyLmxpbmU7XG4gICAgICBsYXN0UGFydC5sb2MuZW5kLmNvbHVtbiA9IHRoaXMudG9rZW5pemVyLmNvbHVtbjtcbiAgICB9IGVsc2Uge1xuICAgICAgLy8gaW5pdGlhbGx5IGFzc3VtZSB0aGUgdGV4dCBub2RlIGlzIGEgc2luZ2xlIGNoYXJcbiAgICAgIGxldCBsb2MgPSBiLmxvYyhcbiAgICAgICAgdGhpcy50b2tlbml6ZXIubGluZSwgdGhpcy50b2tlbml6ZXIuY29sdW1uLFxuICAgICAgICB0aGlzLnRva2VuaXplci5saW5lLCB0aGlzLnRva2VuaXplci5jb2x1bW5cbiAgICAgICk7XG5cbiAgICAgIC8vIGNvcnJlY3QgZm9yIGBcXG5gIGFzIGZpcnN0IGNoYXJcbiAgICAgIGlmIChjaGFyID09PSAnXFxuJykge1xuICAgICAgICBsb2Muc3RhcnQubGluZSAtPSAxO1xuICAgICAgICBsb2Muc3RhcnQuY29sdW1uID0gbGFzdFBhcnQgPyBsYXN0UGFydC5sb2MuZW5kLmNvbHVtbiA6IHRoaXMuY3VycmVudEF0dHIudmFsdWVTdGFydENvbHVtbjtcbiAgICAgIH1cblxuICAgICAgbGV0IHRleHQgPSBiLnRleHQoY2hhciwgbG9jKTtcbiAgICAgIHBhcnRzLnB1c2godGV4dCk7XG4gICAgfVxuICB9XG5cbiAgZmluaXNoQXR0cmlidXRlVmFsdWUoKSB7XG4gICAgbGV0IHsgbmFtZSwgcGFydHMsIGlzUXVvdGVkLCBpc0R5bmFtaWMsIHZhbHVlU3RhcnRMaW5lLCB2YWx1ZVN0YXJ0Q29sdW1uIH0gPSB0aGlzLmN1cnJlbnRBdHRyO1xuICAgIGxldCB2YWx1ZSA9IGFzc2VtYmxlQXR0cmlidXRlVmFsdWUocGFydHMsIGlzUXVvdGVkLCBpc0R5bmFtaWMsIHRoaXMudG9rZW5pemVyLmxpbmUpO1xuICAgIHZhbHVlLmxvYyA9IGIubG9jKFxuICAgICAgdmFsdWVTdGFydExpbmUsIHZhbHVlU3RhcnRDb2x1bW4sXG4gICAgICB0aGlzLnRva2VuaXplci5saW5lLCB0aGlzLnRva2VuaXplci5jb2x1bW5cbiAgICApO1xuXG4gICAgbGV0IGxvYyA9IGIubG9jKFxuICAgICAgdGhpcy5jdXJyZW50QXR0ci5zdGFydC5saW5lLCB0aGlzLmN1cnJlbnRBdHRyLnN0YXJ0LmNvbHVtbixcbiAgICAgIHRoaXMudG9rZW5pemVyLmxpbmUsIHRoaXMudG9rZW5pemVyLmNvbHVtblxuICAgICk7XG5cbiAgICBsZXQgYXR0cmlidXRlID0gYi5hdHRyKG5hbWUsIHZhbHVlLCBsb2MpO1xuXG4gICAgdGhpcy5jdXJyZW50U3RhcnRUYWcuYXR0cmlidXRlcy5wdXNoKGF0dHJpYnV0ZSk7XG4gIH1cblxuICByZXBvcnRTeW50YXhFcnJvcihtZXNzYWdlOiBzdHJpbmcpIHtcbiAgICB0aHJvdyBuZXcgU3ludGF4RXJyb3IoYFN5bnRheCBlcnJvciBhdCBsaW5lICR7dGhpcy50b2tlbml6ZXIubGluZX0gY29sICR7dGhpcy50b2tlbml6ZXIuY29sdW1ufTogJHttZXNzYWdlfWAsIGIubG9jKHRoaXMudG9rZW5pemVyLmxpbmUsIHRoaXMudG9rZW5pemVyLmNvbHVtbikpO1xuICB9XG59O1xuXG5mdW5jdGlvbiBhc3NlbWJsZUF0dHJpYnV0ZVZhbHVlKHBhcnRzOiAoQVNULk11c3RhY2hlU3RhdGVtZW50IHwgQVNULlRleHROb2RlKVtdLCBpc1F1b3RlZDogYm9vbGVhbiwgaXNEeW5hbWljOiBib29sZWFuLCBsaW5lOiBudW1iZXIpIHtcbiAgaWYgKGlzRHluYW1pYykge1xuICAgIGlmIChpc1F1b3RlZCkge1xuICAgICAgcmV0dXJuIGFzc2VtYmxlQ29uY2F0ZW5hdGVkVmFsdWUocGFydHMpO1xuICAgIH0gZWxzZSB7XG4gICAgICBpZiAocGFydHMubGVuZ3RoID09PSAxIHx8IChwYXJ0cy5sZW5ndGggPT09IDIgJiYgcGFydHNbMV0udHlwZSA9PT0gJ1RleHROb2RlJyAmJiAocGFydHNbMV0gYXMgQVNULlRleHROb2RlKS5jaGFycyA9PT0gJy8nKSkge1xuICAgICAgICByZXR1cm4gcGFydHNbMF07XG4gICAgICB9IGVsc2Uge1xuICAgICAgICB0aHJvdyBuZXcgU3ludGF4RXJyb3IoXG4gICAgICAgICAgYEFuIHVucXVvdGVkIGF0dHJpYnV0ZSB2YWx1ZSBtdXN0IGJlIGEgc3RyaW5nIG9yIGEgbXVzdGFjaGUsIGAgK1xuICAgICAgICAgIGBwcmVjZWVkZWQgYnkgd2hpdGVzcGFjZSBvciBhICc9JyBjaGFyYWN0ZXIsIGFuZCBgICtcbiAgICAgICAgICBgZm9sbG93ZWQgYnkgd2hpdGVzcGFjZSwgYSAnPicgY2hhcmFjdGVyLCBvciAnLz4nIChvbiBsaW5lICR7bGluZX0pYCxcbiAgICAgICAgICBiLmxvYyhsaW5lLCAwKVxuICAgICAgICApO1xuICAgICAgfVxuICAgIH1cbiAgfSBlbHNlIHtcbiAgICByZXR1cm4gcGFydHMubGVuZ3RoID4gMCA/IHBhcnRzWzBdIDogYi50ZXh0KFwiXCIpO1xuICB9XG59XG5cbmZ1bmN0aW9uIGFzc2VtYmxlQ29uY2F0ZW5hdGVkVmFsdWUocGFydHM6IChBU1QuTXVzdGFjaGVTdGF0ZW1lbnQgfCBBU1QuVGV4dE5vZGUpW10pIHtcbiAgZm9yIChsZXQgaSA9IDA7IGkgPCBwYXJ0cy5sZW5ndGg7IGkrKykge1xuICAgIGxldCBwYXJ0OiBBU1QuQmFzZU5vZGUgPSBwYXJ0c1tpXTtcblxuICAgIGlmIChwYXJ0LnR5cGUgIT09ICdNdXN0YWNoZVN0YXRlbWVudCcgJiYgcGFydC50eXBlICE9PSAnVGV4dE5vZGUnKSB7XG4gICAgICB0aHJvdyBuZXcgU3ludGF4RXJyb3IoXCJVbnN1cHBvcnRlZCBub2RlIGluIHF1b3RlZCBhdHRyaWJ1dGUgdmFsdWU6IFwiICsgcGFydFsndHlwZSddLCBwYXJ0LmxvYyk7XG4gICAgfVxuICB9XG5cbiAgcmV0dXJuIGIuY29uY2F0KHBhcnRzKTtcbn1cblxuZnVuY3Rpb24gdmFsaWRhdGVFbmRUYWcodGFnOiBUYWc8J1N0YXJ0VGFnJyB8ICdFbmRUYWcnPiwgZWxlbWVudDogQVNULkVsZW1lbnROb2RlLCBzZWxmQ2xvc2luZzogYm9vbGVhbikge1xuICBsZXQgZXJyb3I7XG5cbiAgaWYgKHZvaWRNYXBbdGFnLm5hbWVdICYmICFzZWxmQ2xvc2luZykge1xuICAgIC8vIEVuZ1RhZyBpcyBhbHNvIGNhbGxlZCBieSBTdGFydFRhZyBmb3Igdm9pZCBhbmQgc2VsZi1jbG9zaW5nIHRhZ3MgKGkuZS5cbiAgICAvLyA8aW5wdXQ+IG9yIDxiciAvPiwgc28gd2UgbmVlZCB0byBjaGVjayBmb3IgdGhhdCBoZXJlLiBPdGhlcndpc2UsIHdlIHdvdWxkXG4gICAgLy8gdGhyb3cgYW4gZXJyb3IgZm9yIHRob3NlIGNhc2VzLlxuICAgIGVycm9yID0gXCJJbnZhbGlkIGVuZCB0YWcgXCIgKyBmb3JtYXRFbmRUYWdJbmZvKHRhZykgKyBcIiAodm9pZCBlbGVtZW50cyBjYW5ub3QgaGF2ZSBlbmQgdGFncykuXCI7XG4gIH0gZWxzZSBpZiAoZWxlbWVudC50YWcgPT09IHVuZGVmaW5lZCkge1xuICAgIGVycm9yID0gXCJDbG9zaW5nIHRhZyBcIiArIGZvcm1hdEVuZFRhZ0luZm8odGFnKSArIFwiIHdpdGhvdXQgYW4gb3BlbiB0YWcuXCI7XG4gIH0gZWxzZSBpZiAoZWxlbWVudC50YWcgIT09IHRhZy5uYW1lKSB7XG4gICAgZXJyb3IgPSBcIkNsb3NpbmcgdGFnIFwiICsgZm9ybWF0RW5kVGFnSW5mbyh0YWcpICsgXCIgZGlkIG5vdCBtYXRjaCBsYXN0IG9wZW4gdGFnIGBcIiArIGVsZW1lbnQudGFnICsgXCJgIChvbiBsaW5lIFwiICtcbiAgICAgICAgICAgIGVsZW1lbnQubG9jLnN0YXJ0LmxpbmUgKyBcIikuXCI7XG4gIH1cblxuICBpZiAoZXJyb3IpIHsgdGhyb3cgbmV3IFN5bnRheEVycm9yKGVycm9yLCBlbGVtZW50LmxvYyk7IH1cbn1cblxuZnVuY3Rpb24gZm9ybWF0RW5kVGFnSW5mbyh0YWc6IFRhZzwnU3RhcnRUYWcnIHwgJ0VuZFRhZyc+KSB7XG4gIHJldHVybiBcImBcIiArIHRhZy5uYW1lICsgXCJgIChvbiBsaW5lIFwiICsgdGFnLmxvYy5lbmQubGluZSArIFwiKVwiO1xufVxuXG4vKipcbiAgQVNUUGx1Z2lucyBjYW4gbWFrZSBjaGFuZ2VzIHRvIHRoZSBHbGltbWVyIHRlbXBsYXRlIEFTVCBiZWZvcmVcbiAgY29tcGlsYXRpb24gYmVnaW5zLlxuKi9cbmV4cG9ydCBpbnRlcmZhY2UgQVNUUGx1Z2luQnVpbGRlciB7XG4gIChlbnY6IEFTVFBsdWdpbkVudmlyb25tZW50KTogQVNUUGx1Z2luO1xufVxuXG5leHBvcnQgaW50ZXJmYWNlIEFTVFBsdWdpbiB7XG4gIG5hbWU6IHN0cmluZztcbiAgdmlzaXRvcjogTm9kZVZpc2l0b3I7XG59XG5cbmV4cG9ydCBpbnRlcmZhY2UgQVNUUGx1Z2luRW52aXJvbm1lbnQge1xuICBtZXRhPzogYW55O1xuICBzeW50YXg6IFN5bnRheDtcbn1cblxuZXhwb3J0IGludGVyZmFjZSBQcmVwcm9jZXNzT3B0aW9ucyB7XG4gIHBsdWdpbnM/OiB7XG4gICAgYXN0PzogQVNUUGx1Z2luQnVpbGRlcltdO1xuICB9O1xufVxuXG5leHBvcnQgaW50ZXJmYWNlIFN5bnRheCB7XG4gIHBhcnNlOiB0eXBlb2YgcHJlcHJvY2VzcztcbiAgYnVpbGRlcnM6IHR5cGVvZiBidWlsZGVycztcbiAgcHJpbnQ6IHR5cGVvZiBwcmludDtcbiAgdHJhdmVyc2U6IHR5cGVvZiB0cmF2ZXJzZTtcbiAgV2Fsa2VyOiB0eXBlb2YgV2Fsa2VyO1xufVxuXG5jb25zdCBzeW50YXg6IFN5bnRheCA9IHtcbiAgcGFyc2U6IHByZXByb2Nlc3MsXG4gIGJ1aWxkZXJzLFxuICBwcmludCxcbiAgdHJhdmVyc2UsXG4gIFdhbGtlclxufTtcblxuZXhwb3J0IGZ1bmN0aW9uIHByZXByb2Nlc3MoaHRtbDogc3RyaW5nLCBvcHRpb25zPzogUHJlcHJvY2Vzc09wdGlvbnMpOiBBU1QuUHJvZ3JhbSB7XG4gIGxldCBhc3QgPSAodHlwZW9mIGh0bWwgPT09ICdvYmplY3QnKSA/IGh0bWwgOiBoYW5kbGViYXJzLnBhcnNlKGh0bWwpO1xuICBsZXQgcHJvZ3JhbSA9IG5ldyBUb2tlbml6ZXJFdmVudEhhbmRsZXJzKGh0bWwsIG9wdGlvbnMpLmFjY2VwdE5vZGUoYXN0KTtcblxuICBpZiAob3B0aW9ucyAmJiBvcHRpb25zLnBsdWdpbnMgJiYgb3B0aW9ucy5wbHVnaW5zLmFzdCkge1xuICAgIGZvciAobGV0IGkgPSAwLCBsID0gb3B0aW9ucy5wbHVnaW5zLmFzdC5sZW5ndGg7IGkgPCBsOyBpKyspIHtcbiAgICAgIGxldCB0cmFuc2Zvcm0gPSBvcHRpb25zLnBsdWdpbnMuYXN0W2ldO1xuICAgICAgbGV0IGVudiA9IGFzc2lnbih7fSwgb3B0aW9ucywgeyBzeW50YXggfSwgeyBwbHVnaW5zOiB1bmRlZmluZWQgfSk7XG5cbiAgICAgIGxldCBwbHVnaW5SZXN1bHQgPSB0cmFuc2Zvcm0oZW52KTtcblxuICAgICAgdHJhdmVyc2UocHJvZ3JhbSwgcGx1Z2luUmVzdWx0LnZpc2l0b3IpO1xuICAgIH1cbiAgfVxuXG4gIHJldHVybiBwcm9ncmFtO1xufVxuIl19