import * as HBS from '../types/nodes';
function unreachable() {
    throw new Error('unreachable');
}
export default function build(ast) {
    if (!ast) {
        return '';
    }
    var output = [];
    switch (ast.type) {
        case 'Program':
            {
                var chainBlock = ast['chained'] && ast.body[0];
                if (chainBlock) {
                    chainBlock['chained'] = true;
                }
                var body = buildEach(ast.body).join('');
                output.push(body);
            }
            break;
        case 'ElementNode':
            output.push('<', ast.tag);
            if (ast.attributes.length) {
                output.push(' ', buildEach(ast.attributes).join(' '));
            }
            if (ast.modifiers.length) {
                output.push(' ', buildEach(ast.modifiers).join(' '));
            }
            if (ast.comments.length) {
                output.push(' ', buildEach(ast.comments).join(' '));
            }
            output.push('>');
            output.push.apply(output, buildEach(ast.children));
            output.push('</', ast.tag, '>');
            break;
        case 'AttrNode':
            output.push(ast.name, '=');
            var value = build(ast.value);
            if (ast.value.type === 'TextNode') {
                output.push('"', value, '"');
            } else {
                output.push(value);
            }
            break;
        case 'ConcatStatement':
            output.push('"');
            ast.parts.forEach(function (node) {
                if (node.type === 'StringLiteral') {
                    output.push(node.original);
                } else {
                    output.push(build(node));
                }
            });
            output.push('"');
            break;
        case 'TextNode':
            output.push(ast.chars);
            break;
        case 'MustacheStatement':
            {
                output.push(compactJoin(['{{', pathParams(ast), '}}']));
            }
            break;
        case 'MustacheCommentStatement':
            {
                output.push(compactJoin(['{{!--', ast.value, '--}}']));
            }
            break;
        case 'ElementModifierStatement':
            {
                output.push(compactJoin(['{{', pathParams(ast), '}}']));
            }
            break;
        case 'PathExpression':
            output.push(ast.original);
            break;
        case 'SubExpression':
            {
                output.push('(', pathParams(ast), ')');
            }
            break;
        case 'BooleanLiteral':
            output.push(ast.value ? 'true' : 'false');
            break;
        case 'BlockStatement':
            {
                var lines = [];
                if (ast['chained']) {
                    lines.push(['{{else ', pathParams(ast), '}}'].join(''));
                } else {
                    lines.push(openBlock(ast));
                }
                lines.push(build(ast.program));
                if (ast.inverse) {
                    if (!ast.inverse['chained']) {
                        lines.push('{{else}}');
                    }
                    lines.push(build(ast.inverse));
                }
                if (!ast['chained']) {
                    lines.push(closeBlock(ast));
                }
                output.push(lines.join(''));
            }
            break;
        case 'PartialStatement':
            {
                output.push(compactJoin(['{{>', pathParams(ast), '}}']));
            }
            break;
        case 'CommentStatement':
            {
                output.push(compactJoin(['<!--', ast.value, '-->']));
            }
            break;
        case 'StringLiteral':
            {
                output.push('"' + ast.value + '"');
            }
            break;
        case 'NumberLiteral':
            {
                output.push(String(ast.value));
            }
            break;
        case 'UndefinedLiteral':
            {
                output.push('undefined');
            }
            break;
        case 'NullLiteral':
            {
                output.push('null');
            }
            break;
        case 'Hash':
            {
                output.push(ast.pairs.map(function (pair) {
                    return build(pair);
                }).join(' '));
            }
            break;
        case 'HashPair':
            {
                output.push(ast.key + '=' + build(ast.value));
            }
            break;
    }
    return output.join('');
}
function compact(array) {
    var newArray = [];
    array.forEach(function (a) {
        if (typeof a !== 'undefined' && a !== null && a !== '') {
            newArray.push(a);
        }
    });
    return newArray;
}
function buildEach(asts) {
    return asts.map(build);
}
function pathParams(ast) {
    var path = void 0;
    switch (ast.type) {
        case 'MustacheStatement':
        case 'SubExpression':
        case 'ElementModifierStatement':
        case 'BlockStatement':
            if (HBS.isLiteral(ast.path)) {
                return String(ast.path.value);
            }
            path = build(ast.path);
            break;
        case 'PartialStatement':
            path = build(ast.name);
            break;
        default:
            return unreachable();
    }
    return compactJoin([path, buildEach(ast.params).join(' '), build(ast.hash)], ' ');
}
function compactJoin(array, delimiter) {
    return compact(array).join(delimiter || '');
}
function blockParams(block) {
    var params = block.program.blockParams;
    if (params.length) {
        return ' as |' + params.join(' ') + '|';
    }
    return null;
}
function openBlock(block) {
    return ['{{#', pathParams(block), blockParams(block), '}}'].join('');
}
function closeBlock(block) {
    return ['{{/', build(block.path), '}}'].join('');
}
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoicHJpbnQuanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyIuLi8uLi8uLi8uLi8uLi9wYWNrYWdlcy9AZ2xpbW1lci9zeW50YXgvbGliL2dlbmVyYXRpb24vcHJpbnQudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6IkFBQ0EsT0FBTyxLQUFLLEFBQUcsU0FBTSxBQUFnQixBQUFDO0FBRXRDLHVCQUNFO1VBQU0sSUFBSSxBQUFLLE1BQUMsQUFBYSxBQUFDLEFBQUMsQUFDakMsQUFBQzs7QUFFRCxBQUFNLEFBQUMsQUFBTyw4QkFBZ0IsQUFBYSxLQUN6QyxBQUFFO1FBQUMsQ0FBQyxBQUFHLEFBQUMsS0FBQyxBQUFDLEFBQ1IsQUFBTTtlQUFDLEFBQUUsQUFBQyxBQUNaLEFBQUM7QUFDRDtRQUFNLEFBQU0sU0FBYSxBQUFFLEFBQUMsQUFFNUIsQUFBTTtZQUFDLEFBQUcsSUFBQyxBQUFJLEFBQUMsQUFBQyxBQUFDLEFBQ2hCO2FBQUssQUFBUyxBQUFFLEFBQUM7QUFDZjtvQkFBTSxBQUFVLGFBQUcsQUFBRyxJQUFDLEFBQVMsQUFBQyxjQUFJLEFBQUcsSUFBQyxBQUFJLEtBQUMsQUFBQyxBQUFDLEFBQUMsQUFDakQsQUFBRTtvQkFBQyxBQUFVLEFBQUMsWUFBQyxBQUFDLEFBQ2QsQUFBVTsrQkFBQyxBQUFTLEFBQUMsYUFBRyxBQUFJLEFBQUMsQUFDL0IsQUFBQztBQUNEO29CQUFNLEFBQUksT0FBRyxBQUFTLFVBQUMsQUFBRyxJQUFDLEFBQUksQUFBQyxNQUFDLEFBQUksS0FBQyxBQUFFLEFBQUMsQUFBQyxBQUMxQyxBQUFNO3VCQUFDLEFBQUksS0FBQyxBQUFJLEFBQUMsQUFBQyxBQUNwQixBQUFDO0FBQ0QsQUFBSyxBQUFDO0FBQ047YUFBSyxBQUFhLEFBQ2hCLEFBQU07bUJBQUMsQUFBSSxLQUFDLEFBQUcsS0FBRSxBQUFHLElBQUMsQUFBRyxBQUFDLEFBQUMsQUFDMUIsQUFBRTtnQkFBQyxBQUFHLElBQUMsQUFBVSxXQUFDLEFBQU0sQUFBQyxRQUFDLEFBQUMsQUFDekIsQUFBTTt1QkFBQyxBQUFJLEtBQUMsQUFBRyxLQUFFLEFBQVMsVUFBQyxBQUFHLElBQUMsQUFBVSxBQUFDLFlBQUMsQUFBSSxLQUFDLEFBQUcsQUFBQyxBQUFDLEFBQUMsQUFDeEQsQUFBQztBQUNELEFBQUU7Z0JBQUMsQUFBRyxJQUFDLEFBQVMsVUFBQyxBQUFNLEFBQUMsUUFBQyxBQUFDLEFBQ3hCLEFBQU07dUJBQUMsQUFBSSxLQUFDLEFBQUcsS0FBRSxBQUFTLFVBQUMsQUFBRyxJQUFDLEFBQVMsQUFBQyxXQUFDLEFBQUksS0FBQyxBQUFHLEFBQUMsQUFBQyxBQUFDLEFBQ3ZELEFBQUM7QUFDRCxBQUFFO2dCQUFDLEFBQUcsSUFBQyxBQUFRLFNBQUMsQUFBTSxBQUFDLFFBQUMsQUFBQyxBQUN2QixBQUFNO3VCQUFDLEFBQUksS0FBQyxBQUFHLEtBQUUsQUFBUyxVQUFDLEFBQUcsSUFBQyxBQUFRLEFBQUMsVUFBQyxBQUFJLEtBQUMsQUFBRyxBQUFDLEFBQUMsQUFBQyxBQUN0RCxBQUFDO0FBQ0QsQUFBTTttQkFBQyxBQUFJLEtBQUMsQUFBRyxBQUFDLEFBQUMsQUFDakIsQUFBTTttQkFBQyxBQUFJLEtBQUMsQUFBSyxNQUFDLEFBQU0sUUFBRSxBQUFTLFVBQUMsQUFBRyxJQUFDLEFBQVEsQUFBQyxBQUFDLEFBQUMsQUFDbkQsQUFBTTttQkFBQyxBQUFJLEtBQUMsQUFBSSxNQUFFLEFBQUcsSUFBQyxBQUFHLEtBQUUsQUFBRyxBQUFDLEFBQUMsQUFDbEMsQUFBSyxBQUFDO0FBQ047YUFBSyxBQUFVLEFBQ2IsQUFBTTttQkFBQyxBQUFJLEtBQUMsQUFBRyxJQUFDLEFBQUksTUFBRSxBQUFHLEFBQUMsQUFBQyxBQUMzQjtnQkFBTSxBQUFLLFFBQUcsQUFBSyxNQUFDLEFBQUcsSUFBQyxBQUFLLEFBQUMsQUFBQyxBQUMvQixBQUFFO2dCQUFDLEFBQUcsSUFBQyxBQUFLLE1BQUMsQUFBSSxTQUFLLEFBQVUsQUFBQyxZQUFDLEFBQUMsQUFDakMsQUFBTTt1QkFBQyxBQUFJLEtBQUMsQUFBRyxLQUFFLEFBQUssT0FBRSxBQUFHLEFBQUMsQUFBQyxBQUMvQixBQUFDLEFBQUMsQUFBSTttQkFBQyxBQUFDLEFBQ04sQUFBTTt1QkFBQyxBQUFJLEtBQUMsQUFBSyxBQUFDLEFBQUMsQUFDckIsQUFBQztBQUNILEFBQUssQUFBQztBQUNOO2FBQUssQUFBaUIsQUFDcEIsQUFBTTttQkFBQyxBQUFJLEtBQUMsQUFBRyxBQUFDLEFBQUMsQUFDakIsQUFBRztnQkFBQyxBQUFLLE1BQUMsQUFBTyxRQUFFLEFBQVMsQUFBVixnQkFDaEIsQUFBRTtvQkFBQyxBQUFJLEtBQUMsQUFBSSxTQUFLLEFBQWUsQUFBQyxpQkFBQyxBQUFDLEFBQ2pDLEFBQU07MkJBQUMsQUFBSSxLQUFDLEFBQUksS0FBQyxBQUFRLEFBQUMsQUFBQyxBQUM3QixBQUFDLEFBQUMsQUFBSTt1QkFBQyxBQUFDLEFBQ04sQUFBTTsyQkFBQyxBQUFJLEtBQUMsQUFBSyxNQUFDLEFBQUksQUFBQyxBQUFDLEFBQUMsQUFDM0IsQUFBQyxBQUNIO0FBQUMsQUFBQyxBQUFDO0FBQ0gsQUFBTTttQkFBQyxBQUFJLEtBQUMsQUFBRyxBQUFDLEFBQUMsQUFDbkIsQUFBSyxBQUFDO0FBQ047YUFBSyxBQUFVLEFBQ2IsQUFBTTttQkFBQyxBQUFJLEtBQUMsQUFBRyxJQUFDLEFBQUssQUFBQyxBQUFDLEFBQ3pCLEFBQUssQUFBQztBQUNOO2FBQUssQUFBbUIsQUFBRSxBQUFDO0FBQ3pCLEFBQU07dUJBQUMsQUFBSSxLQUFDLEFBQVcsWUFBQyxDQUFDLEFBQUksTUFBRSxBQUFVLFdBQUMsQUFBRyxBQUFDLE1BQUUsQUFBSSxBQUFDLEFBQUMsQUFBQyxBQUFDLEFBQzFELEFBQUM7QUFDRCxBQUFLLEFBQUM7QUFDTjthQUFLLEFBQTBCLEFBQUUsQUFBQztBQUNoQyxBQUFNO3VCQUFDLEFBQUksS0FBQyxBQUFXLFlBQUMsQ0FBQyxBQUFPLFNBQUUsQUFBRyxJQUFDLEFBQUssT0FBRSxBQUFNLEFBQUMsQUFBQyxBQUFDLEFBQUMsQUFDekQsQUFBQztBQUNELEFBQUssQUFBQztBQUNOO2FBQUssQUFBMEIsQUFBRSxBQUFDO0FBQ2hDLEFBQU07dUJBQUMsQUFBSSxLQUFDLEFBQVcsWUFBQyxDQUFDLEFBQUksTUFBRSxBQUFVLFdBQUMsQUFBRyxBQUFDLE1BQUUsQUFBSSxBQUFDLEFBQUMsQUFBQyxBQUFDLEFBQzFELEFBQUM7QUFDRCxBQUFLLEFBQUM7QUFDTjthQUFLLEFBQWdCLEFBQ25CLEFBQU07bUJBQUMsQUFBSSxLQUFDLEFBQUcsSUFBQyxBQUFRLEFBQUMsQUFBQyxBQUM1QixBQUFLLEFBQUM7QUFDTjthQUFLLEFBQWUsQUFBRSxBQUFDO0FBQ3JCLEFBQU07dUJBQUMsQUFBSSxLQUFDLEFBQUcsS0FBRSxBQUFVLFdBQUMsQUFBRyxBQUFDLE1BQUUsQUFBRyxBQUFDLEFBQUMsQUFDekMsQUFBQztBQUNELEFBQUssQUFBQztBQUNOO2FBQUssQUFBZ0IsQUFDbkIsQUFBTTttQkFBQyxBQUFJLEtBQUMsQUFBRyxJQUFDLEFBQUssUUFBRyxBQUFNLFNBQUcsQUFBTyxBQUFDLEFBQUMsQUFDNUMsQUFBSyxBQUFDO0FBQ047YUFBSyxBQUFnQixBQUFFLEFBQUM7QUFDdEI7b0JBQU0sQUFBSyxRQUFhLEFBQUUsQUFBQyxBQUUzQixBQUFFO29CQUFDLEFBQUcsSUFBQyxBQUFTLEFBQUMsQUFBQyxZQUFBLEFBQUMsQUFDakIsQUFBSzswQkFBQyxBQUFJLEtBQUMsQ0FBQyxBQUFTLFdBQUUsQUFBVSxXQUFDLEFBQUcsQUFBQyxNQUFFLEFBQUksQUFBQyxNQUFDLEFBQUksS0FBQyxBQUFFLEFBQUMsQUFBQyxBQUFDLEFBQzFELEFBQUMsQUFBSTt1QkFBQSxBQUFDLEFBQ0osQUFBSzswQkFBQyxBQUFJLEtBQUMsQUFBUyxVQUFDLEFBQUcsQUFBQyxBQUFDLEFBQUMsQUFDN0IsQUFBQztBQUVELEFBQUs7c0JBQUMsQUFBSSxLQUFDLEFBQUssTUFBQyxBQUFHLElBQUMsQUFBTyxBQUFDLEFBQUMsQUFBQyxBQUUvQixBQUFFO29CQUFDLEFBQUcsSUFBQyxBQUFPLEFBQUMsU0FBQyxBQUFDLEFBQ2YsQUFBRTt3QkFBQyxDQUFDLEFBQUcsSUFBQyxBQUFPLFFBQUMsQUFBUyxBQUFDLEFBQUMsWUFBQSxBQUFDLEFBQzFCLEFBQUs7OEJBQUMsQUFBSSxLQUFDLEFBQVUsQUFBQyxBQUFDLEFBQ3pCLEFBQUM7QUFDRCxBQUFLOzBCQUFDLEFBQUksS0FBQyxBQUFLLE1BQUMsQUFBRyxJQUFDLEFBQU8sQUFBQyxBQUFDLEFBQUMsQUFDakMsQUFBQztBQUVELEFBQUU7b0JBQUMsQ0FBQyxBQUFHLElBQUMsQUFBUyxBQUFDLEFBQUMsWUFBQSxBQUFDLEFBQ2xCLEFBQUs7MEJBQUMsQUFBSSxLQUFDLEFBQVUsV0FBQyxBQUFHLEFBQUMsQUFBQyxBQUFDLEFBQzlCLEFBQUM7QUFFRCxBQUFNO3VCQUFDLEFBQUksS0FBQyxBQUFLLE1BQUMsQUFBSSxLQUFDLEFBQUUsQUFBQyxBQUFDLEFBQUMsQUFDOUIsQUFBQztBQUNELEFBQUssQUFBQztBQUNOO2FBQUssQUFBa0IsQUFBRSxBQUFDO0FBQ3hCLEFBQU07dUJBQUMsQUFBSSxLQUFDLEFBQVcsWUFBQyxDQUFDLEFBQUssT0FBRSxBQUFVLFdBQUMsQUFBRyxBQUFDLE1BQUUsQUFBSSxBQUFDLEFBQUMsQUFBQyxBQUFDLEFBQzNELEFBQUM7QUFDRCxBQUFLLEFBQUM7QUFDTjthQUFLLEFBQWtCLEFBQUUsQUFBQztBQUN4QixBQUFNO3VCQUFDLEFBQUksS0FBQyxBQUFXLFlBQUMsQ0FBQyxBQUFNLFFBQUUsQUFBRyxJQUFDLEFBQUssT0FBRSxBQUFLLEFBQUMsQUFBQyxBQUFDLEFBQUMsQUFDdkQsQUFBQztBQUNELEFBQUssQUFBQztBQUNOO2FBQUssQUFBZSxBQUFFLEFBQUM7QUFDckIsQUFBTTt1QkFBQyxBQUFJLEFBQUMsV0FBSSxBQUFHLElBQUMsQUFBSyxBQUFHLEFBQUMsQUFBQyxBQUNoQyxBQUFDO0FBQ0QsQUFBSyxBQUFDO0FBQ047YUFBSyxBQUFlLEFBQUUsQUFBQztBQUNyQixBQUFNO3VCQUFDLEFBQUksS0FBQyxBQUFNLE9BQUMsQUFBRyxJQUFDLEFBQUssQUFBQyxBQUFDLEFBQUMsQUFDakMsQUFBQztBQUNELEFBQUssQUFBQztBQUNOO2FBQUssQUFBa0IsQUFBRSxBQUFDO0FBQ3hCLEFBQU07dUJBQUMsQUFBSSxLQUFDLEFBQVcsQUFBQyxBQUFDLEFBQzNCLEFBQUM7QUFDRCxBQUFLLEFBQUM7QUFDTjthQUFLLEFBQWEsQUFBRSxBQUFDO0FBQ25CLEFBQU07dUJBQUMsQUFBSSxLQUFDLEFBQU0sQUFBQyxBQUFDLEFBQ3RCLEFBQUM7QUFDRCxBQUFLLEFBQUM7QUFDTjthQUFLLEFBQU0sQUFBRSxBQUFDO0FBQ1osQUFBTTt1QkFBQyxBQUFJLFNBQUssQUFBSyxNQUFDLEFBQUcsSUFBQyxBQUFJLGdCQUM1QixBQUFNOzJCQUFDLEFBQUssTUFBQyxBQUFJLEFBQUMsQUFBQyxBQUNyQixBQUFDLEFBQUM7QUFGVSxBQUFHLG1CQUVaLEFBQUksS0FBQyxBQUFHLEFBQUMsQUFBQyxBQUFDLEFBQ2hCLEFBQUM7QUFDRCxBQUFLLEFBQUM7QUFDTjthQUFLLEFBQVUsQUFBRSxBQUFDO0FBQ2hCLEFBQU07dUJBQUMsQUFBSSxBQUFDLEtBQUcsQUFBRyxJQUFDLEFBQUcsWUFBSSxBQUFLLE1BQUMsQUFBRyxJQUFDLEFBQUssQUFBQyxBQUFFLEFBQUMsQUFBQyxBQUNoRCxBQUFDO0FBQ0QsQUFBSyxBQUFDLEFBQ1IsQUFBQztBQUNELEFBQU07O1dBQUMsQUFBTSxPQUFDLEFBQUksS0FBQyxBQUFFLEFBQUMsQUFBQyxBQUN6QixBQUFDOztBQUVELGlCQUFpQixBQUF1QixPQUN0QztRQUFNLEFBQVEsV0FBVSxBQUFFLEFBQUMsQUFDM0IsQUFBSztVQUFDLEFBQU8sUUFBQyxBQUFDLGFBQ2IsQUFBRTtZQUFDLEFBQU0sT0FBQyxBQUFDLEFBQUMsTUFBSyxBQUFXLGVBQUksQUFBQyxNQUFLLEFBQUksUUFBSSxBQUFDLE1BQUssQUFBRSxBQUFDLElBQUMsQUFBQyxBQUN2RCxBQUFRO3FCQUFDLEFBQUksS0FBQyxBQUFDLEFBQUMsQUFBQyxBQUNuQixBQUFDLEFBQ0g7QUFBQyxBQUFDLEFBQUM7QUFDSCxBQUFNO1dBQUMsQUFBUSxBQUFDLEFBQ2xCLEFBQUM7O0FBRUQsbUJBQW1CLEFBQWdCLE1BQ2pDLEFBQU07V0FBQyxBQUFJLEtBQUMsQUFBRyxJQUFDLEFBQUssQUFBQyxBQUFDLEFBQ3pCLEFBQUM7O0FBRUQsb0JBQW9CLEFBQWEsS0FDL0I7UUFBSSxBQUFZLEFBQUMsQUFFakIsQUFBTSxBQUFDO1lBQUMsQUFBRyxJQUFDLEFBQUksQUFBQyxBQUFDLEFBQUMsQUFDakI7YUFBSyxBQUFtQixBQUFDLEFBQ3pCO2FBQUssQUFBZSxBQUFDLEFBQ3JCO2FBQUssQUFBMEIsQUFBQyxBQUNoQzthQUFLLEFBQWdCLEFBQ25CLEFBQUUsQUFBQztnQkFBQyxBQUFHLElBQUMsQUFBUyxVQUFDLEFBQUcsSUFBQyxBQUFJLEFBQUMsQUFBQyxPQUFDLEFBQUMsQUFDNUIsQUFBTTt1QkFBQyxBQUFNLE9BQUMsQUFBRyxJQUFDLEFBQUksS0FBQyxBQUFLLEFBQUMsQUFBQyxBQUNoQyxBQUFDO0FBRUQsQUFBSTttQkFBRyxBQUFLLE1BQUMsQUFBRyxJQUFDLEFBQUksQUFBQyxBQUFDLEFBQ3ZCLEFBQUssQUFBQztBQUNSO2FBQUssQUFBa0IsQUFDckIsQUFBSTttQkFBRyxBQUFLLE1BQUMsQUFBRyxJQUFDLEFBQUksQUFBQyxBQUFDLEFBQ3ZCLEFBQUssQUFBQztBQUNSO0FBQ0UsQUFBTTttQkFBQyxBQUFXLEFBQUUsQUFBQyxBQUN6QixBQUFDLEFBRUQsQUFBTTs7V0FBQyxBQUFXLFlBQUMsQ0FBQyxBQUFJLE1BQUUsQUFBUyxVQUFDLEFBQUcsSUFBQyxBQUFNLEFBQUMsUUFBQyxBQUFJLEtBQUMsQUFBRyxBQUFDLE1BQUUsQUFBSyxNQUFDLEFBQUcsSUFBQyxBQUFJLEFBQUMsQUFBQyxRQUFFLEFBQUcsQUFBQyxBQUFDLEFBQ3BGLEFBQUM7O0FBRUQscUJBQXFCLEFBQXVCLE9BQUUsQUFBa0IsV0FDOUQsQUFBTTtXQUFDLEFBQU8sUUFBQyxBQUFLLEFBQUMsT0FBQyxBQUFJLEtBQUMsQUFBUyxhQUFJLEFBQUUsQUFBQyxBQUFDLEFBQzlDLEFBQUM7O0FBRUQscUJBQXFCLEFBQXlCLE9BQzVDO1FBQU0sQUFBTSxTQUFHLEFBQUssTUFBQyxBQUFPLFFBQUMsQUFBVyxBQUFDLEFBQ3pDLEFBQUU7UUFBQyxBQUFNLE9BQUMsQUFBTSxBQUFDLFFBQUMsQUFBQyxBQUNqQixBQUFNLEFBQUM7eUJBQVEsQUFBTSxPQUFDLEFBQUksS0FBQyxBQUFHLEFBQUMsQUFBRyxBQUFDLEFBQ3JDLEFBQUM7QUFFRCxBQUFNO1dBQUMsQUFBSSxBQUFDLEFBQ2QsQUFBQzs7QUFFRCxtQkFBbUIsQUFBeUIsT0FDMUMsQUFBTTtXQUFDLENBQUMsQUFBSyxPQUFFLEFBQVUsV0FBQyxBQUFLLEFBQUMsUUFBRSxBQUFXLFlBQUMsQUFBSyxBQUFDLFFBQUUsQUFBSSxBQUFDLE1BQUMsQUFBSSxLQUFDLEFBQUUsQUFBQyxBQUFDLEFBQ3ZFLEFBQUM7O0FBRUQsb0JBQW9CLEFBQVUsT0FDNUIsQUFBTTtXQUFDLENBQUMsQUFBSyxPQUFFLEFBQUssTUFBQyxBQUFLLE1BQUMsQUFBSSxBQUFDLE9BQUUsQUFBSSxBQUFDLE1BQUMsQUFBSSxLQUFDLEFBQUUsQUFBQyxBQUFDLEFBQ25ELEFBQUMiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgeyBPcHRpb24gfSBmcm9tICdAZ2xpbW1lci9pbnRlcmZhY2VzJztcbmltcG9ydCAqIGFzIEhCUyBmcm9tICcuLi90eXBlcy9ub2Rlcyc7XG5cbmZ1bmN0aW9uIHVucmVhY2hhYmxlKCk6IG5ldmVyIHtcbiAgdGhyb3cgbmV3IEVycm9yKCd1bnJlYWNoYWJsZScpO1xufVxuXG5leHBvcnQgZGVmYXVsdCBmdW5jdGlvbiBidWlsZChhc3Q6IEhCUy5Ob2RlKTogc3RyaW5nIHtcbiAgaWYoIWFzdCkge1xuICAgIHJldHVybiAnJztcbiAgfVxuICBjb25zdCBvdXRwdXQ6IHN0cmluZ1tdID0gW107XG5cbiAgc3dpdGNoKGFzdC50eXBlKSB7XG4gICAgY2FzZSAnUHJvZ3JhbSc6IHtcbiAgICAgIGNvbnN0IGNoYWluQmxvY2sgPSBhc3RbJ2NoYWluZWQnXSAmJiBhc3QuYm9keVswXTtcbiAgICAgIGlmKGNoYWluQmxvY2spIHtcbiAgICAgICAgY2hhaW5CbG9ja1snY2hhaW5lZCddID0gdHJ1ZTtcbiAgICAgIH1cbiAgICAgIGNvbnN0IGJvZHkgPSBidWlsZEVhY2goYXN0LmJvZHkpLmpvaW4oJycpO1xuICAgICAgb3V0cHV0LnB1c2goYm9keSk7XG4gICAgfVxuICAgIGJyZWFrO1xuICAgIGNhc2UgJ0VsZW1lbnROb2RlJzpcbiAgICAgIG91dHB1dC5wdXNoKCc8JywgYXN0LnRhZyk7XG4gICAgICBpZihhc3QuYXR0cmlidXRlcy5sZW5ndGgpIHtcbiAgICAgICAgb3V0cHV0LnB1c2goJyAnLCBidWlsZEVhY2goYXN0LmF0dHJpYnV0ZXMpLmpvaW4oJyAnKSk7XG4gICAgICB9XG4gICAgICBpZihhc3QubW9kaWZpZXJzLmxlbmd0aCkge1xuICAgICAgICBvdXRwdXQucHVzaCgnICcsIGJ1aWxkRWFjaChhc3QubW9kaWZpZXJzKS5qb2luKCcgJykpO1xuICAgICAgfVxuICAgICAgaWYoYXN0LmNvbW1lbnRzLmxlbmd0aCkge1xuICAgICAgICBvdXRwdXQucHVzaCgnICcsIGJ1aWxkRWFjaChhc3QuY29tbWVudHMpLmpvaW4oJyAnKSk7XG4gICAgICB9XG4gICAgICBvdXRwdXQucHVzaCgnPicpO1xuICAgICAgb3V0cHV0LnB1c2guYXBwbHkob3V0cHV0LCBidWlsZEVhY2goYXN0LmNoaWxkcmVuKSk7XG4gICAgICBvdXRwdXQucHVzaCgnPC8nLCBhc3QudGFnLCAnPicpO1xuICAgIGJyZWFrO1xuICAgIGNhc2UgJ0F0dHJOb2RlJzpcbiAgICAgIG91dHB1dC5wdXNoKGFzdC5uYW1lLCAnPScpO1xuICAgICAgY29uc3QgdmFsdWUgPSBidWlsZChhc3QudmFsdWUpO1xuICAgICAgaWYoYXN0LnZhbHVlLnR5cGUgPT09ICdUZXh0Tm9kZScpIHtcbiAgICAgICAgb3V0cHV0LnB1c2goJ1wiJywgdmFsdWUsICdcIicpO1xuICAgICAgfSBlbHNlIHtcbiAgICAgICAgb3V0cHV0LnB1c2godmFsdWUpO1xuICAgICAgfVxuICAgIGJyZWFrO1xuICAgIGNhc2UgJ0NvbmNhdFN0YXRlbWVudCc6XG4gICAgICBvdXRwdXQucHVzaCgnXCInKTtcbiAgICAgIGFzdC5wYXJ0cy5mb3JFYWNoKChub2RlOiBhbnkpID0+IHtcbiAgICAgICAgaWYobm9kZS50eXBlID09PSAnU3RyaW5nTGl0ZXJhbCcpIHtcbiAgICAgICAgICBvdXRwdXQucHVzaChub2RlLm9yaWdpbmFsKTtcbiAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICBvdXRwdXQucHVzaChidWlsZChub2RlKSk7XG4gICAgICAgIH1cbiAgICAgIH0pO1xuICAgICAgb3V0cHV0LnB1c2goJ1wiJyk7XG4gICAgYnJlYWs7XG4gICAgY2FzZSAnVGV4dE5vZGUnOlxuICAgICAgb3V0cHV0LnB1c2goYXN0LmNoYXJzKTtcbiAgICBicmVhaztcbiAgICBjYXNlICdNdXN0YWNoZVN0YXRlbWVudCc6IHtcbiAgICAgIG91dHB1dC5wdXNoKGNvbXBhY3RKb2luKFsne3snLCBwYXRoUGFyYW1zKGFzdCksICd9fSddKSk7XG4gICAgfVxuICAgIGJyZWFrO1xuICAgIGNhc2UgJ011c3RhY2hlQ29tbWVudFN0YXRlbWVudCc6IHtcbiAgICAgIG91dHB1dC5wdXNoKGNvbXBhY3RKb2luKFsne3shLS0nLCBhc3QudmFsdWUsICctLX19J10pKTtcbiAgICB9XG4gICAgYnJlYWs7XG4gICAgY2FzZSAnRWxlbWVudE1vZGlmaWVyU3RhdGVtZW50Jzoge1xuICAgICAgb3V0cHV0LnB1c2goY29tcGFjdEpvaW4oWyd7eycsIHBhdGhQYXJhbXMoYXN0KSwgJ319J10pKTtcbiAgICB9XG4gICAgYnJlYWs7XG4gICAgY2FzZSAnUGF0aEV4cHJlc3Npb24nOlxuICAgICAgb3V0cHV0LnB1c2goYXN0Lm9yaWdpbmFsKTtcbiAgICBicmVhaztcbiAgICBjYXNlICdTdWJFeHByZXNzaW9uJzoge1xuICAgICAgb3V0cHV0LnB1c2goJygnLCBwYXRoUGFyYW1zKGFzdCksICcpJyk7XG4gICAgfVxuICAgIGJyZWFrO1xuICAgIGNhc2UgJ0Jvb2xlYW5MaXRlcmFsJzpcbiAgICAgIG91dHB1dC5wdXNoKGFzdC52YWx1ZSA/ICd0cnVlJyA6ICdmYWxzZScpO1xuICAgIGJyZWFrO1xuICAgIGNhc2UgJ0Jsb2NrU3RhdGVtZW50Jzoge1xuICAgICAgY29uc3QgbGluZXM6IHN0cmluZ1tdID0gW107XG5cbiAgICAgIGlmKGFzdFsnY2hhaW5lZCddKXtcbiAgICAgICAgbGluZXMucHVzaChbJ3t7ZWxzZSAnLCBwYXRoUGFyYW1zKGFzdCksICd9fSddLmpvaW4oJycpKTtcbiAgICAgIH1lbHNle1xuICAgICAgICBsaW5lcy5wdXNoKG9wZW5CbG9jayhhc3QpKTtcbiAgICAgIH1cblxuICAgICAgbGluZXMucHVzaChidWlsZChhc3QucHJvZ3JhbSkpO1xuXG4gICAgICBpZihhc3QuaW52ZXJzZSkge1xuICAgICAgICBpZighYXN0LmludmVyc2VbJ2NoYWluZWQnXSl7XG4gICAgICAgICAgbGluZXMucHVzaCgne3tlbHNlfX0nKTtcbiAgICAgICAgfVxuICAgICAgICBsaW5lcy5wdXNoKGJ1aWxkKGFzdC5pbnZlcnNlKSk7XG4gICAgICB9XG5cbiAgICAgIGlmKCFhc3RbJ2NoYWluZWQnXSl7XG4gICAgICAgIGxpbmVzLnB1c2goY2xvc2VCbG9jayhhc3QpKTtcbiAgICAgIH1cblxuICAgICAgb3V0cHV0LnB1c2gobGluZXMuam9pbignJykpO1xuICAgIH1cbiAgICBicmVhaztcbiAgICBjYXNlICdQYXJ0aWFsU3RhdGVtZW50Jzoge1xuICAgICAgb3V0cHV0LnB1c2goY29tcGFjdEpvaW4oWyd7ez4nLCBwYXRoUGFyYW1zKGFzdCksICd9fSddKSk7XG4gICAgfVxuICAgIGJyZWFrO1xuICAgIGNhc2UgJ0NvbW1lbnRTdGF0ZW1lbnQnOiB7XG4gICAgICBvdXRwdXQucHVzaChjb21wYWN0Sm9pbihbJzwhLS0nLCBhc3QudmFsdWUsICctLT4nXSkpO1xuICAgIH1cbiAgICBicmVhaztcbiAgICBjYXNlICdTdHJpbmdMaXRlcmFsJzoge1xuICAgICAgb3V0cHV0LnB1c2goYFwiJHthc3QudmFsdWV9XCJgKTtcbiAgICB9XG4gICAgYnJlYWs7XG4gICAgY2FzZSAnTnVtYmVyTGl0ZXJhbCc6IHtcbiAgICAgIG91dHB1dC5wdXNoKFN0cmluZyhhc3QudmFsdWUpKTtcbiAgICB9XG4gICAgYnJlYWs7XG4gICAgY2FzZSAnVW5kZWZpbmVkTGl0ZXJhbCc6IHtcbiAgICAgIG91dHB1dC5wdXNoKCd1bmRlZmluZWQnKTtcbiAgICB9XG4gICAgYnJlYWs7XG4gICAgY2FzZSAnTnVsbExpdGVyYWwnOiB7XG4gICAgICBvdXRwdXQucHVzaCgnbnVsbCcpO1xuICAgIH1cbiAgICBicmVhaztcbiAgICBjYXNlICdIYXNoJzoge1xuICAgICAgb3V0cHV0LnB1c2goYXN0LnBhaXJzLm1hcChwYWlyID0+IHtcbiAgICAgICAgcmV0dXJuIGJ1aWxkKHBhaXIpO1xuICAgICAgfSkuam9pbignICcpKTtcbiAgICB9XG4gICAgYnJlYWs7XG4gICAgY2FzZSAnSGFzaFBhaXInOiB7XG4gICAgICBvdXRwdXQucHVzaChgJHthc3Qua2V5fT0ke2J1aWxkKGFzdC52YWx1ZSl9YCk7XG4gICAgfVxuICAgIGJyZWFrO1xuICB9XG4gIHJldHVybiBvdXRwdXQuam9pbignJyk7XG59XG5cbmZ1bmN0aW9uIGNvbXBhY3QoYXJyYXk6IE9wdGlvbjxzdHJpbmc+W10pOiBzdHJpbmdbXSB7XG4gIGNvbnN0IG5ld0FycmF5OiBhbnlbXSA9IFtdO1xuICBhcnJheS5mb3JFYWNoKGEgPT4ge1xuICAgIGlmKHR5cGVvZihhKSAhPT0gJ3VuZGVmaW5lZCcgJiYgYSAhPT0gbnVsbCAmJiBhICE9PSAnJykge1xuICAgICAgbmV3QXJyYXkucHVzaChhKTtcbiAgICB9XG4gIH0pO1xuICByZXR1cm4gbmV3QXJyYXk7XG59XG5cbmZ1bmN0aW9uIGJ1aWxkRWFjaChhc3RzOiBIQlMuTm9kZVtdKTogc3RyaW5nW10ge1xuICByZXR1cm4gYXN0cy5tYXAoYnVpbGQpO1xufVxuXG5mdW5jdGlvbiBwYXRoUGFyYW1zKGFzdDogSEJTLk5vZGUpOiBzdHJpbmcge1xuICBsZXQgcGF0aDogc3RyaW5nO1xuXG4gIHN3aXRjaCAoYXN0LnR5cGUpIHtcbiAgICBjYXNlICdNdXN0YWNoZVN0YXRlbWVudCc6XG4gICAgY2FzZSAnU3ViRXhwcmVzc2lvbic6XG4gICAgY2FzZSAnRWxlbWVudE1vZGlmaWVyU3RhdGVtZW50JzpcbiAgICBjYXNlICdCbG9ja1N0YXRlbWVudCc6XG4gICAgICBpZiAoSEJTLmlzTGl0ZXJhbChhc3QucGF0aCkpIHtcbiAgICAgICAgcmV0dXJuIFN0cmluZyhhc3QucGF0aC52YWx1ZSk7XG4gICAgICB9XG5cbiAgICAgIHBhdGggPSBidWlsZChhc3QucGF0aCk7XG4gICAgICBicmVhaztcbiAgICBjYXNlICdQYXJ0aWFsU3RhdGVtZW50JzpcbiAgICAgIHBhdGggPSBidWlsZChhc3QubmFtZSk7XG4gICAgICBicmVhaztcbiAgICBkZWZhdWx0OlxuICAgICAgcmV0dXJuIHVucmVhY2hhYmxlKCk7XG4gIH1cblxuICByZXR1cm4gY29tcGFjdEpvaW4oW3BhdGgsIGJ1aWxkRWFjaChhc3QucGFyYW1zKS5qb2luKCcgJyksIGJ1aWxkKGFzdC5oYXNoKV0sICcgJyk7XG59XG5cbmZ1bmN0aW9uIGNvbXBhY3RKb2luKGFycmF5OiBPcHRpb248c3RyaW5nPltdLCBkZWxpbWl0ZXI/OiBzdHJpbmcpOiBzdHJpbmcge1xuICByZXR1cm4gY29tcGFjdChhcnJheSkuam9pbihkZWxpbWl0ZXIgfHwgJycpO1xufVxuXG5mdW5jdGlvbiBibG9ja1BhcmFtcyhibG9jazogSEJTLkJsb2NrU3RhdGVtZW50KTogT3B0aW9uPHN0cmluZz4ge1xuICBjb25zdCBwYXJhbXMgPSBibG9jay5wcm9ncmFtLmJsb2NrUGFyYW1zO1xuICBpZihwYXJhbXMubGVuZ3RoKSB7XG4gICAgcmV0dXJuIGAgYXMgfCR7cGFyYW1zLmpvaW4oJyAnKX18YDtcbiAgfVxuXG4gIHJldHVybiBudWxsO1xufVxuXG5mdW5jdGlvbiBvcGVuQmxvY2soYmxvY2s6IEhCUy5CbG9ja1N0YXRlbWVudCk6IHN0cmluZyB7XG4gIHJldHVybiBbJ3t7IycsIHBhdGhQYXJhbXMoYmxvY2spLCBibG9ja1BhcmFtcyhibG9jayksICd9fSddLmpvaW4oJycpO1xufVxuXG5mdW5jdGlvbiBjbG9zZUJsb2NrKGJsb2NrOiBhbnkpOiBzdHJpbmcge1xuICByZXR1cm4gWyd7ey8nLCBidWlsZChibG9jay5wYXRoKSwgJ319J10uam9pbignJyk7XG59XG4iXX0=