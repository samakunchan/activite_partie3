import visitorKeys from '../types/visitor-keys';
import { cannotRemoveNode, cannotReplaceNode, cannotReplaceOrRemoveInKeyHandlerYet } from './errors';
function visitNode(visitor, node) {
    let handler = visitor[node.type] || visitor.All || null;
    let result;
    if (handler && handler['enter']) {
        result = handler['enter'].call(null, node);
    }
    if (result !== undefined && result !== null) {
        if (JSON.stringify(node) === JSON.stringify(result)) {
            result = undefined;
        } else if (Array.isArray(result)) {
            return visitArray(visitor, result) || result;
        } else {
            return visitNode(visitor, result) || result;
        }
    }
    if (result === undefined) {
        let keys = visitorKeys[node.type];
        for (let i = 0; i < keys.length; i++) {
            visitKey(visitor, handler, node, keys[i]);
        }
        if (handler && handler['exit']) {
            result = handler['exit'].call(null, node);
        }
    }
    return result;
}
function visitKey(visitor, handler, node, key) {
    let value = node[key];
    if (!value) {
        return;
    }
    let keyHandler = handler && (handler.keys[key] || handler.keys.All);
    let result;
    if (keyHandler && keyHandler.enter) {
        result = keyHandler.enter.call(null, node, key);
        if (result !== undefined) {
            throw cannotReplaceOrRemoveInKeyHandlerYet(node, key);
        }
    }
    if (Array.isArray(value)) {
        visitArray(visitor, value);
    } else {
        let result = visitNode(visitor, value);
        if (result !== undefined) {
            assignKey(node, key, result);
        }
    }
    if (keyHandler && keyHandler.exit) {
        result = keyHandler.exit.call(null, node, key);
        if (result !== undefined) {
            throw cannotReplaceOrRemoveInKeyHandlerYet(node, key);
        }
    }
}
function visitArray(visitor, array) {
    for (let i = 0; i < array.length; i++) {
        let result = visitNode(visitor, array[i]);
        if (result !== undefined) {
            i += spliceArray(array, i, result) - 1;
        }
    }
}
function assignKey(node, key, result) {
    if (result === null) {
        throw cannotRemoveNode(node[key], node, key);
    } else if (Array.isArray(result)) {
        if (result.length === 1) {
            node[key] = result[0];
        } else {
            if (result.length === 0) {
                throw cannotRemoveNode(node[key], node, key);
            } else {
                throw cannotReplaceNode(node[key], node, key);
            }
        }
    } else {
        node[key] = result;
    }
}
function spliceArray(array, index, result) {
    if (result === null) {
        array.splice(index, 1);
        return 0;
    } else if (Array.isArray(result)) {
        array.splice(index, 1, ...result);
        return result.length;
    } else {
        array.splice(index, 1, result);
        return 1;
    }
}
export default function traverse(node, visitor) {
    visitNode(normalizeVisitor(visitor), node);
}
export function normalizeVisitor(visitor) {
    let normalizedVisitor = {};
    for (let type in visitor) {
        let handler = visitor[type] || visitor.All;
        let normalizedKeys = {};
        if (typeof handler === 'object') {
            let keys = handler.keys;
            if (keys) {
                for (let key in keys) {
                    let keyHandler = keys[key];
                    if (typeof keyHandler === 'object') {
                        normalizedKeys[key] = {
                            enter: typeof keyHandler.enter === 'function' ? keyHandler.enter : null,
                            exit: typeof keyHandler.exit === 'function' ? keyHandler.exit : null
                        };
                    } else if (typeof keyHandler === 'function') {
                        normalizedKeys[key] = {
                            enter: keyHandler,
                            exit: null
                        };
                    }
                }
            }
            normalizedVisitor[type] = {
                enter: typeof handler.enter === 'function' ? handler.enter : null,
                exit: typeof handler.exit === 'function' ? handler.exit : null,
                keys: normalizedKeys
            };
        } else if (typeof handler === 'function') {
            normalizedVisitor[type] = {
                enter: handler,
                exit: null,
                keys: normalizedKeys
            };
        }
    }
    return normalizedVisitor;
}
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoidHJhdmVyc2UuanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyIuLi8uLi8uLi8uLi8uLi9wYWNrYWdlcy9AZ2xpbW1lci9zeW50YXgvbGliL3RyYXZlcnNhbC90cmF2ZXJzZS50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiQUFBQSxPQUFPLEFBQVcsaUJBQU0sQUFBdUIsQUFBQztBQUNoRCxBQUFPLFNBQ0wsQUFBZ0Isa0JBQ2hCLEFBQWlCLG1CQUNqQixBQUFvQyxBQUNyQyw0Q0FBTSxBQUFVLEFBQUM7QUF3QmxCLG1CQUFtQixBQUFvQixTQUFFLEFBQWdCO0FBQ3ZELFFBQUksQUFBTyxVQUFvQyxBQUFPLFFBQUMsQUFBSSxLQUFDLEFBQUksQUFBQyxTQUFJLEFBQU8sUUFBQyxBQUFHLE9BQUksQUFBSSxBQUFDO0FBQ3pGLFFBQUksQUFBTSxBQUFDO0FBRVgsQUFBRSxBQUFDLFFBQUMsQUFBTyxXQUFJLEFBQU8sUUFBQyxBQUFPLEFBQUMsQUFBQyxVQUFDLEFBQUM7QUFDaEMsQUFBTSxpQkFBRyxBQUFPLFFBQUMsQUFBTyxBQUFDLFNBQUMsQUFBSSxLQUFDLEFBQUksTUFBRSxBQUFJLEFBQUMsQUFBQyxBQUM3QztBQUFDO0FBRUQsQUFBRSxBQUFDLFFBQUMsQUFBTSxXQUFLLEFBQVMsYUFBSSxBQUFNLFdBQUssQUFBSSxBQUFDLE1BQUMsQUFBQztBQUM1QyxBQUFFLEFBQUMsWUFBQyxBQUFJLEtBQUMsQUFBUyxVQUFDLEFBQUksQUFBQyxVQUFLLEFBQUksS0FBQyxBQUFTLFVBQUMsQUFBTSxBQUFDLEFBQUMsU0FBQyxBQUFDO0FBQ3BELEFBQU0scUJBQUcsQUFBUyxBQUFDLEFBQ3JCO0FBQUMsQUFBQyxBQUFJLG1CQUFLLEFBQUssTUFBQyxBQUFPLFFBQUMsQUFBTSxBQUFDLEFBQUMsU0FBQyxBQUFDO0FBQ2pDLEFBQU0sbUJBQUMsQUFBVSxXQUFDLEFBQU8sU0FBRSxBQUFNLEFBQUMsV0FBSSxBQUFNLEFBQUMsQUFDL0M7QUFBQyxBQUFDLEFBQUks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QkFBRyxPQUFPLEFBQU8sUUFBQyxBQUFJLFNBQUssQUFBVSxBQUFDLFVBQXBDLEdBQXVDLEFBQU8sUUFBQyxBQUFJLE9BQUcsQUFBSTtBQUNoRSxBQUFJLHNCQUFFLEFBQWMsQUFDckIsQUFBQyxBQUNKO0FBTDRCO0FBSzNCLEFBQUMsQUFBSSxlQUFDLEFBQUUsQUFBQyxJQUFDLE9BQU8sQUFBTyxZQUFLLEFBQVUsQUFBQyxZQUFDLEFBQUM7QUFDekMsQUFBaUIsOEJBQUMsQUFBSSxBQUFDO0FBQ3JCLEFBQUssdUJBQUUsQUFBTztBQUNkLEFBQUksc0JBQUUsQUFBSTtBQUNWLEFBQUksc0JBQUUsQUFBYyxBQUNyQixBQUFDLEFBQ0o7QUFMNEI7QUFLM0IsQUFDSDtBQUFDO0FBRUQsQUFBTSxXQUFDLEFBQWlCLEFBQUMsQUFDM0I7QUFBQyIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB2aXNpdG9yS2V5cyBmcm9tICcuLi90eXBlcy92aXNpdG9yLWtleXMnO1xuaW1wb3J0IHtcbiAgY2Fubm90UmVtb3ZlTm9kZSxcbiAgY2Fubm90UmVwbGFjZU5vZGUsXG4gIGNhbm5vdFJlcGxhY2VPclJlbW92ZUluS2V5SGFuZGxlcllldFxufSBmcm9tICcuL2Vycm9ycyc7XG5pbXBvcnQgKiBhcyBub2RlcyBmcm9tICcuLi90eXBlcy9ub2Rlcyc7XG5pbXBvcnQgeyBPcHRpb24gfSBmcm9tIFwiQGdsaW1tZXIvaW50ZXJmYWNlc1wiO1xuXG5leHBvcnQgdHlwZSBOb2RlSGFuZGxlcjxUIGV4dGVuZHMgbm9kZXMuTm9kZT4gPSBOb2RlSGFuZGxlckZ1bmN0aW9uPFQ+IHwgRW50ZXJFeGl0Tm9kZUhhbmRsZXI8VD47XG5cbmV4cG9ydCB0eXBlIFNwZWNpZmljTm9kZVZpc2l0b3IgPSB7XG4gIFtQIGluIGtleW9mIG5vZGVzLk5vZGVzXT86IE5vZGVIYW5kbGVyPG5vZGVzLk5vZGVzW1BdPjtcbn07XG5cbmV4cG9ydCBpbnRlcmZhY2UgTm9kZVZpc2l0b3IgZXh0ZW5kcyBTcGVjaWZpY05vZGVWaXNpdG9yIHtcbiAgQWxsPzogTm9kZUhhbmRsZXI8bm9kZXMuTm9kZT47XG59XG5cbmV4cG9ydCBpbnRlcmZhY2UgTm9kZUhhbmRsZXJGdW5jdGlvbjxUIGV4dGVuZHMgbm9kZXMuTm9kZT4ge1xuICAodGhpczogbnVsbCwgbm9kZTogVCk6IGFueSB8IG51bGwgfCB1bmRlZmluZWQ7XG59XG5cbmV4cG9ydCBpbnRlcmZhY2UgRW50ZXJFeGl0Tm9kZUhhbmRsZXI8VCBleHRlbmRzIG5vZGVzLk5vZGU+IHtcbiAgZW50ZXI/OiBOb2RlSGFuZGxlckZ1bmN0aW9uPFQ+O1xuICBleGl0PzogTm9kZUhhbmRsZXJGdW5jdGlvbjxUPjtcbiAga2V5cz86IGFueTtcbn1cblxuZnVuY3Rpb24gdmlzaXROb2RlKHZpc2l0b3I6IE5vZGVWaXNpdG9yLCBub2RlOiBub2Rlcy5Ob2RlKTogYW55IHtcbiAgbGV0IGhhbmRsZXI6IE9wdGlvbjxOb2RlSGFuZGxlcjxub2Rlcy5Ob2RlPj4gPSB2aXNpdG9yW25vZGUudHlwZV0gfHwgdmlzaXRvci5BbGwgfHwgbnVsbDtcbiAgbGV0IHJlc3VsdDtcblxuICBpZiAoaGFuZGxlciAmJiBoYW5kbGVyWydlbnRlciddKSB7XG4gICAgcmVzdWx0ID0gaGFuZGxlclsnZW50ZXInXS5jYWxsKG51bGwsIG5vZGUpO1xuICB9XG5cbiAgaWYgKHJlc3VsdCAhPT0gdW5kZWZpbmVkICYmIHJlc3VsdCAhPT0gbnVsbCkge1xuICAgIGlmIChKU09OLnN0cmluZ2lmeShub2RlKSA9PT0gSlNPTi5zdHJpbmdpZnkocmVzdWx0KSkge1xuICAgICAgcmVzdWx0ID0gdW5kZWZpbmVkO1xuICAgIH0gZWxzZSBpZiAoQXJyYXkuaXNBcnJheShyZXN1bHQpKSB7XG4gICAgICByZXR1cm4gdmlzaXRBcnJheSh2aXNpdG9yLCByZXN1bHQpIHx8IHJlc3VsdDtcbiAgICB9IGVsc2Uge1xuICAgICAgcmV0dXJuIHZpc2l0Tm9kZSh2aXNpdG9yLCByZXN1bHQpIHx8IHJlc3VsdDtcbiAgICB9XG4gIH1cblxuICBpZiAocmVzdWx0ID09PSB1bmRlZmluZWQpIHtcbiAgICBsZXQga2V5cyA9IHZpc2l0b3JLZXlzW25vZGUudHlwZV07XG5cbiAgICBmb3IgKGxldCBpID0gMDsgaSA8IGtleXMubGVuZ3RoOyBpKyspIHtcbiAgICAgIHZpc2l0S2V5KHZpc2l0b3IsIGhhbmRsZXIgYXMgYW55LCBub2RlIGFzIGFueSwga2V5c1tpXSk7XG4gICAgfVxuXG4gICAgaWYgKGhhbmRsZXIgJiYgaGFuZGxlclsnZXhpdCddKSB7XG4gICAgICByZXN1bHQgPSBoYW5kbGVyWydleGl0J10uY2FsbChudWxsLCBub2RlKTtcbiAgICB9XG4gIH1cblxuICByZXR1cm4gcmVzdWx0O1xufVxuXG5mdW5jdGlvbiB2aXNpdEtleSh2aXNpdG9yOiBOb2RlVmlzaXRvciwgaGFuZGxlcjogRW50ZXJFeGl0Tm9kZUhhbmRsZXI8bm9kZXMuTm9kZT4sIG5vZGU6IG5vZGVzLk5vZGUgJiBUcmF2ZXJzZWROb2RlLCBrZXk6IHN0cmluZykge1xuICBsZXQgdmFsdWUgPSBub2RlW2tleV07XG4gIGlmICghdmFsdWUpIHsgcmV0dXJuOyB9XG5cbiAgbGV0IGtleUhhbmRsZXIgPSBoYW5kbGVyICYmIChoYW5kbGVyLmtleXNba2V5XSB8fCBoYW5kbGVyLmtleXMuQWxsKTtcbiAgbGV0IHJlc3VsdDtcblxuICBpZiAoa2V5SGFuZGxlciAmJiBrZXlIYW5kbGVyLmVudGVyKSB7XG4gICAgcmVzdWx0ID0ga2V5SGFuZGxlci5lbnRlci5jYWxsKG51bGwsIG5vZGUsIGtleSk7XG4gICAgaWYgKHJlc3VsdCAhPT0gdW5kZWZpbmVkKSB7XG4gICAgICB0aHJvdyBjYW5ub3RSZXBsYWNlT3JSZW1vdmVJbktleUhhbmRsZXJZZXQobm9kZSwga2V5KTtcbiAgICB9XG4gIH1cblxuICBpZiAoQXJyYXkuaXNBcnJheSh2YWx1ZSkpIHtcbiAgICB2aXNpdEFycmF5KHZpc2l0b3IsIHZhbHVlKTtcbiAgfSBlbHNlIHtcbiAgICBsZXQgcmVzdWx0ID0gdmlzaXROb2RlKHZpc2l0b3IsIHZhbHVlKTtcbiAgICBpZiAocmVzdWx0ICE9PSB1bmRlZmluZWQpIHtcbiAgICAgIGFzc2lnbktleShub2RlLCBrZXksIHJlc3VsdCk7XG4gICAgfVxuICB9XG5cbiAgaWYgKGtleUhhbmRsZXIgJiYga2V5SGFuZGxlci5leGl0KSB7XG4gICAgcmVzdWx0ID0ga2V5SGFuZGxlci5leGl0LmNhbGwobnVsbCwgbm9kZSwga2V5KTtcbiAgICBpZiAocmVzdWx0ICE9PSB1bmRlZmluZWQpIHtcbiAgICAgIHRocm93IGNhbm5vdFJlcGxhY2VPclJlbW92ZUluS2V5SGFuZGxlcllldChub2RlLCBrZXkpO1xuICAgIH1cbiAgfVxufVxuXG5mdW5jdGlvbiB2aXNpdEFycmF5KHZpc2l0b3I6IE5vZGVWaXNpdG9yLCBhcnJheTogbm9kZXMuTm9kZVtdKSB7XG4gIGZvciAobGV0IGkgPSAwOyBpIDwgYXJyYXkubGVuZ3RoOyBpKyspIHtcbiAgICBsZXQgcmVzdWx0ID0gdmlzaXROb2RlKHZpc2l0b3IsIGFycmF5W2ldKTtcbiAgICBpZiAocmVzdWx0ICE9PSB1bmRlZmluZWQpIHtcbiAgICAgIGkgKz0gc3BsaWNlQXJyYXkoYXJyYXksIGksIHJlc3VsdCkgLSAxO1xuICAgIH1cbiAgfVxufVxuXG5leHBvcnQgaW50ZXJmYWNlIFRyYXZlcnNlZE5vZGUge1xuICBba2V5OiBzdHJpbmddOiBub2Rlcy5Ob2RlO1xufVxuXG5mdW5jdGlvbiBhc3NpZ25LZXkobm9kZTogVHJhdmVyc2VkTm9kZSAmIG5vZGVzLk5vZGUsIGtleTogc3RyaW5nLCByZXN1bHQ6IG5vZGVzLk5vZGUpIHtcbiAgaWYgKHJlc3VsdCA9PT0gbnVsbCkge1xuICAgIHRocm93IGNhbm5vdFJlbW92ZU5vZGUobm9kZVtrZXldLCBub2RlLCBrZXkpO1xuICB9IGVsc2UgaWYgKEFycmF5LmlzQXJyYXkocmVzdWx0KSkge1xuICAgIGlmIChyZXN1bHQubGVuZ3RoID09PSAxKSB7XG4gICAgICBub2RlW2tleV0gPSByZXN1bHRbMF07XG4gICAgfSBlbHNlIHtcbiAgICAgIGlmIChyZXN1bHQubGVuZ3RoID09PSAwKSB7XG4gICAgICAgIHRocm93IGNhbm5vdFJlbW92ZU5vZGUobm9kZVtrZXldLCBub2RlLCBrZXkpO1xuICAgICAgfSBlbHNlIHtcbiAgICAgICAgdGhyb3cgY2Fubm90UmVwbGFjZU5vZGUobm9kZVtrZXldLCBub2RlLCBrZXkpO1xuICAgICAgfVxuICAgIH1cbiAgfSBlbHNlIHtcbiAgICBub2RlW2tleV0gPSByZXN1bHQ7XG4gIH1cbn1cblxuZnVuY3Rpb24gc3BsaWNlQXJyYXk8VD4oYXJyYXk6IFRbXSwgaW5kZXg6IG51bWJlciwgcmVzdWx0OiBUW10pIHtcbiAgaWYgKHJlc3VsdCA9PT0gbnVsbCkge1xuICAgIGFycmF5LnNwbGljZShpbmRleCwgMSk7XG4gICAgcmV0dXJuIDA7XG4gIH0gZWxzZSBpZiAoQXJyYXkuaXNBcnJheShyZXN1bHQpKSB7XG4gICAgYXJyYXkuc3BsaWNlKGluZGV4LCAxLCAuLi5yZXN1bHQpO1xuICAgIHJldHVybiByZXN1bHQubGVuZ3RoO1xuICB9IGVsc2Uge1xuICAgIGFycmF5LnNwbGljZShpbmRleCwgMSwgcmVzdWx0KTtcbiAgICByZXR1cm4gMTtcbiAgfVxufVxuXG5leHBvcnQgZGVmYXVsdCBmdW5jdGlvbiB0cmF2ZXJzZShub2RlOiBub2Rlcy5Ob2RlLCB2aXNpdG9yOiBOb2RlVmlzaXRvcikge1xuICB2aXNpdE5vZGUobm9ybWFsaXplVmlzaXRvcih2aXNpdG9yKSwgbm9kZSk7XG59XG5cbmV4cG9ydCBmdW5jdGlvbiBub3JtYWxpemVWaXNpdG9yKHZpc2l0b3I6IE5vZGVWaXNpdG9yKSB7XG4gIGxldCBub3JtYWxpemVkVmlzaXRvciA9IHt9O1xuXG4gIGZvciAobGV0IHR5cGUgaW4gdmlzaXRvcikge1xuICAgIGxldCBoYW5kbGVyID0gdmlzaXRvclt0eXBlXSB8fCB2aXNpdG9yLkFsbDtcbiAgICBsZXQgbm9ybWFsaXplZEtleXMgPSB7fTtcblxuICAgIGlmICh0eXBlb2YgaGFuZGxlciA9PT0gJ29iamVjdCcpIHtcbiAgICAgIGxldCBrZXlzID0gaGFuZGxlci5rZXlzO1xuICAgICAgaWYgKGtleXMpIHtcbiAgICAgICAgZm9yIChsZXQga2V5IGluIGtleXMpIHtcbiAgICAgICAgICBsZXQga2V5SGFuZGxlciA9IGtleXNba2V5XTtcbiAgICAgICAgICBpZiAodHlwZW9mIGtleUhhbmRsZXIgPT09ICdvYmplY3QnKSB7XG4gICAgICAgICAgICBub3JtYWxpemVkS2V5c1trZXldID0ge1xuICAgICAgICAgICAgICBlbnRlcjogKHR5cGVvZiBrZXlIYW5kbGVyLmVudGVyID09PSAnZnVuY3Rpb24nKSA/IGtleUhhbmRsZXIuZW50ZXIgOiBudWxsLFxuICAgICAgICAgICAgICBleGl0OiAodHlwZW9mIGtleUhhbmRsZXIuZXhpdCA9PT0gJ2Z1bmN0aW9uJykgPyBrZXlIYW5kbGVyLmV4aXQgOiBudWxsXG4gICAgICAgICAgICB9O1xuICAgICAgICAgIH0gZWxzZSBpZiAodHlwZW9mIGtleUhhbmRsZXIgPT09ICdmdW5jdGlvbicpIHtcbiAgICAgICAgICAgIG5vcm1hbGl6ZWRLZXlzW2tleV0gPSB7XG4gICAgICAgICAgICAgIGVudGVyOiBrZXlIYW5kbGVyLFxuICAgICAgICAgICAgICBleGl0OiBudWxsXG4gICAgICAgICAgICB9O1xuICAgICAgICAgIH1cbiAgICAgICAgfVxuICAgICAgfVxuXG4gICAgICBub3JtYWxpemVkVmlzaXRvclt0eXBlXSA9IHtcbiAgICAgICAgZW50ZXI6ICh0eXBlb2YgaGFuZGxlci5lbnRlciA9PT0gJ2Z1bmN0aW9uJykgPyBoYW5kbGVyLmVudGVyIDogbnVsbCxcbiAgICAgICAgZXhpdDogKHR5cGVvZiBoYW5kbGVyLmV4aXQgPT09ICdmdW5jdGlvbicpID8gaGFuZGxlci5leGl0IDogbnVsbCxcbiAgICAgICAga2V5czogbm9ybWFsaXplZEtleXNcbiAgICAgIH07XG4gICAgfSBlbHNlIGlmICh0eXBlb2YgaGFuZGxlciA9PT0gJ2Z1bmN0aW9uJykge1xuICAgICAgbm9ybWFsaXplZFZpc2l0b3JbdHlwZV0gPSB7XG4gICAgICAgIGVudGVyOiBoYW5kbGVyLFxuICAgICAgICBleGl0OiBudWxsLFxuICAgICAgICBrZXlzOiBub3JtYWxpemVkS2V5c1xuICAgICAgfTtcbiAgICB9XG4gIH1cblxuICByZXR1cm4gbm9ybWFsaXplZFZpc2l0b3I7XG59XG4iXX0=