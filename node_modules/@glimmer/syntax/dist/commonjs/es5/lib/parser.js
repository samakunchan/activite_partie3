"use strict";

Object.defineProperty(exports, "__esModule", {
    value: true
});
exports.Parser = undefined;

var _simpleHtmlTokenizer = require("simple-html-tokenizer");

var _util = require("@glimmer/util");

var _createClass = function () {
    function defineProperties(target, props) {
        for (var i = 0; i < props.length; i++) {
            var descriptor = props[i];descriptor.enumerable = descriptor.enumerable || false;descriptor.configurable = true;if ("value" in descriptor) descriptor.writable = true;Object.defineProperty(target, descriptor.key, descriptor);
        }
    }return function (Constructor, protoProps, staticProps) {
        if (protoProps) defineProperties(Constructor.prototype, protoProps);if (staticProps) defineProperties(Constructor, staticProps);return Constructor;
    };
}();

function _classCallCheck(instance, Constructor) {
    if (!(instance instanceof Constructor)) {
        throw new TypeError("Cannot call a class as a function");
    }
}

var entityParser = new _simpleHtmlTokenizer.EntityParser(_simpleHtmlTokenizer.HTML5NamedCharRefs);
var Parser = exports.Parser = function () {
    function Parser(source) {
        var options = arguments.length > 1 && arguments[1] !== undefined ? arguments[1] : {};

        _classCallCheck(this, Parser);

        this.elementStack = [];
        this.currentAttribute = null;
        this.currentNode = null;
        this.tokenizer = new _simpleHtmlTokenizer.EventedTokenizer(this, entityParser);
        this.options = options;
        this.tokenizer.states.tagOpen = function () {
            var char = this.consume();
            if (char === "!") {
                this['state'] = 'markupDeclaration';
            } else if (char === "/") {
                this['state'] = 'endTagOpen';
            } else if (/[A-Za-z]/.test(char)) {
                this['state'] = 'tagName';
                this['delegate'].beginStartTag();
                this['delegate'].appendToTagName(char);
            }
        };
        this.tokenizer.states.endTagOpen = function () {
            var char = this.consume();
            if (/[A-Za-z]/.test(char)) {
                this['state'] = 'tagName';
                this['delegate'].beginEndTag();
                this['delegate'].appendToTagName(char);
            }
        };
        this.source = source.split(/(?:\r\n?|\n)/g);
    }

    Parser.prototype.acceptNode = function acceptNode(node) {
        return this[node.type](node);
    };

    Parser.prototype.currentElement = function currentElement() {
        return this.elementStack[this.elementStack.length - 1];
    };

    Parser.prototype.sourceForNode = function sourceForNode(node, endNode) {
        var firstLine = node.loc.start.line - 1;
        var currentLine = firstLine - 1;
        var firstColumn = node.loc.start.column;
        var string = [];
        var line = void 0;
        var lastLine = void 0;
        var lastColumn = void 0;
        if (endNode) {
            lastLine = endNode.loc.end.line - 1;
            lastColumn = endNode.loc.end.column;
        } else {
            lastLine = node.loc.end.line - 1;
            lastColumn = node.loc.end.column;
        }
        while (currentLine < lastLine) {
            currentLine++;
            line = this.source[currentLine];
            if (currentLine === firstLine) {
                if (firstLine === lastLine) {
                    string.push(line.slice(firstColumn, lastColumn));
                } else {
                    string.push(line.slice(firstColumn));
                }
            } else if (currentLine === lastLine) {
                string.push(line.slice(0, lastColumn));
            } else {
                string.push(line);
            }
        }
        return string.join('\n');
    };

    _createClass(Parser, [{
        key: "currentAttr",
        get: function get() {
            return this.currentAttribute;
        }
    }, {
        key: "currentTag",
        get: function get() {
            var node = this.currentNode;
            false && (0, _util.assert)(node && (node.type === 'StartTag' || node.type === 'EndTag'), 'expected tag');

            return node;
        }
    }, {
        key: "currentStartTag",
        get: function get() {
            var node = this.currentNode;
            false && (0, _util.assert)(node && node.type === 'StartTag', 'expected start tag');

            return node;
        }
    }, {
        key: "currentEndTag",
        get: function get() {
            var node = this.currentNode;
            false && (0, _util.assert)(node && node.type === 'EndTag', 'expected end tag');

            return node;
        }
    }, {
        key: "currentComment",
        get: function get() {
            var node = this.currentNode;
            false && (0, _util.assert)(node && node.type === 'CommentStatement', 'expected a comment');

            return node;
        }
    }, {
        key: "currentData",
        get: function get() {
            var node = this.currentNode;
            false && (0, _util.assert)(node && node.type === 'TextNode', 'expected a text node');

            return node;
        }
    }]);

    return Parser;
}();
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoicGFyc2VyLmpzIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsiLi4vLi4vLi4vLi4vcGFja2FnZXMvQGdsaW1tZXIvc3ludGF4L2xpYi9wYXJzZXIudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6Ijs7Ozs7OztBQUFBLEFBQU8sQUFDTCxBQUFnQixBQUNoQixBQUFZLEFBQ1osQUFBa0IsQUFBSSxBQUFhLEFBQ3BDLEFBQU0sQUFBdUIsQUFBQzs7QUFLL0IsQUFBTyxBQUFFLEFBQU0sQUFBRSxBQUFNLEFBQUUsQUFBTSxBQUFlLEFBQUM7Ozs7Ozs7Ozs7Ozs7Ozs7OztBQUUvQyxJQUFNLEFBQVksZUFBRyxBQUFJLEFBQVksQUFBQyxBQUFhLEFBQUMsQUFBQyxBQXdCckQsQUFBTTtJQVFKO29CQUFZLEFBQWMsUUFQaEI7WUFPa0IsOEVBQWtCLEFBQUU7Ozs7YUFQMUIsZUFBYyxBQUFFLEFBQUMsQUFHaEM7YUFBZ0IsbUJBQXNCLEFBQUksQUFBQyxBQUMzQzthQUFXLGNBQTZFLEFBQUksQUFBQyxBQUM3RjthQUFTLFlBQUcsQUFBSSxBQUFnQiwwQ0FBQyxBQUFJLE1BQUUsQUFBWSxBQUFDLEFBQUMsQUFHMUQsQUFBSTthQUFDLEFBQU8sVUFBRyxBQUFPLEFBQUMsQUFFdkIsQUFBSTthQUFDLEFBQVMsVUFBQyxBQUFNLE9BQUMsQUFBTyxVQUFHLFlBQzlCO2dCQUFJLEFBQUksT0FBRyxBQUFJLEtBQUMsQUFBTyxBQUFFLEFBQUMsQUFDMUIsQUFBRSxBQUFDO2dCQUFDLEFBQUksU0FBSyxBQUFHLEFBQUMsS0FBQyxBQUFDLEFBQ2pCLEFBQUk7cUJBQUMsQUFBTyxBQUFDLFdBQUcsQUFBbUIsQUFBQyxBQUN0QyxBQUFDLEFBQUMsQUFBSTt1QkFBSyxBQUFJLFNBQUssQUFBRyxBQUFDLEtBQUMsQUFBQyxBQUN4QixBQUFJO3FCQUFDLEFBQU8sQUFBQyxXQUFHLEFBQVksQUFBQyxBQUMvQixBQUFDLEFBQUMsQUFBSSxBQUZDLEFBQUUsQUFBQzttQkFFSCxBQUFFLEFB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QUMsQUFBVyxBQUFDO3FCQUM1QixBQUFNLGtCQUFDLEFBQUksUUFBSSxBQUFJLEtBQUMsQUFBSSxTQUFLLEFBQVEsVUFBRSxBQUFrQixBQUFDLEFBQUMsQUFDM0QsQUFBTTs7bUJBQUMsQUFBcUIsQUFBQyxBQUMvQixBQUFDLEFBRUQsQUFBSSxBQUFjOzs7OzRCQUNoQjtnQkFBSSxBQUFJLE9BQUcsQUFBSSxLQUFDLEFBQVcsQUFBQztxQkFDNUIsQUFBTSxrQkFBQyxBQUFJLFFBQUksQUFBSSxLQUFDLEFBQUksU0FBSyxBQUFrQixvQkFBRSxBQUFvQixBQUFDLEFBQUMsQUFDdkUsQUFBTTs7bUJBQUMsQUFBNEIsQUFBQyxBQUN0QyxBQUFDLEFBRUQsQUFBSSxBQUFXOzs7OzRCQUNiO2dCQUFJLEFBQUksT0FBRyxBQUFJLEtBQUMsQUFBVyxBQUFDO3FCQUM1QixBQUFNLGtCQUFDLEFBQUksUUFBSSxBQUFJLEtBQUMsQUFBSSxTQUFLLEFBQVUsWUFBRSxBQUFzQixBQUFDLEFBQUMsQUFDakUsQUFBTTs7bUJBQUMsQUFBb0IsQUFBQyxBQUU5QixBQUFDLEFBSUQsQUFBVSIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7XG4gIEV2ZW50ZWRUb2tlbml6ZXIsXG4gIEVudGl0eVBhcnNlcixcbiAgSFRNTDVOYW1lZENoYXJSZWZzIGFzIG5hbWVkQ2hhclJlZnNcbn0gZnJvbSBcInNpbXBsZS1odG1sLXRva2VuaXplclwiO1xuaW1wb3J0IHsgUHJvZ3JhbSB9IGZyb20gXCIuL3R5cGVzL25vZGVzXCI7XG5pbXBvcnQgKiBhcyBBU1QgZnJvbSBcIi4vdHlwZXMvbm9kZXNcIjtcbmltcG9ydCAqIGFzIEhhbmRsZWJhcnNBU1QgZnJvbSAnLi90eXBlcy9oYW5kbGViYXJzLWFzdCc7XG5pbXBvcnQgeyBPcHRpb24gfSBmcm9tICdAZ2xpbW1lci9pbnRlcmZhY2VzJztcbmltcG9ydCB7IGFzc2VydCwgZXhwZWN0IH0gZnJvbSAnQGdsaW1tZXIvdXRpbCc7XG5cbmNvbnN0IGVudGl0eVBhcnNlciA9IG5ldyBFbnRpdHlQYXJzZXIobmFtZWRDaGFyUmVmcyk7XG5cbmV4cG9ydCB0eXBlIEVsZW1lbnQgPSBBU1QuUHJvZ3JhbSB8IEFTVC5FbGVtZW50Tm9kZTtcblxuZXhwb3J0IGludGVyZmFjZSBUYWc8VCBleHRlbmRzICdTdGFydFRhZycgfCAnRW5kVGFnJz4ge1xuICB0eXBlOiBUO1xuICBuYW1lOiBzdHJpbmc7XG4gIGF0dHJpYnV0ZXM6IGFueVtdO1xuICBtb2RpZmllcnM6IGFueVtdO1xuICBjb21tZW50czogYW55W107XG4gIHNlbGZDbG9zaW5nOiBib29sZWFuO1xuICBsb2M6IEFTVC5Tb3VyY2VMb2NhdGlvbjtcbn1cblxuZXhwb3J0IGludGVyZmFjZSBBdHRyaWJ1dGUge1xuICBuYW1lOiBzdHJpbmc7XG4gIHBhcnRzOiAoQVNULk11c3RhY2hlU3RhdGVtZW50IHwgQVNULlRleHROb2RlKVtdO1xuICBpc1F1b3RlZDogYm9vbGVhbjtcbiAgaXNEeW5hbWljOiBib29sZWFuO1xuICBzdGFydDogQVNULlBvc2l0aW9uO1xuICB2YWx1ZVN0YXJ0TGluZTogbnVtYmVyO1xuICB2YWx1ZVN0YXJ0Q29sdW1uOiBudW1iZXI7XG59XG5cbmV4cG9ydCBjbGFzcyBQYXJzZXIge1xuICBwcm90ZWN0ZWQgZWxlbWVudFN0YWNrOiBFbGVtZW50W10gPSBbXTtcbiAgcHJpdmF0ZSBvcHRpb25zOiBPYmplY3Q7XG4gIHByaXZhdGUgc291cmNlOiBzdHJpbmdbXTtcbiAgcHVibGljIGN1cnJlbnRBdHRyaWJ1dGU6IE9wdGlvbjxBdHRyaWJ1dGU+ID0gbnVsbDtcbiAgcHVibGljIGN1cnJlbnROb2RlOiBPcHRpb248QVNULkNvbW1lbnRTdGF0ZW1lbnQgfCBBU1QuVGV4dE5vZGUgfCBUYWc8J1N0YXJ0VGFnJyB8ICdFbmRUYWcnPj4gPSBudWxsO1xuICBwdWJsaWMgdG9rZW5pemVyID0gbmV3IEV2ZW50ZWRUb2tlbml6ZXIodGhpcywgZW50aXR5UGFyc2VyKTtcblxuICBjb25zdHJ1Y3Rvcihzb3VyY2U6IHN0cmluZywgb3B0aW9uczogT2JqZWN0ID0ge30pIHtcbiAgICB0aGlzLm9wdGlvbnMgPSBvcHRpb25zO1xuXG4gICAgdGhpcy50b2tlbml6ZXIuc3RhdGVzLnRhZ09wZW4gPSBmdW5jdGlvbih0aGlzOiBFdmVudGVkVG9rZW5pemVyKSB7XG4gICAgICBsZXQgY2hhciA9IHRoaXMuY29uc3VtZSgpO1xuICAgICAgaWYgKGNoYXIgPT09IFwiIVwiKSB7XG4gICAgICAgIHRoaXNbJ3N0YXRlJ10gPSAnbWFya3VwRGVjbGFyYXRpb24nO1xuICAgICAgfSBlbHNlIGlmIChjaGFyID09PSBcIi9cIikge1xuICAgICAgICB0aGlzWydzdGF0ZSddID0gJ2VuZFRhZ09wZW4nO1xuICAgICAgfSBlbHNlIGlmICgvW0EtWmEtel0vLnRlc3QoY2hhcikpIHtcbiAgICAgICAgdGhpc1snc3RhdGUnXSA9ICd0YWdOYW1lJztcbiAgICAgICAgdGhpc1snZGVsZWdhdGUnXS5iZWdpblN0YXJ0VGFnKCk7XG4gICAgICAgIHRoaXNbJ2RlbGVnYXRlJ10uYXBwZW5kVG9UYWdOYW1lKGNoYXIpO1xuICAgICAgfVxuICAgIH07XG5cbiAgICB0aGlzLnRva2VuaXplci5zdGF0ZXMuZW5kVGFnT3BlbiA9IGZ1bmN0aW9uKHRoaXM6IEV2ZW50ZWRUb2tlbml6ZXIpIHtcbiAgICAgIGxldCBjaGFyID0gdGhpcy5jb25zdW1lKCk7XG4gICAgICBpZiAoL1tBLVphLXpdLy50ZXN0KGNoYXIpKSB7XG4gICAgICAgIHRoaXNbJ3N0YXRlJ10gPSAndGFnTmFtZSc7XG4gICAgICAgIHRoaXNbJ2RlbGVnYXRlJ10uYmVnaW5FbmRUYWcoKTtcbiAgICAgICAgdGhpc1snZGVsZWdhdGUnXS5hcHBlbmRUb1RhZ05hbWUoY2hhcik7XG4gICAgICB9XG4gICAgfTtcblxuICAgIHRoaXMuc291cmNlID0gc291cmNlLnNwbGl0KC8oPzpcXHJcXG4/fFxcbikvZyk7XG4gIH1cblxuICBnZXQgY3VycmVudEF0dHIoKTogQXR0cmlidXRlIHtcbiAgICByZXR1cm4gZXhwZWN0KHRoaXMuY3VycmVudEF0dHJpYnV0ZSwgJ2V4cGVjdGVkIGF0dHJpYnV0ZScpO1xuICB9XG5cbiAgZ2V0IGN1cnJlbnRUYWcoKTogVGFnPCdTdGFydFRhZycgfCAnRW5kVGFnJz4ge1xuICAgIGxldCBub2RlID0gdGhpcy5jdXJyZW50Tm9kZTtcbiAgICBhc3NlcnQobm9kZSAmJiAobm9kZS50eXBlID09PSAnU3RhcnRUYWcnIHx8IG5vZGUudHlwZSA9PT0gJ0VuZFRhZycpLCAnZXhwZWN0ZWQgdGFnJyk7XG4gICAgcmV0dXJuIG5vZGUgYXMgVGFnPCdTdGFydFRhZycgfCAnRW5kVGFnJz47XG4gIH1cblxuICBnZXQgY3VycmVudFN0YXJ0VGFnKCk6IFRhZzwnU3RhcnRUYWcnPiB7XG4gICAgbGV0IG5vZGUgPSB0aGlzLmN1cnJlbnROb2RlO1xuICAgIGFzc2VydChub2RlICYmIG5vZGUudHlwZSA9PT0gJ1N0YXJ0VGFnJywgJ2V4cGVjdGVkIHN0YXJ0IHRhZycpO1xuICAgIHJldHVybiBub2RlIGFzIFRhZzwnU3RhcnRUYWcnPjtcbiAgfVxuXG4gIGdldCBjdXJyZW50RW5kVGFnKCk6IFRhZzwnRW5kVGFnJz4ge1xuICAgIGxldCBub2RlID0gdGhpcy5jdXJyZW50Tm9kZTtcbiAgICBhc3NlcnQobm9kZSAmJiBub2RlLnR5cGUgPT09ICdFbmRUYWcnLCAnZXhwZWN0ZWQgZW5kIHRhZycpO1xuICAgIHJldHVybiBub2RlIGFzIFRhZzwnRW5kVGFnJz47XG4gIH1cblxuICBnZXQgY3VycmVudENvbW1lbnQoKTogQVNULkNvbW1lbnRTdGF0ZW1lbnQge1xuICAgIGxldCBub2RlID0gdGhpcy5jdXJyZW50Tm9kZTtcbiAgICBhc3NlcnQobm9kZSAmJiBub2RlLnR5cGUgPT09ICdDb21tZW50U3RhdGVtZW50JywgJ2V4cGVjdGVkIGEgY29tbWVudCcpO1xuICAgIHJldHVybiBub2RlIGFzIEFTVC5Db21tZW50U3RhdGVtZW50O1xuICB9XG5cbiAgZ2V0IGN1cnJlbnREYXRhKCk6IEFTVC5UZXh0Tm9kZSB7XG4gICAgbGV0IG5vZGUgPSB0aGlzLmN1cnJlbnROb2RlO1xuICAgIGFzc2VydChub2RlICYmIG5vZGUudHlwZSA9PT0gJ1RleHROb2RlJywgJ2V4cGVjdGVkIGEgdGV4dCBub2RlJyk7XG4gICAgcmV0dXJuIG5vZGUgYXMgQVNULlRleHROb2RlO1xuXG4gIH1cblxuICBhY2NlcHROb2RlKG5vZGU6IEhhbmRsZWJhcnNBU1QuUHJvZ3JhbSk6IFByb2dyYW07XG4gIGFjY2VwdE5vZGU8VSBleHRlbmRzIEFTVC5Ob2RlPihub2RlOiBIYW5kbGViYXJzQVNULk5vZGUpOiBVO1xuICBhY2NlcHROb2RlKG5vZGU6IEhhbmRsZWJhcnNBU1QuTm9kZSk6IGFueSB7XG4gICAgcmV0dXJuIHRoaXNbbm9kZS50eXBlXShub2RlKTtcbiAgfVxuXG4gIGN1cnJlbnRFbGVtZW50KCk6IEVsZW1lbnQge1xuICAgIHJldHVybiB0aGlzLmVsZW1lbnRTdGFja1t0aGlzLmVsZW1lbnRTdGFjay5sZW5ndGggLSAxXTtcbiAgfVxuXG4gIHNvdXJjZUZvck5vZGUobm9kZTogSGFuZGxlYmFyc0FTVC5Ob2RlLCBlbmROb2RlPzogeyBsb2M6IEhhbmRsZWJhcnNBU1QuU291cmNlTG9jYXRpb24gfSk6IHN0cmluZyB7XG4gICAgbGV0IGZpcnN0TGluZSA9IG5vZGUubG9jLnN0YXJ0LmxpbmUgLSAxO1xuICAgIGxldCBjdXJyZW50TGluZSA9IGZpcnN0TGluZSAtIDE7XG4gICAgbGV0IGZpcnN0Q29sdW1uID0gbm9kZS5sb2Muc3RhcnQuY29sdW1uO1xuICAgIGxldCBzdHJpbmcgPSBbXTtcbiAgICBsZXQgbGluZTtcblxuICAgIGxldCBsYXN0TGluZTogbnVtYmVyO1xuICAgIGxldCBsYXN0Q29sdW1uOiBudW1iZXI7XG5cbiAgICBpZiAoZW5kTm9kZSkge1xuICAgICAgbGFzdExpbmUgPSBlbmROb2RlLmxvYy5lbmQubGluZSAtIDE7XG4gICAgICBsYXN0Q29sdW1uID0gZW5kTm9kZS5sb2MuZW5kLmNvbHVtbjtcbiAgICB9IGVsc2Uge1xuICAgICAgbGFzdExpbmUgPSBub2RlLmxvYy5lbmQubGluZSAtIDE7XG4gICAgICBsYXN0Q29sdW1uID0gbm9kZS5sb2MuZW5kLmNvbHVtbjtcbiAgICB9XG5cbiAgICB3aGlsZSAoY3VycmVudExpbmUgPCBsYXN0TGluZSkge1xuICAgICAgY3VycmVudExpbmUrKztcbiAgICAgIGxpbmUgPSB0aGlzLnNvdXJjZVtjdXJyZW50TGluZV07XG5cbiAgICAgIGlmIChjdXJyZW50TGluZSA9PT0gZmlyc3RMaW5lKSB7XG4gICAgICAgIGlmIChmaXJzdExpbmUgPT09IGxhc3RMaW5lKSB7XG4gICAgICAgICAgc3RyaW5nLnB1c2gobGluZS5zbGljZShmaXJzdENvbHVtbiwgbGFzdENvbHVtbikpO1xuICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgIHN0cmluZy5wdXNoKGxpbmUuc2xpY2UoZmlyc3RDb2x1bW4pKTtcbiAgICAgICAgfVxuICAgICAgfSBlbHNlIGlmIChjdXJyZW50TGluZSA9PT0gbGFzdExpbmUpIHtcbiAgICAgICAgc3RyaW5nLnB1c2gobGluZS5zbGljZSgwLCBsYXN0Q29sdW1uKSk7XG4gICAgICB9IGVsc2Uge1xuICAgICAgICBzdHJpbmcucHVzaChsaW5lKTtcbiAgICAgIH1cbiAgICB9XG5cbiAgICByZXR1cm4gc3RyaW5nLmpvaW4oJ1xcbicpO1xuICB9XG59XG4iXX0=