"use strict";

Object.defineProperty(exports, "__esModule", {
    value: true
});
exports.HandlebarsNodeVisitors = undefined;

var _builders = require("../builders");

var _builders2 = _interopRequireDefault(_builders);

var _utils = require("../utils");

var _parser = require("../parser");

var _syntaxError = require("../errors/syntax-error");

var _syntaxError2 = _interopRequireDefault(_syntaxError);

function _interopRequireDefault(obj) { return obj && obj.__esModule ? obj : { default: obj }; }

function _defaults(obj, defaults) {
    var keys = Object.getOwnPropertyNames(defaults);for (var i = 0; i < keys.length; i++) {
        var key = keys[i];var value = Object.getOwnPropertyDescriptor(defaults, key);if (value && value.configurable && obj[key] === undefined) {
            Object.defineProperty(obj, key, value);
        }
    }return obj;
}

function _classCallCheck(instance, Constructor) {
    if (!(instance instanceof Constructor)) {
        throw new TypeError("Cannot call a class as a function");
    }
}

function _possibleConstructorReturn(self, call) {
    if (!self) {
        throw new ReferenceError("this hasn't been initialised - super() hasn't been called");
    }return call && (typeof call === "object" || typeof call === "function") ? call : self;
}

function _inherits(subClass, superClass) {
    if (typeof superClass !== "function" && superClass !== null) {
        throw new TypeError("Super expression must either be null or a function, not " + typeof superClass);
    }subClass.prototype = Object.create(superClass && superClass.prototype, { constructor: { value: subClass, enumerable: false, writable: true, configurable: true } });if (superClass) Object.setPrototypeOf ? Object.setPrototypeOf(subClass, superClass) : _defaults(subClass, superClass);
}

var HandlebarsNodeVisitors = exports.HandlebarsNodeVisitors = function (_Parser) {
    _inherits(HandlebarsNodeVisitors, _Parser);

    function HandlebarsNodeVisitors() {
        _classCallCheck(this, HandlebarsNodeVisitors);

        var _this = _possibleConstructorReturn(this, _Parser.apply(this, arguments));

        _this.cursorCount = 0;
        return _this;
    }

    HandlebarsNodeVisitors.prototype.cursor = function cursor() {
        return "%cursor:" + this.cursorCount++ + "%";
    };

    HandlebarsNodeVisitors.prototype.Program = function Program(program) {
        var body = [];
        this.cursorCount = 0;
        var node = _builders2.default.program(body, program.blockParams, program.loc);
        var i = void 0,
            l = program.body.length;
        this.elementStack.push(node);
        if (l === 0) {
            return this.elementStack.pop();
        }
        for (i = 0; i < l; i++) {
            this.acceptNode(program.body[i]);
        }
        // Ensure that that the element stack is balanced properly.
        var poppedNode = this.elementStack.pop();
        if (poppedNode !== node) {
            var elementNode = poppedNode;
            throw new _syntaxError2.default("Unclosed element `" + elementNode.tag + "` (on line " + elementNode.loc.start.line + ").", elementNode.loc);
        }
        return node;
    };

    HandlebarsNodeVisitors.prototype.BlockStatement = function BlockStatement(block) {
        if (this.tokenizer['state'] === 'comment') {
            this.appendToCommentData(this.sourceForNode(block));
            return;
        }
        if (this.tokenizer['state'] !== 'comment' && this.tokenizer['state'] !== 'data' && this.tokenizer['state'] !== 'beforeData') {
            throw new _syntaxError2.default("A block may only be used inside an HTML element or another block.", block.loc);
        }

        var _acceptCallNodes = acceptCallNodes(this, block),
            path = _acceptCallNodes.path,
            params = _acceptCallNodes.params,
            hash = _acceptCallNodes.hash;

        var program = this.Program(block.program);
        var inverse = block.inverse ? this.Program(block.inverse) : null;
        if (path.original === 'in-element') {
            hash = addInElementHash(this.cursor(), hash, block.loc);
        }
        var node = _builders2.default.block(path, params, hash, program, inverse, block.loc);
        var parentProgram = this.currentElement();
        (0, _utils.appendChild)(parentProgram, node);
    };

    HandlebarsNodeVisitors.prototype.MustacheStatement = function MustacheStatement(rawMustache) {
        var tokenizer = this.tokenizer;

        if (tokenizer['state'] === 'comment') {
            this.appendToCommentData(this.sourceForNode(rawMustache));
            return;
        }
        var mustache = void 0;
        var escaped = rawMustache.escaped,
            loc = rawMustache.loc;

        if (rawMustache.path.type.match(/Literal$/)) {
            mustache = {
                type: 'MustacheStatement',
                path: this.acceptNode(rawMustache.path),
                params: [],
                hash: _builders2.default.hash(),
                escaped: escaped,
                loc: loc
            };
        } else {
            var _acceptCallNodes2 = acceptCallNodes(this, rawMustache),
                path = _acceptCallNodes2.path,
                params = _acceptCallNodes2.params,
                hash = _acceptCallNodes2.hash;

            mustache = _builders2.default.mustache(path, params, hash, !escaped, loc);
        }
        switch (tokenizer['state']) {
            // Tag helpers
            case "tagName":
                addElementModifier(this.currentStartTag, mustache);
                tokenizer['state'] = "beforeAttributeName";
                break;
            case "beforeAttributeName":
                addElementModifier(this.currentStartTag, mustache);
                break;
            case "attributeName":
            case "afterAttributeName":
                this.beginAttributeValue(false);
                this.finishAttributeValue();
                addElementModifier(this.currentStartTag, mustache);
                tokenizer['state'] = "beforeAttributeName";
                break;
            case "afterAttributeValueQuoted":
                addElementModifier(this.currentStartTag, mustache);
                tokenizer['state'] = "beforeAttributeName";
                break;
            // Attribute values
            case "beforeAttributeValue":
                this.beginAttributeValue(false);
                appendDynamicAttributeValuePart(this.currentAttribute, mustache);
                tokenizer['state'] = 'attributeValueUnquoted';
                break;
            case "attributeValueDoubleQuoted":
            case "attributeValueSingleQuoted":
            case "attributeValueUnquoted":
                appendDynamicAttributeValuePart(this.currentAttribute, mustache);
                break;
            // TODO: Only append child when the tokenizer state makes
            // sense to do so, otherwise throw an error.
            default:
                (0, _utils.appendChild)(this.currentElement(), mustache);
        }
        return mustache;
    };

    HandlebarsNodeVisitors.prototype.ContentStatement = function ContentStatement(content) {
        updateTokenizerLocation(this.tokenizer, content);
        this.tokenizer.tokenizePart(content.value);
        this.tokenizer.flushData();
    };

    HandlebarsNodeVisitors.prototype.CommentStatement = function CommentStatement(rawComment) {
        var tokenizer = this.tokenizer;

        if (tokenizer['state'] === 'comment') {
            this.appendToCommentData(this.sourceForNode(rawComment));
            return null;
        }
        var value = rawComment.value,
            loc = rawComment.loc;

        var comment = _builders2.default.mustacheComment(value, loc);
        switch (tokenizer['state']) {
            case "beforeAttributeName":
                this.currentStartTag.comments.push(comment);
                break;
            case 'beforeData':
            case 'data':
                (0, _utils.appendChild)(this.currentElement(), comment);
                break;
            default:
                throw new _syntaxError2.default("Using a Handlebars comment when in the `" + tokenizer['state'] + "` state is not supported: \"" + comment.value + "\" on line " + loc.start.line + ":" + loc.start.column, rawComment.loc);
        }
        return comment;
    };

    HandlebarsNodeVisitors.prototype.PartialStatement = function PartialStatement(partial) {
        var loc = partial.loc;

        throw new _syntaxError2.default("Handlebars partials are not supported: \"" + this.sourceForNode(partial, partial.name) + "\" at L" + loc.start.line + ":C" + loc.start.column, partial.loc);
    };

    HandlebarsNodeVisitors.prototype.PartialBlockStatement = function PartialBlockStatement(partialBlock) {
        var loc = partialBlock.loc;

        throw new _syntaxError2.default("Handlebars partial blocks are not supported: \"" + this.sourceForNode(partialBlock, partialBlock.name) + "\" at L" + loc.start.line + ":C" + loc.start.column, partialBlock.loc);
    };

    HandlebarsNodeVisitors.prototype.Decorator = function Decorator(decorator) {
        var loc = decorator.loc;

        throw new _syntaxError2.default("Handlebars decorators are not supported: \"" + this.sourceForNode(decorator, decorator.path) + "\" at L" + loc.start.line + ":C" + loc.start.column, decorator.loc);
    };

    HandlebarsNodeVisitors.prototype.DecoratorBlock = function DecoratorBlock(decoratorBlock) {
        var loc = decoratorBlock.loc;

        throw new _syntaxError2.default("Handlebars decorator blocks are not supported: \"" + this.sourceForNode(decoratorBlock, decoratorBlock.path) + "\" at L" + loc.start.line + ":C" + loc.start.column, decoratorBlock.loc);
    };

    HandlebarsNodeVisitors.prototype.SubExpression = function SubExpression(sexpr) {
        var _acceptCallNodes3 = acceptCallNodes(this, sexpr),
            path = _acceptCallNodes3.path,
            params = _acceptCallNodes3.params,
            hash = _acceptCallNodes3.hash;

        return _builders2.default.sexpr(path, params, hash, sexpr.loc);
    };

    HandlebarsNodeVisitors.prototype.PathExpression = function PathExpression(path) {
        var original = path.original,
            loc = path.loc;

        var parts = void 0;
        if (original.indexOf('/') !== -1) {
            if (original.slice(0, 2) === './') {
                throw new _syntaxError2.default("Using \"./\" is not supported in Glimmer and unnecessary: \"" + path.original + "\" on line " + loc.start.line + ".", path.loc);
            }
            if (original.slice(0, 3) === '../') {
                throw new _syntaxError2.default("Changing context using \"../\" is not supported in Glimmer: \"" + path.original + "\" on line " + loc.start.line + ".", path.loc);
            }
            if (original.indexOf('.') !== -1) {
                throw new _syntaxError2.default("Mixing '.' and '/' in paths is not supported in Glimmer; use only '.' to separate property paths: \"" + path.original + "\" on line " + loc.start.line + ".", path.loc);
            }
            parts = [path.parts.join('/')];
        } else {
            parts = path.parts;
        }
        var thisHead = false;
        // This is to fix a bug in the Handlebars AST where the path expressions in
        // `{{this.foo}}` (and similarly `{{foo-bar this.foo named=this.foo}}` etc)
        // are simply turned into `{{foo}}`. The fix is to push it back onto the
        // parts array and let the runtime see the difference. However, we cannot
        // simply use the string `this` as it means literally the property called
        // "this" in the current context (it can be expressed in the syntax as
        // `{{[this]}}`, where the square bracket are generally for this kind of
        // escaping – such as `{{foo.["bar.baz"]}}` would mean lookup a property
        // named literally "bar.baz" on `this.foo`). By convention, we use `null`
        // for this purpose.
        if (original.match(/^this(\..+)?$/)) {
            thisHead = true;
        }
        return {
            type: 'PathExpression',
            original: path.original,
            this: thisHead,
            parts: parts,
            data: path.data,
            loc: path.loc
        };
    };

    HandlebarsNodeVisitors.prototype.Hash = function Hash(hash) {
        var pairs = [];
        for (var i = 0; i < hash.pairs.length; i++) {
            var pair = hash.pairs[i];
            pairs.push(_builders2.default.pair(pair.key, this.acceptNode(pair.value), pair.loc));
        }
        return _builders2.default.hash(pairs, hash.loc);
    };

    HandlebarsNodeVisitors.prototype.StringLiteral = function StringLiteral(string) {
        return _builders2.default.literal('StringLiteral', string.value, string.loc);
    };

    HandlebarsNodeVisitors.prototype.BooleanLiteral = function BooleanLiteral(boolean) {
        return _builders2.default.literal('BooleanLiteral', boolean.value, boolean.loc);
    };

    HandlebarsNodeVisitors.prototype.NumberLiteral = function NumberLiteral(number) {
        return _builders2.default.literal('NumberLiteral', number.value, number.loc);
    };

    HandlebarsNodeVisitors.prototype.UndefinedLiteral = function UndefinedLiteral(undef) {
        return _builders2.default.literal('UndefinedLiteral', undefined, undef.loc);
    };

    HandlebarsNodeVisitors.prototype.NullLiteral = function NullLiteral(nul) {
        return _builders2.default.literal('NullLiteral', null, nul.loc);
    };

    return HandlebarsNodeVisitors;
}(_parser.Parser);
function calculateRightStrippedOffsets(original, value) {
    if (value === '') {
        // if it is empty, just return the count of newlines
        // in original
        return {
            lines: original.split("\n").length - 1,
            columns: 0
        };
    }
    // otherwise, return the number of newlines prior to
    // `value`
    var difference = original.split(value)[0];
    var lines = difference.split(/\n/);
    var lineCount = lines.length - 1;
    return {
        lines: lineCount,
        columns: lines[lineCount].length
    };
}
function updateTokenizerLocation(tokenizer, content) {
    var line = content.loc.start.line;
    var column = content.loc.start.column;
    var offsets = calculateRightStrippedOffsets(content.original, content.value);
    line = line + offsets.lines;
    if (offsets.lines) {
        column = offsets.columns;
    } else {
        column = column + offsets.columns;
    }
    tokenizer.line = line;
    tokenizer.column = column;
}
function acceptCallNodes(compiler, node) {
    var path = compiler.PathExpression(node.path);
    var params = node.params ? node.params.map(function (e) {
        return compiler.acceptNode(e);
    }) : [];
    var hash = node.hash ? compiler.Hash(node.hash) : _builders2.default.hash();
    return { path: path, params: params, hash: hash };
}
function addElementModifier(element, mustache) {
    var path = mustache.path,
        params = mustache.params,
        hash = mustache.hash,
        loc = mustache.loc;

    if ((0, _utils.isLiteral)(path)) {
        var _modifier = "{{" + (0, _utils.printLiteral)(path) + "}}";
        var tag = "<" + element.name + " ... " + _modifier + " ...";
        throw new _syntaxError2.default("In " + tag + ", " + _modifier + " is not a valid modifier: \"" + path.original + "\" on line " + (loc && loc.start.line) + ".", mustache.loc);
    }
    var modifier = _builders2.default.elementModifier(path, params, hash, loc);
    element.modifiers.push(modifier);
}
function addInElementHash(cursor, hash, loc) {
    var hasNextSibling = false;
    hash.pairs.forEach(function (pair) {
        if (pair.key === 'guid') {
            throw new _syntaxError2.default('Cannot pass `guid` from user space', loc);
        }
        if (pair.key === 'nextSibling') {
            hasNextSibling = true;
        }
    });
    var guid = _builders2.default.literal('StringLiteral', cursor);
    var guidPair = _builders2.default.pair('guid', guid);
    hash.pairs.unshift(guidPair);
    if (!hasNextSibling) {
        var nullLiteral = _builders2.default.literal('NullLiteral', null);
        var nextSibling = _builders2.default.pair('nextSibling', nullLiteral);
        hash.pairs.push(nextSibling);
    }
    return hash;
}
function appendDynamicAttributeValuePart(attribute, part) {
    attribute.isDynamic = true;
    attribute.parts.push(part);
}
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiaGFuZGxlYmFycy1ub2RlLXZpc2l0b3JzLmpzIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsiLi4vLi4vLi4vLi4vLi4vcGFja2FnZXMvQGdsaW1tZXIvc3ludGF4L2xpYi9wYXJzZXIvaGFuZGxlYmFycy1ub2RlLXZpc2l0b3JzLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7Ozs7Ozs7QUFBQSxBQUFPLEFBQUMsQUFBTSxBQUFhLEFBQUM7Ozs7QUFDNUIsQUFBTyxBQUFFLEFBQVcsQUFBRSxBQUFTLEFBQUUsQUFBWSxBQUFFLEFBQU0sQUFBVSxBQUFDOztBQUdoRSxBQUFPLEFBQUUsQUFBTSxBQUFrQixBQUFNLEFBQVcsQUFBQzs7QUFDbkQsQUFBTyxBQUFXLEFBQU0sQUFBd0IsQUFBQyxBQUlqRCxBQUFNOzs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7OztJQUF1Qzs7Ozs7O3lFQUszQzs7Y0FBVyxjQUFHLEFBQUMsQUFBQyxBQXFRbEIsQUFBQztlQW5RQyxBQUFNOzs7Z0VBQ0osQUFBTSxBQUFDOzRCQUFXLEFBQUksS0FBQyxBQUFXLEFBQUUsQUFBRyxBQUFDLEFBQzFDLEFBQUMsZ0JBRUQsQUFBTzs7O2dFQUFDLEFBQThCLFNBQ3BDO1lBQUksQUFBSSxPQUFvQixBQUFFLEFBQUMsQUFDL0IsQUFBSTthQUFDLEFBQVcsY0FBRyxBQUFDLEFBQUMsQUFDckI7WUFBSSxBQUFJLE9BQUcsQUFBQyxtQkFBQyxBQUFPLFFBQUMsQUFBSSxNQUFFLEFBQU8sUUFBQyxBQUFXLGFBQUUsQUFBTyxRQUFDLEFBQUcsQUFBQyxBQUFDLEFBQzdEO1lBQUksQUFBQztZQUFFLEFBQUMsSUFBRyxBQUFPLFFBQUMsQUFBSSxLQUFDLEFBQU0sQUFBQyxBQUUvQixBQUFJO2FBQUMsQUFBWSxhQUFDLEFBQUksS0FBQyxBQUFJLEFBQUMsQUFBQyxBQUU3QixBQUFFLEFBQUM7WUFBQyxBQUFDLE1BQUssQUFBQyxBQUFDLEdBQUMsQUFBQyxBQUFDLEFBQU07bUJBQUMsQUFB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ZSxpQkFBRSxBQUFNLEFBQUMsQUFBQyxBQUM5QztRQUFJLEFBQVEsV0FBRyxBQUFDLG1CQUFDLEFBQUksS0FBQyxBQUFNLFFBQUUsQUFBSSxBQUFDLEFBQUMsQUFDcEMsQUFBSTtTQUFDLEFBQUssTUFBQyxBQUFPLFFBQUMsQUFBUSxBQUFDLEFBQUMsQUFFN0IsQUFBRSxBQUFDO1FBQUMsQ0FBQyxBQUFjLEFBQUMsZ0JBQUMsQUFBQyxBQUNwQjtZQUFJLEFBQVcsY0FBRyxBQUFDLG1CQUFDLEFBQU8sUUFBQyxBQUFhLGVBQUUsQUFBSSxBQUFDLEFBQUMsQUFDakQ7WUFBSSxBQUFXLGNBQUcsQUFBQyxtQkFBQyxBQUFJLEtBQUMsQUFBYSxlQUFFLEFBQVcsQUFBQyxBQUFDLEFBQ3JELEFBQUk7YUFBQyxBQUFLLE1BQUMsQUFBSSxLQUFDLEFBQVcsQUFBQyxBQUFDLEFBQy9CLEFBQUMsQUFFRCxBQUFNOztXQUFDLEFBQUksQUFBQyxBQUNkLEFBQUM7O0FBRUQseUNBQXlDLEFBQW9CLFdBQUUsQUFBMkIsTUFDeEYsQUFBUztjQUFDLEFBQVMsWUFBRyxBQUFJLEFBQUMsQUFDM0IsQUFBUztjQUFDLEFBQUssTUFBQyxBQUFJLEtBQUMsQUFBSSxBQUFDLEFBQUMsQUFDN0IsQUFBQyIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCBiIGZyb20gXCIuLi9idWlsZGVyc1wiO1xuaW1wb3J0IHsgYXBwZW5kQ2hpbGQsIGlzTGl0ZXJhbCwgcHJpbnRMaXRlcmFsIH0gZnJvbSBcIi4uL3V0aWxzXCI7XG5pbXBvcnQgKiBhcyBBU1QgZnJvbSAnLi4vdHlwZXMvbm9kZXMnO1xuaW1wb3J0ICogYXMgSGFuZGxlYmFyc0FTVCBmcm9tICcuLi90eXBlcy9oYW5kbGViYXJzLWFzdCc7XG5pbXBvcnQgeyBQYXJzZXIsIFRhZywgQXR0cmlidXRlIH0gZnJvbSAnLi4vcGFyc2VyJztcbmltcG9ydCBTeW50YXhFcnJvciBmcm9tICcuLi9lcnJvcnMvc3ludGF4LWVycm9yJztcbmltcG9ydCB7IE9wdGlvbiB9IGZyb20gXCJAZ2xpbW1lci91dGlsXCI7XG5pbXBvcnQgeyBSZWNhc3QgfSBmcm9tIFwiQGdsaW1tZXIvaW50ZXJmYWNlc1wiO1xuXG5leHBvcnQgYWJzdHJhY3QgY2xhc3MgSGFuZGxlYmFyc05vZGVWaXNpdG9ycyBleHRlbmRzIFBhcnNlciB7XG4gIGFic3RyYWN0IGFwcGVuZFRvQ29tbWVudERhdGEoczogc3RyaW5nKTogdm9pZDtcbiAgYWJzdHJhY3QgYmVnaW5BdHRyaWJ1dGVWYWx1ZShxdW90ZWQ6IGJvb2xlYW4pOiB2b2lkO1xuICBhYnN0cmFjdCBmaW5pc2hBdHRyaWJ1dGVWYWx1ZSgpOiB2b2lkO1xuXG4gIGN1cnNvckNvdW50ID0gMDtcblxuICBjdXJzb3IoKSB7XG4gICAgcmV0dXJuIGAlY3Vyc29yOiR7dGhpcy5jdXJzb3JDb3VudCsrfSVgO1xuICB9XG5cbiAgUHJvZ3JhbShwcm9ncmFtOiBIYW5kbGViYXJzQVNULlByb2dyYW0pOiBBU1QuUHJvZ3JhbSB7XG4gICAgbGV0IGJvZHk6IEFTVC5TdGF0ZW1lbnRbXSA9IFtdO1xuICAgIHRoaXMuY3Vyc29yQ291bnQgPSAwO1xuICAgIGxldCBub2RlID0gYi5wcm9ncmFtKGJvZHksIHByb2dyYW0uYmxvY2tQYXJhbXMsIHByb2dyYW0ubG9jKTtcbiAgICBsZXQgaSwgbCA9IHByb2dyYW0uYm9keS5sZW5ndGg7XG5cbiAgICB0aGlzLmVsZW1lbnRTdGFjay5wdXNoKG5vZGUpO1xuXG4gICAgaWYgKGwgPT09IDApIHsgcmV0dXJuIHRoaXMuZWxlbWVudFN0YWNrLnBvcCgpIGFzIEFTVC5Qcm9ncmFtOyB9XG5cbiAgICBmb3IgKGkgPSAwOyBpIDwgbDsgaSsrKSB7XG4gICAgICB0aGlzLmFjY2VwdE5vZGUocHJvZ3JhbS5ib2R5W2ldKTtcbiAgICB9XG5cbiAgICAvLyBFbnN1cmUgdGhhdCB0aGF0IHRoZSBlbGVtZW50IHN0YWNrIGlzIGJhbGFuY2VkIHByb3Blcmx5LlxuICAgIGxldCBwb3BwZWROb2RlID0gdGhpcy5lbGVtZW50U3RhY2sucG9wKCk7XG4gICAgaWYgKHBvcHBlZE5vZGUgIT09IG5vZGUpIHtcbiAgICAgIGxldCBlbGVtZW50Tm9kZSA9IHBvcHBlZE5vZGUgYXMgQVNULkVsZW1lbnROb2RlO1xuXG4gICAgICB0aHJvdyBuZXcgU3ludGF4RXJyb3IoXCJVbmNsb3NlZCBlbGVtZW50IGBcIiArIGVsZW1lbnROb2RlLnRhZyArIFwiYCAob24gbGluZSBcIiArIGVsZW1lbnROb2RlLmxvYyEuc3RhcnQubGluZSArIFwiKS5cIiwgZWxlbWVudE5vZGUubG9jKTtcbiAgICB9XG5cbiAgICByZXR1cm4gbm9kZTtcbiAgfVxuXG4gIEJsb2NrU3RhdGVtZW50KGJsb2NrOiBIYW5kbGViYXJzQVNULkJsb2NrU3RhdGVtZW50KSB7XG4gICAgaWYgKHRoaXMudG9rZW5pemVyWydzdGF0ZSddID09PSAnY29tbWVudCcpIHtcbiAgICAgIHRoaXMuYXBwZW5kVG9Db21tZW50RGF0YSh0aGlzLnNvdXJjZUZvck5vZGUoYmxvY2spKTtcbiAgICAgIHJldHVybjtcbiAgICB9XG5cbiAgICBpZiAodGhpcy50b2tlbml6ZXJbJ3N0YXRlJ10gIT09ICdjb21tZW50JyAmJiB0aGlzLnRva2VuaXplclsnc3RhdGUnXSAhPT0gJ2RhdGEnICYmIHRoaXMudG9rZW5pemVyWydzdGF0ZSddICE9PSAnYmVmb3JlRGF0YScpIHtcbiAgICAgIHRocm93IG5ldyBTeW50YXhFcnJvcihcIkEgYmxvY2sgbWF5IG9ubHkgYmUgdXNlZCBpbnNpZGUgYW4gSFRNTCBlbGVtZW50IG9yIGFub3RoZXIgYmxvY2suXCIsIGJsb2NrLmxvYyk7XG4gICAgfVxuXG4gICAgbGV0IHsgcGF0aCwgcGFyYW1zLCBoYXNoIH0gPSBhY2NlcHRDYWxsTm9kZXModGhpcywgYmxvY2spO1xuICAgIGxldCBwcm9ncmFtID0gdGhpcy5Qcm9ncmFtKGJsb2NrLnByb2dyYW0pO1xuICAgIGxldCBpbnZlcnNlID0gYmxvY2suaW52ZXJzZSA/IHRoaXMuUHJvZ3JhbShibG9jay5pbnZlcnNlKSA6IG51bGw7XG5cbiAgICBpZihwYXRoLm9yaWdpbmFsID09PSAnaW4tZWxlbWVudCcpIHtcbiAgICAgIGhhc2ggPSBhZGRJbkVsZW1lbnRIYXNoKHRoaXMuY3Vyc29yKCksIGhhc2gsIGJsb2NrLmxvYyk7XG4gICAgfVxuXG4gICAgbGV0IG5vZGUgPSBiLmJsb2NrKHBhdGgsIHBhcmFtcywgaGFzaCwgcHJvZ3JhbSwgaW52ZXJzZSwgYmxvY2subG9jKTtcblxuICAgIGxldCBwYXJlbnRQcm9ncmFtID0gdGhpcy5jdXJyZW50RWxlbWVudCgpO1xuICAgIGFwcGVuZENoaWxkKHBhcmVudFByb2dyYW0sIG5vZGUpO1xuICB9XG5cbiAgTXVzdGFjaGVTdGF0ZW1lbnQocmF3TXVzdGFjaGU6IEhhbmRsZWJhcnNBU1QuTXVzdGFjaGVTdGF0ZW1lbnQpIHtcbiAgICBsZXQgeyB0b2tlbml6ZXIgfSA9IHRoaXM7XG5cbiAgICBpZiAodG9rZW5pemVyWydzdGF0ZSddID09PSAnY29tbWVudCcpIHtcbiAgICAgIHRoaXMuYXBwZW5kVG9Db21tZW50RGF0YSh0aGlzLnNvdXJjZUZvck5vZGUocmF3TXVzdGFjaGUpKTtcbiAgICAgIHJldHVybjtcbiAgICB9XG5cbiAgICBsZXQgbXVzdGFjaGU6IEFTVC5NdXN0YWNoZVN0YXRlbWVudDtcbiAgICBsZXQgeyBlc2NhcGVkLCBsb2MgfSA9IHJhd011c3RhY2hlO1xuXG4gICAgaWYgKHJhd011c3RhY2hlLnBhdGgudHlwZS5tYXRjaCgvTGl0ZXJhbCQvKSkge1xuICAgICAgbXVzdGFjaGUgPSB7XG4gICAgICAgIHR5cGU6ICdNdXN0YWNoZVN0YXRlbWVudCcsXG4gICAgICAgIHBhdGg6IHRoaXMuYWNjZXB0Tm9kZTxBU1QuTGl0ZXJhbD4ocmF3TXVzdGFjaGUucGF0aCksXG4gICAgICAgIHBhcmFtczogW10sXG4gICAgICAgIGhhc2g6IGIuaGFzaCgpLFxuICAgICAgICBlc2NhcGVkLFxuICAgICAgICBsb2NcbiAgICAgIH07XG4gICAgfSBlbHNlIHtcbiAgICAgIGxldCB7IHBhdGgsIHBhcmFtcywgaGFzaCB9ID0gYWNjZXB0Q2FsbE5vZGVzKHRoaXMsIHJhd011c3RhY2hlIGFzIEhhbmRsZWJhcnNBU1QuTXVzdGFjaGVTdGF0ZW1lbnQgJiB7IHBhdGg6IEhhbmRsZWJhcnNBU1QuUGF0aEV4cHJlc3Npb24gfSk7XG4gICAgICBtdXN0YWNoZSA9IGIubXVzdGFjaGUocGF0aCwgcGFyYW1zLCBoYXNoLCAhZXNjYXBlZCwgbG9jKTtcbiAgICB9XG5cbiAgICBzd2l0Y2ggKHRva2VuaXplclsnc3RhdGUnXSkge1xuICAgICAgLy8gVGFnIGhlbHBlcnNcbiAgICAgIGNhc2UgXCJ0YWdOYW1lXCI6XG4gICAgICAgIGFkZEVsZW1lbnRNb2RpZmllcih0aGlzLmN1cnJlbnRTdGFydFRhZywgbXVzdGFjaGUpO1xuICAgICAgICB0b2tlbml6ZXJbJ3N0YXRlJ10gPSBcImJlZm9yZUF0dHJpYnV0ZU5hbWVcIjtcbiAgICAgICAgYnJlYWs7XG4gICAgICBjYXNlIFwiYmVmb3JlQXR0cmlidXRlTmFtZVwiOlxuICAgICAgICBhZGRFbGVtZW50TW9kaWZpZXIodGhpcy5jdXJyZW50U3RhcnRUYWcsIG11c3RhY2hlKTtcbiAgICAgICAgYnJlYWs7XG4gICAgICBjYXNlIFwiYXR0cmlidXRlTmFtZVwiOlxuICAgICAgY2FzZSBcImFmdGVyQXR0cmlidXRlTmFtZVwiOlxuICAgICAgICB0aGlzLmJlZ2luQXR0cmlidXRlVmFsdWUoZmFsc2UpO1xuICAgICAgICB0aGlzLmZpbmlzaEF0dHJpYnV0ZVZhbHVlKCk7XG4gICAgICAgIGFkZEVsZW1lbnRNb2RpZmllcih0aGlzLmN1cnJlbnRTdGFydFRhZywgbXVzdGFjaGUpO1xuICAgICAgICB0b2tlbml6ZXJbJ3N0YXRlJ10gPSBcImJlZm9yZUF0dHJpYnV0ZU5hbWVcIjtcbiAgICAgICAgYnJlYWs7XG4gICAgICBjYXNlIFwiYWZ0ZXJBdHRyaWJ1dGVWYWx1ZVF1b3RlZFwiOlxuICAgICAgICBhZGRFbGVtZW50TW9kaWZpZXIodGhpcy5jdXJyZW50U3RhcnRUYWcsIG11c3RhY2hlKTtcbiAgICAgICAgdG9rZW5pemVyWydzdGF0ZSddID0gXCJiZWZvcmVBdHRyaWJ1dGVOYW1lXCI7XG4gICAgICAgIGJyZWFrO1xuXG4gICAgICAvLyBBdHRyaWJ1dGUgdmFsdWVzXG4gICAgICBjYXNlIFwiYmVmb3JlQXR0cmlidXRlVmFsdWVcIjpcbiAgICAgICAgdGhpcy5iZWdpbkF0dHJpYnV0ZVZhbHVlKGZhbHNlKTtcbiAgICAgICAgYXBwZW5kRHluYW1pY0F0dHJpYnV0ZVZhbHVlUGFydCh0aGlzLmN1cnJlbnRBdHRyaWJ1dGUhLCBtdXN0YWNoZSk7XG4gICAgICAgIHRva2VuaXplclsnc3RhdGUnXSA9ICdhdHRyaWJ1dGVWYWx1ZVVucXVvdGVkJztcbiAgICAgICAgYnJlYWs7XG4gICAgICBjYXNlIFwiYXR0cmlidXRlVmFsdWVEb3VibGVRdW90ZWRcIjpcbiAgICAgIGNhc2UgXCJhdHRyaWJ1dGVWYWx1ZVNpbmdsZVF1b3RlZFwiOlxuICAgICAgY2FzZSBcImF0dHJpYnV0ZVZhbHVlVW5xdW90ZWRcIjpcbiAgICAgICAgYXBwZW5kRHluYW1pY0F0dHJpYnV0ZVZhbHVlUGFydCh0aGlzLmN1cnJlbnRBdHRyaWJ1dGUhLCBtdXN0YWNoZSk7XG4gICAgICAgIGJyZWFrO1xuXG4gICAgICAvLyBUT0RPOiBPbmx5IGFwcGVuZCBjaGlsZCB3aGVuIHRoZSB0b2tlbml6ZXIgc3RhdGUgbWFrZXNcbiAgICAgIC8vIHNlbnNlIHRvIGRvIHNvLCBvdGhlcndpc2UgdGhyb3cgYW4gZXJyb3IuXG4gICAgICBkZWZhdWx0OlxuICAgICAgICBhcHBlbmRDaGlsZCh0aGlzLmN1cnJlbnRFbGVtZW50KCksIG11c3RhY2hlKTtcbiAgICB9XG5cbiAgICByZXR1cm4gbXVzdGFjaGU7XG4gIH1cblxuICBDb250ZW50U3RhdGVtZW50KGNvbnRlbnQ6IEhhbmRsZWJhcnNBU1QuQ29udGVudFN0YXRlbWVudCkge1xuICAgIHVwZGF0ZVRva2VuaXplckxvY2F0aW9uKHRoaXMudG9rZW5pemVyLCBjb250ZW50KTtcblxuICAgIHRoaXMudG9rZW5pemVyLnRva2VuaXplUGFydChjb250ZW50LnZhbHVlKTtcbiAgICB0aGlzLnRva2VuaXplci5mbHVzaERhdGEoKTtcbiAgfVxuXG4gIENvbW1lbnRTdGF0ZW1lbnQocmF3Q29tbWVudDogSGFuZGxlYmFyc0FTVC5Db21tZW50U3RhdGVtZW50KTogT3B0aW9uPEFTVC5NdXN0YWNoZUNvbW1lbnRTdGF0ZW1lbnQ+IHtcbiAgICBsZXQgeyB0b2tlbml6ZXIgfSA9IHRoaXM7XG5cbiAgICBpZiAodG9rZW5pemVyWydzdGF0ZSddID09PSAnY29tbWVudCcpIHtcbiAgICAgIHRoaXMuYXBwZW5kVG9Db21tZW50RGF0YSh0aGlzLnNvdXJjZUZvck5vZGUocmF3Q29tbWVudCkpO1xuICAgICAgcmV0dXJuIG51bGw7XG4gICAgfVxuXG4gICAgbGV0IHsgdmFsdWUsIGxvYyB9ID0gcmF3Q29tbWVudDtcbiAgICBsZXQgY29tbWVudCA9IGIubXVzdGFjaGVDb21tZW50KHZhbHVlLCBsb2MpO1xuXG4gICAgc3dpdGNoICh0b2tlbml6ZXJbJ3N0YXRlJ10pIHtcbiAgICAgIGNhc2UgXCJiZWZvcmVBdHRyaWJ1dGVOYW1lXCI6XG4gICAgICAgIHRoaXMuY3VycmVudFN0YXJ0VGFnLmNvbW1lbnRzLnB1c2goY29tbWVudCk7XG4gICAgICAgIGJyZWFrO1xuXG4gICAgICBjYXNlICdiZWZvcmVEYXRhJzpcbiAgICAgIGNhc2UgJ2RhdGEnOlxuICAgICAgICBhcHBlbmRDaGlsZCh0aGlzLmN1cnJlbnRFbGVtZW50KCksIGNvbW1lbnQpO1xuICAgICAgICBicmVhaztcblxuICAgICAgZGVmYXVsdDpcbiAgICAgICAgdGhyb3cgbmV3IFN5bnRheEVycm9yKGBVc2luZyBhIEhhbmRsZWJhcnMgY29tbWVudCB3aGVuIGluIHRoZSBcXGAke3Rva2VuaXplclsnc3RhdGUnXX1cXGAgc3RhdGUgaXMgbm90IHN1cHBvcnRlZDogXCIke2NvbW1lbnQudmFsdWV9XCIgb24gbGluZSAke2xvYy5zdGFydC5saW5lfToke2xvYy5zdGFydC5jb2x1bW59YCwgcmF3Q29tbWVudC5sb2MpO1xuICAgIH1cblxuICAgIHJldHVybiBjb21tZW50O1xuICB9XG5cbiAgUGFydGlhbFN0YXRlbWVudChwYXJ0aWFsOiBIYW5kbGViYXJzQVNULlBhcnRpYWxTdGF0ZW1lbnQpIHtcbiAgICBsZXQgeyBsb2MgfSA9IHBhcnRpYWw7XG5cbiAgICB0aHJvdyBuZXcgU3ludGF4RXJyb3IoYEhhbmRsZWJhcnMgcGFydGlhbHMgYXJlIG5vdCBzdXBwb3J0ZWQ6IFwiJHt0aGlzLnNvdXJjZUZvck5vZGUocGFydGlhbCwgcGFydGlhbC5uYW1lKX1cIiBhdCBMJHtsb2Muc3RhcnQubGluZX06QyR7bG9jLnN0YXJ0LmNvbHVtbn1gLCBwYXJ0aWFsLmxvYyk7XG4gIH1cblxuICBQYXJ0aWFsQmxvY2tTdGF0ZW1lbnQocGFydGlhbEJsb2NrOiBIYW5kbGViYXJzQVNULlBhcnRpYWxCbG9ja1N0YXRlbWVudCkge1xuICAgIGxldCB7IGxvYyB9ID0gcGFydGlhbEJsb2NrO1xuXG4gICAgdGhyb3cgbmV3IFN5bnRheEVycm9yKGBIYW5kbGViYXJzIHBhcnRpYWwgYmxvY2tzIGFyZSBub3Qgc3VwcG9ydGVkOiBcIiR7dGhpcy5zb3VyY2VGb3JOb2RlKHBhcnRpYWxCbG9jaywgcGFydGlhbEJsb2NrLm5hbWUpfVwiIGF0IEwke2xvYy5zdGFydC5saW5lfTpDJHtsb2Muc3RhcnQuY29sdW1ufWAsIHBhcnRpYWxCbG9jay5sb2MpO1xuICB9XG5cbiAgRGVjb3JhdG9yKGRlY29yYXRvcjogSGFuZGxlYmFyc0FTVC5EZWNvcmF0b3IpIHtcbiAgICBsZXQgeyBsb2MgfSA9IGRlY29yYXRvcjtcblxuICAgIHRocm93IG5ldyBTeW50YXhFcnJvcihgSGFuZGxlYmFycyBkZWNvcmF0b3JzIGFyZSBub3Qgc3VwcG9ydGVkOiBcIiR7dGhpcy5zb3VyY2VGb3JOb2RlKGRlY29yYXRvciwgZGVjb3JhdG9yLnBhdGgpfVwiIGF0IEwke2xvYy5zdGFydC5saW5lfTpDJHtsb2Muc3RhcnQuY29sdW1ufWAsIGRlY29yYXRvci5sb2MpO1xuICB9XG5cbiAgRGVjb3JhdG9yQmxvY2soZGVjb3JhdG9yQmxvY2s6IEhhbmRsZWJhcnNBU1QuRGVjb3JhdG9yQmxvY2spIHtcbiAgICBsZXQgeyBsb2MgfSA9IGRlY29yYXRvckJsb2NrO1xuXG4gICAgdGhyb3cgbmV3IFN5bnRheEVycm9yKGBIYW5kbGViYXJzIGRlY29yYXRvciBibG9ja3MgYXJlIG5vdCBzdXBwb3J0ZWQ6IFwiJHt0aGlzLnNvdXJjZUZvck5vZGUoZGVjb3JhdG9yQmxvY2ssIGRlY29yYXRvckJsb2NrLnBhdGgpfVwiIGF0IEwke2xvYy5zdGFydC5saW5lfTpDJHtsb2Muc3RhcnQuY29sdW1ufWAsIGRlY29yYXRvckJsb2NrLmxvYyk7XG4gIH1cblxuICBTdWJFeHByZXNzaW9uKHNleHByOiBIYW5kbGViYXJzQVNULlN1YkV4cHJlc3Npb24pOiBBU1QuU3ViRXhwcmVzc2lvbiB7XG4gICAgbGV0IHsgcGF0aCwgcGFyYW1zLCBoYXNoIH0gPSBhY2NlcHRDYWxsTm9kZXModGhpcywgc2V4cHIpO1xuICAgIHJldHVybiBiLnNleHByKHBhdGgsIHBhcmFtcywgaGFzaCwgc2V4cHIubG9jKTtcbiAgfVxuXG4gIFBhdGhFeHByZXNzaW9uKHBhdGg6IEhhbmRsZWJhcnNBU1QuUGF0aEV4cHJlc3Npb24pOiBBU1QuUGF0aEV4cHJlc3Npb24ge1xuICAgIGxldCB7IG9yaWdpbmFsLCBsb2MgfSA9IHBhdGg7XG4gICAgbGV0IHBhcnRzOiBzdHJpbmdbXTtcblxuICAgIGlmIChvcmlnaW5hbC5pbmRleE9mKCcvJykgIT09IC0xKSB7XG4gICAgICBpZiAob3JpZ2luYWwuc2xpY2UoMCwgMikgPT09ICcuLycpIHtcbiAgICAgICAgdGhyb3cgbmV3IFN5bnRheEVycm9yKGBVc2luZyBcIi4vXCIgaXMgbm90IHN1cHBvcnRlZCBpbiBHbGltbWVyIGFuZCB1bm5lY2Vzc2FyeTogXCIke3BhdGgub3JpZ2luYWx9XCIgb24gbGluZSAke2xvYy5zdGFydC5saW5lfS5gLCBwYXRoLmxvYyk7XG4gICAgICB9XG4gICAgICBpZiAob3JpZ2luYWwuc2xpY2UoMCwgMykgPT09ICcuLi8nKSB7XG4gICAgICAgIHRocm93IG5ldyBTeW50YXhFcnJvcihgQ2hhbmdpbmcgY29udGV4dCB1c2luZyBcIi4uL1wiIGlzIG5vdCBzdXBwb3J0ZWQgaW4gR2xpbW1lcjogXCIke3BhdGgub3JpZ2luYWx9XCIgb24gbGluZSAke2xvYy5zdGFydC5saW5lfS5gLCBwYXRoLmxvYyk7XG4gICAgICB9XG4gICAgICBpZiAob3JpZ2luYWwuaW5kZXhPZignLicpICE9PSAtMSkge1xuICAgICAgICB0aHJvdyBuZXcgU3ludGF4RXJyb3IoYE1peGluZyAnLicgYW5kICcvJyBpbiBwYXRocyBpcyBub3Qgc3VwcG9ydGVkIGluIEdsaW1tZXI7IHVzZSBvbmx5ICcuJyB0byBzZXBhcmF0ZSBwcm9wZXJ0eSBwYXRoczogXCIke3BhdGgub3JpZ2luYWx9XCIgb24gbGluZSAke2xvYy5zdGFydC5saW5lfS5gLCBwYXRoLmxvYyk7XG4gICAgICB9XG4gICAgICBwYXJ0cyA9IFsgcGF0aC5wYXJ0cy5qb2luKCcvJykgXTtcbiAgICB9IGVsc2Uge1xuICAgICAgcGFydHMgPSBwYXRoLnBhcnRzO1xuICAgIH1cblxuICAgIGxldCB0aGlzSGVhZCA9IGZhbHNlO1xuXG4gICAgLy8gVGhpcyBpcyB0byBmaXggYSBidWcgaW4gdGhlIEhhbmRsZWJhcnMgQVNUIHdoZXJlIHRoZSBwYXRoIGV4cHJlc3Npb25zIGluXG4gICAgLy8gYHt7dGhpcy5mb299fWAgKGFuZCBzaW1pbGFybHkgYHt7Zm9vLWJhciB0aGlzLmZvbyBuYW1lZD10aGlzLmZvb319YCBldGMpXG4gICAgLy8gYXJlIHNpbXBseSB0dXJuZWQgaW50byBge3tmb299fWAuIFRoZSBmaXggaXMgdG8gcHVzaCBpdCBiYWNrIG9udG8gdGhlXG4gICAgLy8gcGFydHMgYXJyYXkgYW5kIGxldCB0aGUgcnVudGltZSBzZWUgdGhlIGRpZmZlcmVuY2UuIEhvd2V2ZXIsIHdlIGNhbm5vdFxuICAgIC8vIHNpbXBseSB1c2UgdGhlIHN0cmluZyBgdGhpc2AgYXMgaXQgbWVhbnMgbGl0ZXJhbGx5IHRoZSBwcm9wZXJ0eSBjYWxsZWRcbiAgICAvLyBcInRoaXNcIiBpbiB0aGUgY3VycmVudCBjb250ZXh0IChpdCBjYW4gYmUgZXhwcmVzc2VkIGluIHRoZSBzeW50YXggYXNcbiAgICAvLyBge3tbdGhpc119fWAsIHdoZXJlIHRoZSBzcXVhcmUgYnJhY2tldCBhcmUgZ2VuZXJhbGx5IGZvciB0aGlzIGtpbmQgb2ZcbiAgICAvLyBlc2NhcGluZyDigJMgc3VjaCBhcyBge3tmb28uW1wiYmFyLmJhelwiXX19YCB3b3VsZCBtZWFuIGxvb2t1cCBhIHByb3BlcnR5XG4gICAgLy8gbmFtZWQgbGl0ZXJhbGx5IFwiYmFyLmJhelwiIG9uIGB0aGlzLmZvb2ApLiBCeSBjb252ZW50aW9uLCB3ZSB1c2UgYG51bGxgXG4gICAgLy8gZm9yIHRoaXMgcHVycG9zZS5cbiAgICBpZiAob3JpZ2luYWwubWF0Y2goL150aGlzKFxcLi4rKT8kLykpIHtcbiAgICAgIHRoaXNIZWFkID0gdHJ1ZTtcbiAgICB9XG5cbiAgICByZXR1cm4ge1xuICAgICAgdHlwZTogJ1BhdGhFeHByZXNzaW9uJyxcbiAgICAgIG9yaWdpbmFsOiBwYXRoLm9yaWdpbmFsLFxuICAgICAgdGhpczogdGhpc0hlYWQsXG4gICAgICBwYXJ0cyxcbiAgICAgIGRhdGE6IHBhdGguZGF0YSxcbiAgICAgIGxvYzogcGF0aC5sb2NcbiAgICB9O1xuICB9XG5cbiAgSGFzaChoYXNoOiBIYW5kbGViYXJzQVNULkhhc2gpOiBBU1QuSGFzaCB7XG4gICAgbGV0IHBhaXJzOiBBU1QuSGFzaFBhaXJbXSA9IFtdO1xuXG4gICAgZm9yIChsZXQgaSA9IDA7IGkgPCBoYXNoLnBhaXJzLmxlbmd0aDsgaSsrKSB7XG4gICAgICBsZXQgcGFpciA9IGhhc2gucGFpcnNbaV07XG4gICAgICBwYWlycy5wdXNoKGIucGFpcihwYWlyLmtleSwgdGhpcy5hY2NlcHROb2RlPEFTVC5FeHByZXNzaW9uPihwYWlyLnZhbHVlKSwgcGFpci5sb2MpKTtcbiAgICB9XG5cbiAgICByZXR1cm4gYi5oYXNoKHBhaXJzLCBoYXNoLmxvYyk7XG4gIH1cblxuICBTdHJpbmdMaXRlcmFsKHN0cmluZzogSGFuZGxlYmFyc0FTVC5TdHJpbmdMaXRlcmFsKSB7XG4gICAgcmV0dXJuIGIubGl0ZXJhbCgnU3RyaW5nTGl0ZXJhbCcsIHN0cmluZy52YWx1ZSwgc3RyaW5nLmxvYyk7XG4gIH1cblxuICBCb29sZWFuTGl0ZXJhbChib29sZWFuOiBIYW5kbGViYXJzQVNULkJvb2xlYW5MaXRlcmFsKSB7XG4gICAgcmV0dXJuIGIubGl0ZXJhbCgnQm9vbGVhbkxpdGVyYWwnLCBib29sZWFuLnZhbHVlLCBib29sZWFuLmxvYyk7XG4gIH1cblxuICBOdW1iZXJMaXRlcmFsKG51bWJlcjogSGFuZGxlYmFyc0FTVC5OdW1iZXJMaXRlcmFsKSB7XG4gICAgcmV0dXJuIGIubGl0ZXJhbCgnTnVtYmVyTGl0ZXJhbCcsIG51bWJlci52YWx1ZSwgbnVtYmVyLmxvYyk7XG4gIH1cblxuICBVbmRlZmluZWRMaXRlcmFsKHVuZGVmOiBIYW5kbGViYXJzQVNULlVuZGVmaW5lZExpdGVyYWwpIHtcbiAgICByZXR1cm4gYi5saXRlcmFsKCdVbmRlZmluZWRMaXRlcmFsJywgdW5kZWZpbmVkLCB1bmRlZi5sb2MpO1xuICB9XG5cbiAgTnVsbExpdGVyYWwobnVsOiBIYW5kbGViYXJzQVNULk51bGxMaXRlcmFsKSB7XG4gICAgcmV0dXJuIGIubGl0ZXJhbCgnTnVsbExpdGVyYWwnLCBudWxsLCBudWwubG9jKTtcbiAgfVxufVxuXG5mdW5jdGlvbiBjYWxjdWxhdGVSaWdodFN0cmlwcGVkT2Zmc2V0cyhvcmlnaW5hbDogc3RyaW5nLCB2YWx1ZTogc3RyaW5nKSB7XG4gIGlmICh2YWx1ZSA9PT0gJycpIHtcbiAgICAvLyBpZiBpdCBpcyBlbXB0eSwganVzdCByZXR1cm4gdGhlIGNvdW50IG9mIG5ld2xpbmVzXG4gICAgLy8gaW4gb3JpZ2luYWxcbiAgICByZXR1cm4ge1xuICAgICAgbGluZXM6IG9yaWdpbmFsLnNwbGl0KFwiXFxuXCIpLmxlbmd0aCAtIDEsXG4gICAgICBjb2x1bW5zOiAwXG4gICAgfTtcbiAgfVxuXG4gIC8vIG90aGVyd2lzZSwgcmV0dXJuIHRoZSBudW1iZXIgb2YgbmV3bGluZXMgcHJpb3IgdG9cbiAgLy8gYHZhbHVlYFxuICBsZXQgZGlmZmVyZW5jZSA9IG9yaWdpbmFsLnNwbGl0KHZhbHVlKVswXTtcbiAgbGV0IGxpbmVzID0gZGlmZmVyZW5jZS5zcGxpdCgvXFxuLyk7XG4gIGxldCBsaW5lQ291bnQgPSBsaW5lcy5sZW5ndGggLSAxO1xuXG4gIHJldHVybiB7XG4gICAgbGluZXM6IGxpbmVDb3VudCxcbiAgICBjb2x1bW5zOiBsaW5lc1tsaW5lQ291bnRdLmxlbmd0aFxuICB9O1xufVxuXG5mdW5jdGlvbiB1cGRhdGVUb2tlbml6ZXJMb2NhdGlvbih0b2tlbml6ZXI6IFBhcnNlclsndG9rZW5pemVyJ10sIGNvbnRlbnQ6IEhhbmRsZWJhcnNBU1QuQ29udGVudFN0YXRlbWVudCkge1xuICBsZXQgbGluZSA9IGNvbnRlbnQubG9jLnN0YXJ0LmxpbmU7XG4gIGxldCBjb2x1bW4gPSBjb250ZW50LmxvYy5zdGFydC5jb2x1bW47XG5cbiAgbGV0IG9mZnNldHMgPSBjYWxjdWxhdGVSaWdodFN0cmlwcGVkT2Zmc2V0cyhjb250ZW50Lm9yaWdpbmFsIGFzIFJlY2FzdDxIYW5kbGViYXJzQVNULlN0cmlwRmxhZ3MsIHN0cmluZz4sIGNvbnRlbnQudmFsdWUpO1xuXG4gIGxpbmUgPSBsaW5lICsgb2Zmc2V0cy5saW5lcztcbiAgaWYgKG9mZnNldHMubGluZXMpIHtcbiAgICBjb2x1bW4gPSBvZmZzZXRzLmNvbHVtbnM7XG4gIH0gZWxzZSB7XG4gICAgY29sdW1uID0gY29sdW1uICsgb2Zmc2V0cy5jb2x1bW5zO1xuICB9XG5cbiAgdG9rZW5pemVyLmxpbmUgPSBsaW5lO1xuICB0b2tlbml6ZXIuY29sdW1uID0gY29sdW1uO1xufVxuXG5mdW5jdGlvbiBhY2NlcHRDYWxsTm9kZXMoY29tcGlsZXI6IEhhbmRsZWJhcnNOb2RlVmlzaXRvcnMsIG5vZGU6IHsgcGF0aDogSGFuZGxlYmFyc0FTVC5QYXRoRXhwcmVzc2lvbiwgcGFyYW1zOiBIYW5kbGViYXJzQVNULkV4cHJlc3Npb25bXSwgaGFzaDogSGFuZGxlYmFyc0FTVC5IYXNoIH0pOiB7IHBhdGg6IEFTVC5QYXRoRXhwcmVzc2lvbiwgcGFyYW1zOiBBU1QuRXhwcmVzc2lvbltdLCBoYXNoOiBBU1QuSGFzaCB9IHtcbiAgbGV0IHBhdGggPSBjb21waWxlci5QYXRoRXhwcmVzc2lvbihub2RlLnBhdGgpO1xuXG4gIGxldCBwYXJhbXMgPSBub2RlLnBhcmFtcyA/IG5vZGUucGFyYW1zLm1hcChlID0+IGNvbXBpbGVyLmFjY2VwdE5vZGU8QVNULkV4cHJlc3Npb24+KGUpKSA6IFtdO1xuICBsZXQgaGFzaCA9IG5vZGUuaGFzaCA/IGNvbXBpbGVyLkhhc2gobm9kZS5oYXNoKSA6IGIuaGFzaCgpO1xuXG4gIHJldHVybiB7IHBhdGgsIHBhcmFtcywgaGFzaCB9O1xufVxuXG5mdW5jdGlvbiBhZGRFbGVtZW50TW9kaWZpZXIoZWxlbWVudDogVGFnPCdTdGFydFRhZyc+LCBtdXN0YWNoZTogQVNULk11c3RhY2hlU3RhdGVtZW50KSB7XG4gIGxldCB7IHBhdGgsIHBhcmFtcywgaGFzaCwgbG9jIH0gPSBtdXN0YWNoZTtcblxuICBpZiAoaXNMaXRlcmFsKHBhdGgpKSB7XG4gICAgbGV0IG1vZGlmaWVyID0gYHt7JHtwcmludExpdGVyYWwocGF0aCl9fX1gO1xuICAgIGxldCB0YWcgPSBgPCR7ZWxlbWVudC5uYW1lfSAuLi4gJHttb2RpZmllcn0gLi4uYDtcblxuICAgIHRocm93IG5ldyBTeW50YXhFcnJvcihgSW4gJHt0YWd9LCAke21vZGlmaWVyfSBpcyBub3QgYSB2YWxpZCBtb2RpZmllcjogXCIke3BhdGgub3JpZ2luYWx9XCIgb24gbGluZSAke2xvYyAmJiBsb2Muc3RhcnQubGluZX0uYCwgbXVzdGFjaGUubG9jKTtcbiAgfVxuXG4gIGxldCBtb2RpZmllciA9IGIuZWxlbWVudE1vZGlmaWVyKHBhdGgsIHBhcmFtcywgaGFzaCwgbG9jKTtcbiAgZWxlbWVudC5tb2RpZmllcnMucHVzaChtb2RpZmllcik7XG59XG5cbmZ1bmN0aW9uIGFkZEluRWxlbWVudEhhc2goY3Vyc29yOiBzdHJpbmcsIGhhc2g6IEFTVC5IYXNoLCBsb2M6IEFTVC5Tb3VyY2VMb2NhdGlvbikge1xuICBsZXQgaGFzTmV4dFNpYmxpbmcgPSBmYWxzZTtcbiAgaGFzaC5wYWlycy5mb3JFYWNoKChwYWlyKSA9PiB7XG4gICAgaWYgKHBhaXIua2V5ID09PSAnZ3VpZCcpIHtcbiAgICAgIHRocm93IG5ldyBTeW50YXhFcnJvcignQ2Fubm90IHBhc3MgYGd1aWRgIGZyb20gdXNlciBzcGFjZScsIGxvYyk7XG4gICAgfVxuXG4gICAgaWYgKHBhaXIua2V5ID09PSAnbmV4dFNpYmxpbmcnKSB7XG4gICAgICBoYXNOZXh0U2libGluZyA9IHRydWU7XG4gICAgfVxuICB9KTtcblxuICBsZXQgZ3VpZCA9IGIubGl0ZXJhbCgnU3RyaW5nTGl0ZXJhbCcsIGN1cnNvcik7XG4gIGxldCBndWlkUGFpciA9IGIucGFpcignZ3VpZCcsIGd1aWQpO1xuICBoYXNoLnBhaXJzLnVuc2hpZnQoZ3VpZFBhaXIpO1xuXG4gIGlmICghaGFzTmV4dFNpYmxpbmcpIHtcbiAgICBsZXQgbnVsbExpdGVyYWwgPSBiLmxpdGVyYWwoJ051bGxMaXRlcmFsJywgbnVsbCk7XG4gICAgbGV0IG5leHRTaWJsaW5nID0gYi5wYWlyKCduZXh0U2libGluZycsIG51bGxMaXRlcmFsKTtcbiAgICBoYXNoLnBhaXJzLnB1c2gobmV4dFNpYmxpbmcpO1xuICB9XG5cbiAgcmV0dXJuIGhhc2g7XG59XG5cbmZ1bmN0aW9uIGFwcGVuZER5bmFtaWNBdHRyaWJ1dGVWYWx1ZVBhcnQoYXR0cmlidXRlOiBBdHRyaWJ1dGUsIHBhcnQ6IEFTVC5NdXN0YWNoZVN0YXRlbWVudCkge1xuICBhdHRyaWJ1dGUuaXNEeW5hbWljID0gdHJ1ZTtcbiAgYXR0cmlidXRlLnBhcnRzLnB1c2gocGFydCk7XG59XG4iXX0=