"use strict";

Object.defineProperty(exports, "__esModule", {
    value: true
});
exports.Parser = undefined;

var _simpleHtmlTokenizer = require("simple-html-tokenizer");

var _util = require("@glimmer/util");

const entityParser = new _simpleHtmlTokenizer.EntityParser(_simpleHtmlTokenizer.HTML5NamedCharRefs);
class Parser {
    constructor(source, options = {}) {
        this.elementStack = [];
        this.currentAttribute = null;
        this.currentNode = null;
        this.tokenizer = new _simpleHtmlTokenizer.EventedTokenizer(this, entityParser);
        this.options = options;
        this.tokenizer.states.tagOpen = function () {
            let char = this.consume();
            if (char === "!") {
                this['state'] = 'markupDeclaration';
            } else if (char === "/") {
                this['state'] = 'endTagOpen';
            } else if (/[A-Za-z]/.test(char)) {
                this['state'] = 'tagName';
                this['delegate'].beginStartTag();
                this['delegate'].appendToTagName(char);
            }
        };
        this.tokenizer.states.endTagOpen = function () {
            let char = this.consume();
            if (/[A-Za-z]/.test(char)) {
                this['state'] = 'tagName';
                this['delegate'].beginEndTag();
                this['delegate'].appendToTagName(char);
            }
        };
        this.source = source.split(/(?:\r\n?|\n)/g);
    }
    get currentAttr() {
        return this.currentAttribute;
    }
    get currentTag() {
        let node = this.currentNode;
        false && (0, _util.assert)(node && (node.type === 'StartTag' || node.type === 'EndTag'), 'expected tag');

        return node;
    }
    get currentStartTag() {
        let node = this.currentNode;
        false && (0, _util.assert)(node && node.type === 'StartTag', 'expected start tag');

        return node;
    }
    get currentEndTag() {
        let node = this.currentNode;
        false && (0, _util.assert)(node && node.type === 'EndTag', 'expected end tag');

        return node;
    }
    get currentComment() {
        let node = this.currentNode;
        false && (0, _util.assert)(node && node.type === 'CommentStatement', 'expected a comment');

        return node;
    }
    get currentData() {
        let node = this.currentNode;
        false && (0, _util.assert)(node && node.type === 'TextNode', 'expected a text node');

        return node;
    }
    acceptNode(node) {
        return this[node.type](node);
    }
    currentElement() {
        return this.elementStack[this.elementStack.length - 1];
    }
    sourceForNode(node, endNode) {
        let firstLine = node.loc.start.line - 1;
        let currentLine = firstLine - 1;
        let firstColumn = node.loc.start.column;
        let string = [];
        let line;
        let lastLine;
        let lastColumn;
        if (endNode) {
            lastLine = endNode.loc.end.line - 1;
            lastColumn = endNode.loc.end.column;
        } else {
            lastLine = node.loc.end.line - 1;
            lastColumn = node.loc.end.column;
        }
        while (currentLine < lastLine) {
            currentLine++;
            line = this.source[currentLine];
            if (currentLine === firstLine) {
                if (firstLine === lastLine) {
                    string.push(line.slice(firstColumn, lastColumn));
                } else {
                    string.push(line.slice(firstColumn));
                }
            } else if (currentLine === lastLine) {
                string.push(line.slice(0, lastColumn));
            } else {
                string.push(line);
            }
        }
        return string.join('\n');
    }
}
exports.Parser = Parser;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoicGFyc2VyLmpzIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsiLi4vLi4vLi4vLi4vcGFja2FnZXMvQGdsaW1tZXIvc3ludGF4L2xpYi9wYXJzZXIudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6Ijs7Ozs7OztBQUFBLEFBQU8sQUFDTCxBQUFnQixBQUNoQixBQUFZLEFBQ1osQUFBa0IsQUFBSSxBQUFhLEFBQ3BDLEFBQU0sQUFBdUIsQUFBQzs7QUFLL0IsQUFBTyxBQUFFLEFBQU0sQUFBRSxBQUFNLEFBQUUsQUFBTSxBQUFlLEFBQUM7O0FBRS9DLE1BQU0sQUFBWSxlQUFHLEFBQUksQUFBWSxBQUFDLEFBQWEsQUFBQyxBQUFDLEFBd0JyRCxBQUFNOztnQkFRUSxBQUFjLFFBQUUsVUFBa0IsQUFBRSxJQVB0QzthQUFZLGVBQWMsQUFBRSxBQUFDLEFBR2hDO2FBQWdCLG1CQUFzQixBQUFJLEFBQUMsQUFDM0M7YUFBVyxjQUE2RSxBQUFJLEFBQUMsQUFDN0Y7YUFBUyxZQUFHLEFBQUksQUFBZ0IsMENBQUMsQUFBSSxNQUFFLEFBQVksQUFBQyxBQUFDLEFBRzFELEFBQUk7YUFBQyxBQUFPLFVBQUcsQUFBTyxBQUFDLEFBRXZCLEFBQUk7YUFBQyxBQUFTLFVBQUMsQUFBTSxPQUFDLEFBQU8sVUFBRyxZQUM5QjtnQkFBSSxBQUFJLE9BQUcsQUFBSSxLQUFDLEFBQU8sQUFBRSxBQUFDLEFBQzFCLEFBQUUsQUFBQztnQkFBQyxBQUFJLFNBQUssQUFBRyxBQUFDLEtBQUMsQUFBQyxBQUNqQixBQUFJO3FCQUFDLEFBQU8sQUFBQyxXQUFHLEFBQW1CLEFBQUMsQUFDdEMsQUFBQyxBQUFDLEFBQUk7dUJBQUssQUFBSSxTQUFLLEFBQUcsQUFBQyxLQUFDLEFBQUMsQUFDeEIsQUFBSTtxQkFBQyxBQUFPLEFBQUMsV0FBRyxBQUFZLEFBQUMsQUFDL0IsQUFBQyxBQUFDLEFBQUk7QUFGQyxBQUFFLEFBQUMsbUJBRUgsQUFBRSxBQUFDLElBQUMsQUFBVSxXQUFDLEFBQUksS0FB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RCxBQUFDLEFBQUMsQUFBSTt1QkFBQyxBQUFDLEFBQ04sQUFBTTsyQkFBQyxBQUFJLEtBQUMsQUFBSSxLQUFDLEFBQUssTUFBQyxBQUFXLEFBQUMsQUFBQyxBQUFDLEFBQ3ZDLEFBQUMsQUFDSDtBQUFDLEFBQUMsQUFBSTt1QkFBSyxBQUFXLGdCQUFLLEFBQVEsQUFBQyxVQUFDLEFBQUMsQUFDcEMsQUFBTTt1QkFBQyxBQUFJLEtBQUMsQUFBSSxLQUFDLEFBQUssTUFBQyxBQUFDLEdBQUUsQUFBVSxBQUFDLEFBQUMsQUFBQyxBQUN6QyxBQUFDLEFBQUMsQUFBSTtBQUZDLEFBQUUsQUFBQyxtQkFFSCxBQUFDLEFBQ04sQUFBTTt1QkFBQyxBQUFJLEtBQUMsQUFBSSxBQUFDLEFBQUMsQUFDcEIsQUFBQyxBQUNIO0FBQUM7QUFFRCxBQUFNO2VBQUMsQUFBTSxPQUFDLEFBQUksS0FBQyxBQUFJLEFBQUMsQUFBQyxBQUMzQixBQUFDLEFBQ0Y7O0FBOUdDIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHtcbiAgRXZlbnRlZFRva2VuaXplcixcbiAgRW50aXR5UGFyc2VyLFxuICBIVE1MNU5hbWVkQ2hhclJlZnMgYXMgbmFtZWRDaGFyUmVmc1xufSBmcm9tIFwic2ltcGxlLWh0bWwtdG9rZW5pemVyXCI7XG5pbXBvcnQgeyBQcm9ncmFtIH0gZnJvbSBcIi4vdHlwZXMvbm9kZXNcIjtcbmltcG9ydCAqIGFzIEFTVCBmcm9tIFwiLi90eXBlcy9ub2Rlc1wiO1xuaW1wb3J0ICogYXMgSGFuZGxlYmFyc0FTVCBmcm9tICcuL3R5cGVzL2hhbmRsZWJhcnMtYXN0JztcbmltcG9ydCB7IE9wdGlvbiB9IGZyb20gJ0BnbGltbWVyL2ludGVyZmFjZXMnO1xuaW1wb3J0IHsgYXNzZXJ0LCBleHBlY3QgfSBmcm9tICdAZ2xpbW1lci91dGlsJztcblxuY29uc3QgZW50aXR5UGFyc2VyID0gbmV3IEVudGl0eVBhcnNlcihuYW1lZENoYXJSZWZzKTtcblxuZXhwb3J0IHR5cGUgRWxlbWVudCA9IEFTVC5Qcm9ncmFtIHwgQVNULkVsZW1lbnROb2RlO1xuXG5leHBvcnQgaW50ZXJmYWNlIFRhZzxUIGV4dGVuZHMgJ1N0YXJ0VGFnJyB8ICdFbmRUYWcnPiB7XG4gIHR5cGU6IFQ7XG4gIG5hbWU6IHN0cmluZztcbiAgYXR0cmlidXRlczogYW55W107XG4gIG1vZGlmaWVyczogYW55W107XG4gIGNvbW1lbnRzOiBhbnlbXTtcbiAgc2VsZkNsb3Npbmc6IGJvb2xlYW47XG4gIGxvYzogQVNULlNvdXJjZUxvY2F0aW9uO1xufVxuXG5leHBvcnQgaW50ZXJmYWNlIEF0dHJpYnV0ZSB7XG4gIG5hbWU6IHN0cmluZztcbiAgcGFydHM6IChBU1QuTXVzdGFjaGVTdGF0ZW1lbnQgfCBBU1QuVGV4dE5vZGUpW107XG4gIGlzUXVvdGVkOiBib29sZWFuO1xuICBpc0R5bmFtaWM6IGJvb2xlYW47XG4gIHN0YXJ0OiBBU1QuUG9zaXRpb247XG4gIHZhbHVlU3RhcnRMaW5lOiBudW1iZXI7XG4gIHZhbHVlU3RhcnRDb2x1bW46IG51bWJlcjtcbn1cblxuZXhwb3J0IGNsYXNzIFBhcnNlciB7XG4gIHByb3RlY3RlZCBlbGVtZW50U3RhY2s6IEVsZW1lbnRbXSA9IFtdO1xuICBwcml2YXRlIG9wdGlvbnM6IE9iamVjdDtcbiAgcHJpdmF0ZSBzb3VyY2U6IHN0cmluZ1tdO1xuICBwdWJsaWMgY3VycmVudEF0dHJpYnV0ZTogT3B0aW9uPEF0dHJpYnV0ZT4gPSBudWxsO1xuICBwdWJsaWMgY3VycmVudE5vZGU6IE9wdGlvbjxBU1QuQ29tbWVudFN0YXRlbWVudCB8IEFTVC5UZXh0Tm9kZSB8IFRhZzwnU3RhcnRUYWcnIHwgJ0VuZFRhZyc+PiA9IG51bGw7XG4gIHB1YmxpYyB0b2tlbml6ZXIgPSBuZXcgRXZlbnRlZFRva2VuaXplcih0aGlzLCBlbnRpdHlQYXJzZXIpO1xuXG4gIGNvbnN0cnVjdG9yKHNvdXJjZTogc3RyaW5nLCBvcHRpb25zOiBPYmplY3QgPSB7fSkge1xuICAgIHRoaXMub3B0aW9ucyA9IG9wdGlvbnM7XG5cbiAgICB0aGlzLnRva2VuaXplci5zdGF0ZXMudGFnT3BlbiA9IGZ1bmN0aW9uKHRoaXM6IEV2ZW50ZWRUb2tlbml6ZXIpIHtcbiAgICAgIGxldCBjaGFyID0gdGhpcy5jb25zdW1lKCk7XG4gICAgICBpZiAoY2hhciA9PT0gXCIhXCIpIHtcbiAgICAgICAgdGhpc1snc3RhdGUnXSA9ICdtYXJrdXBEZWNsYXJhdGlvbic7XG4gICAgICB9IGVsc2UgaWYgKGNoYXIgPT09IFwiL1wiKSB7XG4gICAgICAgIHRoaXNbJ3N0YXRlJ10gPSAnZW5kVGFnT3Blbic7XG4gICAgICB9IGVsc2UgaWYgKC9bQS1aYS16XS8udGVzdChjaGFyKSkge1xuICAgICAgICB0aGlzWydzdGF0ZSddID0gJ3RhZ05hbWUnO1xuICAgICAgICB0aGlzWydkZWxlZ2F0ZSddLmJlZ2luU3RhcnRUYWcoKTtcbiAgICAgICAgdGhpc1snZGVsZWdhdGUnXS5hcHBlbmRUb1RhZ05hbWUoY2hhcik7XG4gICAgICB9XG4gICAgfTtcblxuICAgIHRoaXMudG9rZW5pemVyLnN0YXRlcy5lbmRUYWdPcGVuID0gZnVuY3Rpb24odGhpczogRXZlbnRlZFRva2VuaXplcikge1xuICAgICAgbGV0IGNoYXIgPSB0aGlzLmNvbnN1bWUoKTtcbiAgICAgIGlmICgvW0EtWmEtel0vLnRlc3QoY2hhcikpIHtcbiAgICAgICAgdGhpc1snc3RhdGUnXSA9ICd0YWdOYW1lJztcbiAgICAgICAgdGhpc1snZGVsZWdhdGUnXS5iZWdpbkVuZFRhZygpO1xuICAgICAgICB0aGlzWydkZWxlZ2F0ZSddLmFwcGVuZFRvVGFnTmFtZShjaGFyKTtcbiAgICAgIH1cbiAgICB9O1xuXG4gICAgdGhpcy5zb3VyY2UgPSBzb3VyY2Uuc3BsaXQoLyg/Olxcclxcbj98XFxuKS9nKTtcbiAgfVxuXG4gIGdldCBjdXJyZW50QXR0cigpOiBBdHRyaWJ1dGUge1xuICAgIHJldHVybiBleHBlY3QodGhpcy5jdXJyZW50QXR0cmlidXRlLCAnZXhwZWN0ZWQgYXR0cmlidXRlJyk7XG4gIH1cblxuICBnZXQgY3VycmVudFRhZygpOiBUYWc8J1N0YXJ0VGFnJyB8ICdFbmRUYWcnPiB7XG4gICAgbGV0IG5vZGUgPSB0aGlzLmN1cnJlbnROb2RlO1xuICAgIGFzc2VydChub2RlICYmIChub2RlLnR5cGUgPT09ICdTdGFydFRhZycgfHwgbm9kZS50eXBlID09PSAnRW5kVGFnJyksICdleHBlY3RlZCB0YWcnKTtcbiAgICByZXR1cm4gbm9kZSBhcyBUYWc8J1N0YXJ0VGFnJyB8ICdFbmRUYWcnPjtcbiAgfVxuXG4gIGdldCBjdXJyZW50U3RhcnRUYWcoKTogVGFnPCdTdGFydFRhZyc+IHtcbiAgICBsZXQgbm9kZSA9IHRoaXMuY3VycmVudE5vZGU7XG4gICAgYXNzZXJ0KG5vZGUgJiYgbm9kZS50eXBlID09PSAnU3RhcnRUYWcnLCAnZXhwZWN0ZWQgc3RhcnQgdGFnJyk7XG4gICAgcmV0dXJuIG5vZGUgYXMgVGFnPCdTdGFydFRhZyc+O1xuICB9XG5cbiAgZ2V0IGN1cnJlbnRFbmRUYWcoKTogVGFnPCdFbmRUYWcnPiB7XG4gICAgbGV0IG5vZGUgPSB0aGlzLmN1cnJlbnROb2RlO1xuICAgIGFzc2VydChub2RlICYmIG5vZGUudHlwZSA9PT0gJ0VuZFRhZycsICdleHBlY3RlZCBlbmQgdGFnJyk7XG4gICAgcmV0dXJuIG5vZGUgYXMgVGFnPCdFbmRUYWcnPjtcbiAgfVxuXG4gIGdldCBjdXJyZW50Q29tbWVudCgpOiBBU1QuQ29tbWVudFN0YXRlbWVudCB7XG4gICAgbGV0IG5vZGUgPSB0aGlzLmN1cnJlbnROb2RlO1xuICAgIGFzc2VydChub2RlICYmIG5vZGUudHlwZSA9PT0gJ0NvbW1lbnRTdGF0ZW1lbnQnLCAnZXhwZWN0ZWQgYSBjb21tZW50Jyk7XG4gICAgcmV0dXJuIG5vZGUgYXMgQVNULkNvbW1lbnRTdGF0ZW1lbnQ7XG4gIH1cblxuICBnZXQgY3VycmVudERhdGEoKTogQVNULlRleHROb2RlIHtcbiAgICBsZXQgbm9kZSA9IHRoaXMuY3VycmVudE5vZGU7XG4gICAgYXNzZXJ0KG5vZGUgJiYgbm9kZS50eXBlID09PSAnVGV4dE5vZGUnLCAnZXhwZWN0ZWQgYSB0ZXh0IG5vZGUnKTtcbiAgICByZXR1cm4gbm9kZSBhcyBBU1QuVGV4dE5vZGU7XG5cbiAgfVxuXG4gIGFjY2VwdE5vZGUobm9kZTogSGFuZGxlYmFyc0FTVC5Qcm9ncmFtKTogUHJvZ3JhbTtcbiAgYWNjZXB0Tm9kZTxVIGV4dGVuZHMgQVNULk5vZGU+KG5vZGU6IEhhbmRsZWJhcnNBU1QuTm9kZSk6IFU7XG4gIGFjY2VwdE5vZGUobm9kZTogSGFuZGxlYmFyc0FTVC5Ob2RlKTogYW55IHtcbiAgICByZXR1cm4gdGhpc1tub2RlLnR5cGVdKG5vZGUpO1xuICB9XG5cbiAgY3VycmVudEVsZW1lbnQoKTogRWxlbWVudCB7XG4gICAgcmV0dXJuIHRoaXMuZWxlbWVudFN0YWNrW3RoaXMuZWxlbWVudFN0YWNrLmxlbmd0aCAtIDFdO1xuICB9XG5cbiAgc291cmNlRm9yTm9kZShub2RlOiBIYW5kbGViYXJzQVNULk5vZGUsIGVuZE5vZGU/OiB7IGxvYzogSGFuZGxlYmFyc0FTVC5Tb3VyY2VMb2NhdGlvbiB9KTogc3RyaW5nIHtcbiAgICBsZXQgZmlyc3RMaW5lID0gbm9kZS5sb2Muc3RhcnQubGluZSAtIDE7XG4gICAgbGV0IGN1cnJlbnRMaW5lID0gZmlyc3RMaW5lIC0gMTtcbiAgICBsZXQgZmlyc3RDb2x1bW4gPSBub2RlLmxvYy5zdGFydC5jb2x1bW47XG4gICAgbGV0IHN0cmluZyA9IFtdO1xuICAgIGxldCBsaW5lO1xuXG4gICAgbGV0IGxhc3RMaW5lOiBudW1iZXI7XG4gICAgbGV0IGxhc3RDb2x1bW46IG51bWJlcjtcblxuICAgIGlmIChlbmROb2RlKSB7XG4gICAgICBsYXN0TGluZSA9IGVuZE5vZGUubG9jLmVuZC5saW5lIC0gMTtcbiAgICAgIGxhc3RDb2x1bW4gPSBlbmROb2RlLmxvYy5lbmQuY29sdW1uO1xuICAgIH0gZWxzZSB7XG4gICAgICBsYXN0TGluZSA9IG5vZGUubG9jLmVuZC5saW5lIC0gMTtcbiAgICAgIGxhc3RDb2x1bW4gPSBub2RlLmxvYy5lbmQuY29sdW1uO1xuICAgIH1cblxuICAgIHdoaWxlIChjdXJyZW50TGluZSA8IGxhc3RMaW5lKSB7XG4gICAgICBjdXJyZW50TGluZSsrO1xuICAgICAgbGluZSA9IHRoaXMuc291cmNlW2N1cnJlbnRMaW5lXTtcblxuICAgICAgaWYgKGN1cnJlbnRMaW5lID09PSBmaXJzdExpbmUpIHtcbiAgICAgICAgaWYgKGZpcnN0TGluZSA9PT0gbGFzdExpbmUpIHtcbiAgICAgICAgICBzdHJpbmcucHVzaChsaW5lLnNsaWNlKGZpcnN0Q29sdW1uLCBsYXN0Q29sdW1uKSk7XG4gICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgc3RyaW5nLnB1c2gobGluZS5zbGljZShmaXJzdENvbHVtbikpO1xuICAgICAgICB9XG4gICAgICB9IGVsc2UgaWYgKGN1cnJlbnRMaW5lID09PSBsYXN0TGluZSkge1xuICAgICAgICBzdHJpbmcucHVzaChsaW5lLnNsaWNlKDAsIGxhc3RDb2x1bW4pKTtcbiAgICAgIH0gZWxzZSB7XG4gICAgICAgIHN0cmluZy5wdXNoKGxpbmUpO1xuICAgICAgfVxuICAgIH1cblxuICAgIHJldHVybiBzdHJpbmcuam9pbignXFxuJyk7XG4gIH1cbn1cbiJdfQ==